<div class="bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200 rounded-lg p-4 my-6">
  <h2 class="text-2xl font-bold text-gray-900 mb-2">Character Entry by Category</h2>
  <p class="text-sm text-gray-600 mb-4">
    Click on a part to add/edit characters for that category. Each link takes you to a focused editing page.
  </p>

  <%
    # Build the grid data: observation_methods with their associated parts
    # Filter to only show characters for this mushroom's fungus_type or universal characters
    @observation_method_parts = ObservationMethod.order(:name).map do |om|
      parts_with_counts = Part.order(:name).map do |part|
        # Count characters that match this observation_method + part combination
        # AND either match the mushroom's fungus_type OR are universal (fungus_type_id IS NULL)
        if @mushroom.fungus_type_id.present?
          count = MrCharacter.where(observation_method: om, part: part)
                            .where('fungus_type_id IS NULL OR fungus_type_id = ?', @mushroom.fungus_type_id)
                            .count
        else
          # If mushroom has no fungus_type, show all characters
          count = MrCharacter.where(observation_method: om, part: part).count
        end
        next unless count > 0
        { part: part, count: count }
      end.compact
      next if parts_with_counts.empty?
      { observation_method: om, parts: parts_with_counts }
    end.compact
  %>

  <div class="space-y-3">
    <% @observation_method_parts.each do |data| %>
      <% om = data[:observation_method] %>
      <% parts = data[:parts] %>

      <div class="bg-white border border-gray-200 rounded-lg p-3 hover:shadow-md transition">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-center">
          <!-- Observation Method Name -->
          <div class="md:col-span-1">
            <h3 class="font-semibold text-gray-800 text-lg"><%= om.name %></h3>
            <% if om.description.present? %>
              <p class="text-xs text-gray-500"><%= truncate(om.description, length: 60) %></p>
            <% end %>
          </div>

          <!-- Parts Links -->
          <div class="md:col-span-3">
            <div class="flex flex-wrap gap-2">
              <% parts.each do |part_data| %>
                <% part = part_data[:part] %>
                <% count = part_data[:count] %>
                <%= link_to edit_characters_mushroom_path(@mushroom, observation_method_id: om.id, part_id: part.id),
                            class: "inline-flex items-center gap-1 px-3 py-1.5 rounded-md bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white text-sm font-medium transition shadow-sm hover:shadow" do %>
                  <span><%= part.name %></span>
                  <span class="bg-white/20 rounded-full px-2 py-0.5 text-xs"><%= count %></span>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <div class="mt-4 pt-3 border-t border-indigo-200">
    <p class="text-xs text-gray-500">
      ðŸ’¡ <strong>Workflow:</strong> Click a part button â†’ Add/edit characters â†’ Automatically return to this grid â†’ Continue with next category
    </p>
    <% if @mushroom.fungus_type_id.present? %>
      <p class="text-xs text-gray-600 mt-2">
        ðŸ“Œ Showing only characters for <strong><%= @mushroom.fungus_type.name %></strong> and universal characters
      </p>
    <% end %>
  </div>
</div>
