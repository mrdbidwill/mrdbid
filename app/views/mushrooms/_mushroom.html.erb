<div id="<%= dom_id mushroom %>" class="w-full my-5">

  <!-- Data + Actions in same vertical plane -->
  <div class="grid grid-cols-1 md:grid-cols-5 gap-2">
    <!-- Left: data spans 4 columns on md+ -->
    <div class="md:col-span-3">
      <dl class="grid grid-cols-1 md:grid-cols-4 gap-2">
        <!-- First row: 4 inline items -->
        <div class="md:col-span-2 border rounded-md p-2">
          <span class="text-sm text-gray-400">Name:</span> <span class="text-lg text-gray-600"><%= mushroom.name %></span>
          <dd class="font-medium"><%= mushroom.state&.name %> , <%= mushroom.country&.name %> <span class="text-sm text-gray-400">Fungus Type:</span> <%= mushroom.fungus_type&.name %></dd>
        </div>

        <!-- Full-width rows -->
        <% if mushroom.description.present? %>
          <div class="md:col-span-2 border rounded-md p-2">
            <dt class="text-sm text-gray-500">Description</dt>
            <dd class="whitespace-pre-wrap"><%= mushroom.description %></dd>
          </div>
        <% end %>

        <% if mushroom.comments.present? %>
          <div class="md:col-span-2 border rounded-md p-2">
            <dt class="text-sm text-gray-500">Comments</dt>
            <dd class="whitespace-pre-wrap"><%= mushroom.comments %></dd>
          </div>
        <% end %>
      </dl>
    </div>

    <!-- Right: actions column. Widen to 2 columns on md+ -->
    <div class="md:col-span-2 min-w-0">
      <!-- Keep single column until large screens to give buttons room -->
      <div class="grid grid-cols-1 md:grid-cols-1 lg:grid-cols-2 gap-2">
      <!-- Group A: Primary actions -->
        <div class="flex flex-col gap-2">
          <% if !defined?(policy) || policy(mushroom)&.mushroom_image_mushroom? %>
            <%= link_to "Upload Image", new_mushroom_image_mushroom_path(mushroom), class: "w-full text-center rounded-md px-3.5 py-1 bg-indigo-600 hover:bg-indigo-500 text-white font-medium" %>
          <% end %>

          <% groups_count   = mushroom.all_group_mushrooms.size %>
          <% clusters_count = mushroom.cluster_mushrooms.size %>
          <% projects_count = mushroom.mushroom_projects.size %>

          <% if !defined?(policy) || policy(mushroom)&.all_group_mushroom? %>
            <%= link_to "Add to Group (#{groups_count})", new_all_group_mushroom_path(mushroom_id: mushroom.id), class: "w-full text-center rounded-md px-3.5 py-1 bg-indigo-600 hover:bg-indigo-500 text-white font-medium" %>
            <details class="mt-1 bg-white border rounded-md p-2">
              <summary class="cursor-pointer text-sm text-gray-700">Show Groups ( <%= groups_count %> assigned)</summary>
              <% if groups_count.positive? %>
                <ul class="mt-2 list-disc ml-5 text-sm text-gray-800">
                  <% mushroom.all_groups.order(:name).limit(20).each do |g| %>
                    <li><%= g.name %></li>
                  <% end %>
                </ul>
                <% if mushroom.all_groups.count > 20 %>
                  <div class="text-xs text-gray-500 mt-1">and more…</div>
                <% end %>
              <% else %>
                <div class="mt-2 text-sm text-gray-500">No groups yet.</div>
              <% end %>
            </details>
          <% end %>

          <% if !defined?(policy) || policy(mushroom)&.mushroom_cluster? %>
            <%= link_to "Add to Cluster (#{clusters_count})", new_cluster_mushroom_path(mushroom_id: mushroom.id), class: "w-full text-center rounded-md px-3.5 py-1 bg-indigo-600 hover:bg-indigo-500 text-white font-medium" %>
            <details class="mt-1 bg-white border rounded-md p-2">
              <summary class="cursor-pointer text-sm text-gray-700">Show Clusters ( <%= clusters_count %>  assigned )</summary>
              <% if clusters_count.positive? %>
                <ul class="mt-2 list-disc ml-5 text-sm text-gray-800">
                  <% mushroom.clusters.order(:name).limit(20).each do |c| %>
                    <li><%= c.name %></li>
                  <% end %>
                </ul>
                <% if mushroom.clusters.count > 20 %>
                  <div class="text-xs text-gray-500 mt-1">and more…</div>
                <% end %>
              <% else %>
                <div class="mt-2 text-sm text-gray-500">No clusters yet.</div>
              <% end %>
            </details>
          <% end %>

          <% if !defined?(policy) || policy(mushroom)&.mushroom_project? %>
            <%= link_to "Add to Project (#{projects_count})", new_mushroom_project_path(mushroom_id: mushroom.id), class: "w-full text-center rounded-md px-3.5 py-1 bg-indigo-600 hover:bg-indigo-500 text-white font-medium" %>
            <details class="mt-1 bg-white border rounded-md p-2">
              <summary class="cursor-pointer text-sm text-gray-700">Show Projects ( <%= projects_count%>  assigned )</summary>
              <% if projects_count.positive? %>
                <ul class="mt-2 list-disc ml-5 text-sm text-gray-800">
                  <% mushroom.projects.order(:name).limit(20).each do |p| %>
                    <li><%= p.name %></li>
                  <% end %>
                </ul>
                <% if mushroom.projects.count > 20 %>
                  <div class="text-xs text-gray-500 mt-1">and more…</div>
                <% end %>
              <% else %>
                <div class="mt-2 text-sm text-gray-500">No projects yet.</div>
              <% end %>
            </details>
          <% end %>
        </div>

        <!-- Group B: CRUD actions -->
        <div class="flex flex-col gap-1 min-w-0">
          <% if (!defined?(policy) || policy(mushroom)&.show?) && !current_page?(mushroom) %>
        <%= link_to "Show", mushroom, class: "w-full text-center rounded-md px-3.5 py-1 bg-indigo-600 hover:bg-indigo-500 text-white font-medium" %>
          <% end %>

          <% if (!defined?(policy) || policy(mushroom)&.edit?) && !current_page?(edit_mushroom_path(mushroom)) %>
        <%= link_to "Edit", edit_mushroom_path(mushroom), class: "w-full text-center rounded-md px-3.5 py-1 bg-indigo-600 hover:bg-indigo-500 text-white font-medium" %>
          <% end %>

          <% if user_signed_in? && (defined?(policy) ? policy(mushroom)&.destroy? : (current_user && mushroom.user == current_user)) %>
            <%= button_to "Delete this mushroom",
                          mushroom,
                          method: :delete,
                          form: { class: "w-full" },
                          class: "block w-full rounded-md px-3.5 py-1 text-white bg-red-600 hover:bg-red-500 font-medium cursor-pointer",
                          data: { turbo_confirm: "Are you sure?" } %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>