<%= form_with(model: mushroom, class: "contents") do |form| %>
  <% if mushroom.errors.any? %>
    <div id="error_explanation" class="bg-red-50 text-red-500 px-2 py-1 font-medium rounded-md mt-3">
      <h2><%= pluralize(mushroom.errors.count, "error") %> prohibited this mushroom from being saved:</h2>
      <ul class="list-disc ml-6">
        <% mushroom.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="w-full">
    <!-- Name -->
    <div class="my-5">
      <%= form.label :name %>  <!-- Name is required for new mushrooms -->
      <%= form.text_field :name, class: ["block shadow-sm rounded-md border px-3 py-1 mt-2 w-full", {"border-gray-400 focus:outline-blue-600": mushroom.errors[:name].none?, "border-red-400 focus:outline-red-600": mushroom.errors[:name].any?}] %>
      <!-- per-field submit -->
      <div class="mt-2">
        <%= button_tag "Update name",
                       type: "submit",
                       name: "commit",
                       value: "update_name",
                       class: "btn-primary" %>
      </div>
    </div>

    <!-- Description -->
    <div class="my-5">
      <%= form.label :description %>
      <%= form.text_area :description, rows: 4, class: ["block shadow-sm rounded-md border px-3 py-1 mt-2 w-full", {"border-gray-400 focus:outline-blue-600": mushroom.errors[:description].none?, "border-red-400 focus:outline-red-600": mushroom.errors[:description].any?}] %>
      <div class="mt-2">
        <%= button_tag "Update description",
                       type: "submit",
                       name: "commit",
                       value: "update_description",
                       class: "btn-primary" %>
      </div>
    </div>

    <!-- Comments -->
    <div class="my-5">
      <%= form.label :comments %>
      <%= form.text_area :comments, rows: 4, class: ["block shadow-sm rounded-md border px-3 py-1 mt-2 w-full", {"border-gray-400 focus:outline-blue-600": mushroom.errors[:comments].none?, "border-red-400 focus:outline-red-600": mushroom.errors[:comments].any?}] %>
      <div class="mt-2">
        <%= button_tag "Update comments",
                       type: "submit",
                       name: "commit",
                       value: "update_comments",
                       class: "btn-primary" %>
      </div>
    </div>

    <!-- Country + State -->
    <div class="my-5" data-controller="country-select"
         data-country-select-url-value="<%= states_path %>">
      <%= form.label :country_id, "Country where specimen was found" %>
      <%= form.collection_select :country_id, Country.all, :id, :name,
                                 { prompt: "Please select country where found" },
                                 { class: "block shadow-sm rounded-md border px-2 py-1 mt-1 w-full",
                                   style: "width: 40%; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);",
                                   data: { action: "change->country-select#change",
                                           "country-select-target": "countrySelect"} } %>

      <div id="state-select-container" class="mt-2">
        <%= form.label :state_id, "State/Province where specimen was found" %>
        <select name="mushroom[state_id]"
                id="mushroom_state_id"
                class="block shadow-sm rounded-md border px-3 py-1 w-full"
                style="width: 40%; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);"
                data-country-select-target="stateSelect"
                <%= mushroom.country_id.present? ? "" : "disabled" %>>
          <% if mushroom.country_id.present? %>
            <% Country.find(mushroom.country_id).states.order(:name).each do |state| %>
              <option value="<%= state.id %>" <%= "selected" if state.id == mushroom.state_id %>><%= state.name %></option>
            <% end %>
          <% else %>
            <option value="">Select a country first</option>
          <% end %>
        </select>
      </div>

      <div class="mt-2 flex gap-2">
        <%= button_tag "Update country/state",
                       type: "submit",
                       name: "commit",
                       value: "update_location",
                       class: "btn-primary" %>
      </div>
    </div>

    <!-- Fungus Type -->
    <div class="my-5">
      <%= form.label :fungus_type_id, "Fungus Type" %>
      <%= form.collection_select :fungus_type_id, FungusType.order(:name), :id, :name,
                                 { prompt: "Select a Fungus Type" },
                                 { class: "block shadow-sm rounded-md border px-3 py-1 mt-2 w-full",
                                   style: "width: 40%; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);" } %>
      <div class="mt-2">
        <%= button_tag "Update fungus type",
                       type: "submit",
                       name: "commit",
                       value: "update_fungus_type",
                       class: "btn-primary" %>
      </div>
    </div>

    <!-- Collection Date -->
    <div class="my-5">
      <%= form.label :collection_date, "Collection Date" %>
      <%= form.date_field :collection_date,
                          class: "block shadow-sm rounded-md border px-3 py-1 mt-2",
                          style: "width: 40%; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);",
                          max: Date.today %>
      <p class="text-xs text-gray-500 mt-1">When was this specimen collected?</p>
      <div class="mt-2">
        <%= button_tag "Update collection date",
                       type: "submit",
                       name: "commit",
                       value: "update_collection_date",
                       class: "btn-primary" %>
      </div>
    </div>


    <!-- Collapsible Candidate Genera/Species Selection -->
    <div class="my-5">
      <button type="button"
              class="bg-gray-100 border rounded px-3 py-1 mb-2 font-medium text-blue-700 hover:bg-blue-100 transition"
              onclick="document.getElementById('candidate-panel').classList.toggle('hidden')">
        <span id="panel-toggle-label">
          <%= mushroom.genera.any? || mushroom.species.any? ? "Edit candidate genera/species" : "Select candidate genera and species (optional)" %>
        </span>
      </button>

      <!-- Summary pills outside panel -->
      <div class="mb-2 flex flex-wrap gap-2 items-center">
        <% if mushroom.genera.any? %>
          <span class="text-xs text-blue-700 font-medium pr-2">Selected Genera:</span>
          <% mushroom.genera.order(:name).each do |g| %>
            <span class="inline-flex items-center bg-blue-200 rounded px-2 py-0.5 text-xs">
              <%= g.name %>
            </span>
          <% end %>
        <% end %>
        <% if mushroom.species.any? %>
          <span class="text-xs text-amber-700 font-medium pl-2 pr-1">Selected Species:</span>
          <% mushroom.species.includes(:genus).order("genera.name, species.name").each do |sp| %>
            <span class="inline-flex items-center bg-yellow-100 rounded px-2 py-0.5 text-xs">
              <%= [sp.genus&.name, sp.name].compact.join(" ") %>
            </span>
          <% end %>
        <% end %>
      </div>

      <div id="candidate-panel" class="hidden border border-blue-200 rounded p-4 bg-blue-50">
        <!-- Step/Process Guidance -->
        <div class="mb-4 px-3 py-2 bg-white border border-blue-300 rounded text-sm text-gray-700">
          <strong>How this works:</strong>
          <p class="text-xs mt-1">The idea here is at the beginning of the identification process, you may not have narrowed down the genus/species candidates. You can add several suspects and narrow them down in your process.</p>
          <ol class="list-decimal pl-5 my-1 text-xs">
            <li>
              <span class="text-blue-700 font-semibold">Step 1:</span> Add one or more
              <span class="bg-blue-200 px-1 rounded">genera</span> as candidates for identification by process-of-elimination. The genus name will appear with a <span class="bg-blue-200 px-1 rounded">blue</span> background.
            </li>
            <li>
              <span class="text-yellow-700 font-semibold">Step 2:</span> After adding genera, select one or more
              <span class="bg-yellow-100 px-1 rounded">species</span> in those genera as candidates. The specie name will appear with a <span class="bg-yellow-100 px-1 rounded">yellow</span> background.
            </li>
            <li>
              You can remove any genus or species at any time by clicking the <span class="font-bold">&times;</span> next to its name.
            </li>
            <li>
              All selections are immediately saved and will be here if you return to editing this mushroom later.
            </li>
          </ol>
        </div>

        <div class="mb-3">
          <span class="block text-sm font-medium text-gray-700 mb-2">
            Candidate Genera & Species
          </span>
          <p class="text-xs text-blue-700 mb-1">
            Add one or more genera you consider candidates (process-of-elimination).
            Then add one or more species for those genera.
            You can revisit this section later and your selections will be saved.
          </p>
        </div>
        <!-- Candidate Genera Inner -->
        <div class="mb-3">
          <span class="block font-semibold text-blue-800 text-xs uppercase mb-0.5 tracking-wide">Step 1: Select Genera</span>
          <label class="block text-xs font-semibold text-gray-700">Add Genera</label>
          <p class="text-xs text-gray-600 mb-1">
            Begin typing at least 3 letters, then select a genus from the dropdown. Each genus you choose will show up as a blue pill below.
            You can select multiple genera as candidates for identification, and remove any of them by clicking Ã—.
          </p>
          <div data-controller="tokens"
               data-tokens-url-value="<%= genera_autocomplete_path(format: :json) %>"
               data-tokens-min-value="3"
               data-tokens-mushroom-id-value="<%= mushroom.id %>"
               data-tokens-kind-value="genera"
               class="border rounded p-2 bg-white">
            <div class="mb-2 flex items-center gap-2">
              <div class="relative w-full">
                <input type="text"
                       placeholder="Type at least 3 letters..."
                       class="w-full border rounded px-2 py-1 min-w-[16rem] md:min-w-[24rem] max-w-xl"
                       data-tokens-target="input"
                       data-action="input->tokens#onInput"
                       minlength="3"
                       autocomplete="off">
                <div data-tokens-target="loader" class="hidden absolute right-2 top-1/2 transform -translate-y-1/2">
                  <svg class="animate-spin h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                </div>
                <ul class="hidden border rounded mt-1 bg-white max-h-52 overflow-auto min-w-[16rem] md:min-w-[24rem] max-w-xl shadow-lg"
                    data-tokens-target="dropdown"
                    style="position: absolute; z-index: 40;"></ul>
              </div>
            </div>
            <div class="flex flex-wrap gap-1" data-tokens-target="list">
              <% mushroom.genera.order(:name).each do |g| %>
                <span class="inline-flex items-center bg-gray-200 rounded px-2 py-0.5 text-sm mr-1 mb-1" data-token-id="<%= g.id %>">
                  <%= g.name %>
                  <button type="button" class="ml-1 text-gray-600 hover:text-red-600" aria-label="Remove" data-action="tokens#removeToken" data-id="<%= g.id %>">&times;</button>
                </span>
              <% end %>
            </div>
            <input type="hidden" data-tokens-target="hiddenIds" value="<%= mushroom.genera.pluck(:id).join(',') %>">
          </div>
        </div>

        <!-- Candidate Species Inner -->
        <div class="mb-3">
          <span class="block font-semibold text-amber-800 text-xs uppercase mb-0.5 tracking-wide">Step 2: Select Species (after adding genera)</span>
          <label class="block text-xs font-semibold text-gray-700">Add Species</label>
          <p class="text-xs text-gray-600 mb-1">
            Type at least 3 letters, then choose a species in one of your selected genera from the dropdown. Each species you add will appear as a yellow pill below.
            You can add and remove species candidates freely while editing this mushroom.
          </p>
          <div data-controller="tokens"
               data-tokens-url-value="<%= species_autocomplete_path %>"
               data-tokens-min-value="3"
               data-tokens-mushroom-id-value="<%= mushroom.id %>"
               data-tokens-kind-value="species"
               class="border rounded p-2 bg-white">
            <div class="mb-2 flex items-center gap-2">
              <div class="relative w-full">
                <input type="text"
                       placeholder="Type species epithet (min 3 letters)..."
                       class="w-full border rounded px-2 py-1 min-w-[16rem] md:min-w-[24rem] max-w-xl"
                       data-tokens-target="input"
                       data-action="input->tokens#onInput"
                       minlength="3"
                       autocomplete="off">
                <div data-tokens-target="loader" class="hidden absolute right-2 top-1/2 transform -translate-y-1/2">
                  <svg class="animate-spin h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                </div>
                <ul class="hidden border rounded mt-1 bg-white max-h-52 overflow-auto min-w-[16rem] md:min-w-[24rem] max-w-xl shadow-lg"
                    data-tokens-target="dropdown"
                    style="position: absolute; z-index: 40;"></ul>
              </div>
            </div>
            <div class="flex flex-wrap gap-1" data-tokens-target="list">
              <% mushroom.species.includes(:genus).order("genera.name, species.name").each do |sp| %>
                <span class="inline-flex items-center bg-gray-200 rounded px-2 py-0.5 text-sm mr-1 mb-1" data-token-id="<%= sp.id %>">
                  <%= [sp.genus&.name, sp.name].compact.join(" ") %>
                  <button type="button" class="ml-1 text-gray-600 hover:text-red-600" aria-label="Remove" data-action="tokens#removeToken" data-id="<%= sp.id %>">&times;</button>
                </span>
              <% end %>
            </div>
            <input type="hidden" data-tokens-target="hiddenIds" value="<%= mushroom.species.pluck(:id).join(',') %>">
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>
