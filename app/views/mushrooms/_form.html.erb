<%= form_with(model: mushroom, class: "contents") do |form| %>
  <% if mushroom.errors.any? %>
    <div id="error_explanation" class="error alert bg-red-50 text-red-500 px-2 py-1 font-medium rounded-md mt-3">
      <h2><%= pluralize(mushroom.errors.count, "error") %> prohibited this mushroom from being saved:</h2>
      <ul class="list-disc ml-6">
        <% mushroom.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="w-full">
    <!-- Name -->
    <div class="my-5">
      <%= form.label :name %>  <!-- Name is required for new mushrooms -->
      <%= form.text_field :name, class: ["block shadow-sm rounded-md border px-3 py-1 mt-2 w-full", {"border-gray-400 focus:outline-blue-600": mushroom.errors[:name].none?, "border-red-400 focus:outline-red-600": mushroom.errors[:name].any?}] %>
      <!-- per-field submit -->
      <div class="mt-2">
        <%= button_tag "Update name",
                       type: "submit",
                       name: "commit",
                       value: "update_name",
                       class: "btn-primary" %>
      </div>
    </div>

    <!-- Description -->
    <div class="my-5">
      <%= form.label :description %>
      <%= form.text_area :description, rows: 4, class: ["block shadow-sm rounded-md border px-3 py-1 mt-2 w-full", {"border-gray-400 focus:outline-blue-600": mushroom.errors[:description].none?, "border-red-400 focus:outline-red-600": mushroom.errors[:description].any?}] %>
      <div class="mt-2">
        <%= button_tag "Update description",
                       type: "submit",
                       name: "commit",
                       value: "update_description",
                       class: "btn-primary" %>
      </div>
    </div>

    <!-- Comments -->
    <div class="my-5">
      <%= form.label :comments %>
      <%= form.text_area :comments, rows: 4, class: ["block shadow-sm rounded-md border px-3 py-1 mt-2 w-full", {"border-gray-400 focus:outline-blue-600": mushroom.errors[:comments].none?, "border-red-400 focus:outline-red-600": mushroom.errors[:comments].any?}] %>
      <div class="mt-2">
        <%= button_tag "Update comments",
                       type: "submit",
                       name: "commit",
                       value: "update_comments",
                       class: "btn-primary" %>
      </div>
    </div>

    <!-- Personal Notes -->
    <div class="my-5">
      <%= form.label :personal_notes, "Personal Notes (private - only visible to you)" %>
      <%= form.text_area :personal_notes, rows: 4, class: ["block shadow-sm rounded-md border px-3 py-1 mt-2 w-full", {"border-gray-400 focus:outline-blue-600": mushroom.errors[:personal_notes].none?, "border-red-400 focus:outline-red-600": mushroom.errors[:personal_notes].any?}] %>
      <p class="text-xs text-gray-500 mt-1">These notes are private and only visible to you.</p>
      <div class="mt-2">
        <%= button_tag "Update personal notes",
                       type: "submit",
                       name: "commit",
                       value: "update_personal_notes",
                       class: "btn-primary" %>
      </div>
    </div>

    <!-- Organization: Clusters, Groups, Projects -->
    <% if mushroom.persisted? %>
      <div id="organization-section" class="my-5 p-4 bg-gray-50 border border-gray-300 rounded">
        <h3 class="text-sm font-semibold text-gray-800 mb-3">üìÅ Organize This Specimen</h3>
        <p class="text-xs text-gray-600 mb-3">Assign this specimen to your clusters, groups, or projects for easier organization.</p>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <!-- Clusters -->
          <div>
            <% user_clusters = current_user.clusters.order(:name) %>
            <% existing_cluster_mushrooms = mushroom.cluster_mushrooms.index_by(&:cluster_id) %>
            <label class="block text-xs font-medium text-gray-700 mb-1">Clusters</label>
            <% if user_clusters.any? %>
              <% user_clusters.each do |cluster| %>
                <% cluster_mushroom = existing_cluster_mushrooms[cluster.id] %>
                <div class="flex items-center mb-1">
                  <% if cluster_mushroom %>
                    <%= button_to "‚úì", cluster_mushroom_path(cluster_mushroom),
                        method: :delete,
                        data: { turbo_confirm: "Remove from #{cluster.name}?" },
                        class: "text-green-600 hover:text-red-600 font-bold mr-2 border-0 bg-transparent p-0 cursor-pointer",
                        form: { style: "display: inline;" } %>
                  <% else %>
                    <%= button_to "+", cluster_mushrooms_path,
                        method: :post,
                        params: { cluster_mushroom: { cluster_id: cluster.id, mushroom_id: mushroom.id } },
                        data: { turbo_confirm: "Add to #{cluster.name}?" },
                        class: "text-gray-400 hover:text-green-600 font-bold mr-2 border-0 bg-transparent p-0 cursor-pointer",
                        form: { style: "display: inline;" } %>
                  <% end %>
                  <span class="text-xs <%= cluster_mushroom ? 'text-green-700 font-medium' : 'text-gray-600' %>">
                    <%= cluster.name %>
                  </span>
                </div>
              <% end %>
              <%= link_to "+ New Cluster", new_cluster_path, class: "text-xs text-blue-600 hover:text-blue-800 underline" %>
            <% else %>
              <p class="text-xs text-gray-500 italic mb-1">No clusters yet</p>
              <%= link_to "Create First Cluster", new_cluster_path, class: "text-xs text-blue-600 hover:text-blue-800 underline" %>
            <% end %>
          </div>

          <!-- Groups -->
          <div>
            <% user_groups = current_user.all_groups.order(:name) %>
            <% existing_group_mushrooms = mushroom.all_group_mushrooms.index_by(&:all_group_id) %>
            <label class="block text-xs font-medium text-gray-700 mb-1">Groups</label>
            <% if user_groups.any? %>
              <% user_groups.each do |group| %>
                <% group_mushroom = existing_group_mushrooms[group.id] %>
                <div class="flex items-center mb-1">
                  <% if group_mushroom %>
                    <%= button_to "‚úì", all_group_mushroom_path(group_mushroom),
                        method: :delete,
                        data: { turbo_confirm: "Remove from #{group.name}?" },
                        class: "text-green-600 hover:text-red-600 font-bold mr-2 border-0 bg-transparent p-0 cursor-pointer",
                        form: { style: "display: inline;" } %>
                  <% else %>
                    <%= button_to "+", all_group_mushrooms_path,
                        method: :post,
                        params: { all_group_mushroom: { all_group_id: group.id, mushroom_id: mushroom.id } },
                        data: { turbo_confirm: "Add to #{group.name}?" },
                        class: "text-gray-400 hover:text-green-600 font-bold mr-2 border-0 bg-transparent p-0 cursor-pointer",
                        form: { style: "display: inline;" } %>
                  <% end %>
                  <span class="text-xs <%= group_mushroom ? 'text-green-700 font-medium' : 'text-gray-600' %>">
                    <%= group.name %>
                  </span>
                </div>
              <% end %>
              <%= link_to "+ New Group", new_all_group_path, class: "text-xs text-blue-600 hover:text-blue-800 underline" %>
            <% else %>
              <p class="text-xs text-gray-500 italic mb-1">No groups yet</p>
              <%= link_to "Create First Group", new_all_group_path, class: "text-xs text-blue-600 hover:text-blue-800 underline" %>
            <% end %>
          </div>

          <!-- Projects -->
          <div>
            <% available_projects = Project.available_to(current_user) %>
            <% existing_mushroom_projects = mushroom.mushroom_projects.index_by(&:project_id) %>
            <label class="block text-xs font-medium text-gray-700 mb-1">Projects</label>
            <% if available_projects.any? %>
              <% available_projects.each do |project| %>
                <% mushroom_project = existing_mushroom_projects[project.id] %>
                <div class="flex items-center mb-1">
                  <% if mushroom_project %>
                    <%= button_to "‚úì", mushroom_project_path(mushroom_project),
                        method: :delete,
                        data: { turbo_confirm: "Remove from #{project.name}?" },
                        class: "text-green-600 hover:text-red-600 font-bold mr-2 border-0 bg-transparent p-0 cursor-pointer",
                        form: { style: "display: inline;" } %>
                  <% else %>
                    <%= button_to "+", mushroom_projects_path,
                        method: :post,
                        params: { mushroom_project: { project_id: project.id, mushroom_id: mushroom.id } },
                        data: { turbo_confirm: "Add to #{project.name}?" },
                        class: "text-gray-400 hover:text-green-600 font-bold mr-2 border-0 bg-transparent p-0 cursor-pointer",
                        form: { style: "display: inline;" } %>
                  <% end %>
                  <span class="text-xs <%= mushroom_project ? 'text-green-700 font-medium' : 'text-gray-600' %>">
                    <%= project.name %><%= " üåç" if project.universal? %>
                  </span>
                </div>
              <% end %>
              <% if current_user&.admin? %>
                <%= link_to "+ New Universal Project", new_admin_project_path, class: "text-xs text-purple-600 hover:text-purple-800 underline font-semibold" %>
              <% end %>
              <%= link_to "+ My Project", new_project_path, class: "text-xs text-blue-600 hover:text-blue-800 underline" %>
            <% else %>
              <p class="text-xs text-gray-500 italic mb-1">No projects available</p>
              <% if current_user&.admin? %>
                <%= link_to "Create Universal Project", new_admin_project_path, class: "text-xs text-purple-600 hover:text-purple-800 underline font-semibold" %>
              <% end %>
              <%= link_to "Create My Project", new_project_path, class: "text-xs text-blue-600 hover:text-blue-800 underline" %>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

    <!-- Country + State -->
    <div class="my-5" data-controller="country-select"
         data-country-select-url-value="<%= states_path %>">
      <%= form.label :country_id, "Country where specimen was found" %>
      <%= form.collection_select :country_id, Country.all, :id, :name,
                                 { prompt: "Please select country where found" },
                                 { class: "block shadow-sm rounded-md border px-2 py-1 mt-1 w-full",
                                   style: "width: 40%; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);",
                                   data: { action: "change->country-select#change",
                                           "country-select-target": "countrySelect"} } %>

      <div id="state-select-container" class="mt-2">
        <%= form.label :state_id, "State/Province where specimen was found" %>
        <select name="mushroom[state_id]"
                id="mushroom_state_id"
                class="block shadow-sm rounded-md border px-3 py-1 w-full"
                style="width: 40%; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);"
                data-country-select-target="stateSelect"
                <%= mushroom.country_id.present? ? "" : "disabled" %>>
          <% if mushroom.country_id.present? %>
            <% Country.find(mushroom.country_id).states.order(:name).each do |state| %>
              <option value="<%= state.id %>" <%= "selected" if state.id == mushroom.state_id %>><%= state.name %></option>
            <% end %>
          <% else %>
            <option value="">Select a country first</option>
          <% end %>
        </select>
      </div>

      <div class="mt-2">
        <%= form.label :city, "City where specimen was found" %>
        <%= form.text_field :city, class: "block shadow-sm rounded-md border px-3 py-1 mt-1 w-full", style: "width: 40%; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);" %>
      </div>

      <div class="mt-2">
        <%= form.label :county, "County where specimen was found" %>
        <%= form.text_field :county, class: "block shadow-sm rounded-md border px-3 py-1 mt-1 w-full", style: "width: 40%; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);" %>
      </div>

      <div class="mt-2 flex gap-2">
        <%= button_tag "Update location",
                       type: "submit",
                       name: "commit",
                       value: "update_location",
                       class: "btn-primary" %>
      </div>
    </div>

    <!-- Fungus Type -->
    <div class="my-5">
      <%= form.label :fungus_type_id, "Fungus Type" %>
      <%= form.collection_select :fungus_type_id, FungusType.order(:name), :id, :name,
                                 { prompt: "Select a Fungus Type" },
                                 { class: "block shadow-sm rounded-md border px-3 py-1 mt-2 w-full",
                                   style: "width: 40%; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);" } %>
      <div class="mt-2">
        <%= button_tag "Update fungus type",
                       type: "submit",
                       name: "commit",
                       value: "update_fungus_type",
                       class: "btn-primary" %>
      </div>
    </div>

    <!-- Collection Date -->
    <div class="my-5">
      <%= form.label :collection_date, "Collection Date" %>
      <%= form.date_field :collection_date,
                          class: "block shadow-sm rounded-md border px-3 py-1 mt-2",
                          style: "width: 40%; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);",
                          max: Date.today %>
      <p class="text-xs text-gray-500 mt-1">When was this specimen collected? (If not today's date, change as needed)</p>
      <div class="mt-2">
        <%= button_tag "Update collection date",
                       type: "submit",
                       name: "commit",
                       value: "update_collection_date",
                       class: "btn-primary" %>
      </div>
    </div>


    <!-- Collapsible Candidate Genera/Species Selection -->
    <div class="my-5">
      <button type="button"
              class="bg-gray-100 border rounded px-3 py-1 mb-2 font-medium text-blue-700 hover:bg-blue-100 transition"
              onclick="document.getElementById('candidate-panel').classList.toggle('hidden')">
        <span id="panel-toggle-label">
          <%= mushroom.genera.any? || mushroom.species.any? ? "Edit candidate genera/species" : "Select potential genera and species" %>
        </span>
      </button>

      <!-- Summary: Show paired genus/species combinations -->
      <div class="mb-2">
        <% identifications = mushroom.ranked_identifications %>
        <% if identifications.any? %>
          <span class="text-sm text-gray-700 font-medium">Selected:</span>
          <div class="mt-1 flex flex-wrap gap-2">
            <% identifications.each_with_index do |id, index| %>
              <span class="inline-flex items-center gap-1 bg-gray-100 border border-gray-300 rounded px-2 py-1 text-sm">
                <span class="font-mono text-gray-600"><%= index + 1 %>.</span>
                <em class="text-gray-800">
                  <%
                    # Display genus: prefer the paired genus, fallback to species.genus, then '?'
                    genus_name = id[:genus]&.name || id[:species]&.genus&.name || '?'
                  %>
                  <%= genus_name.capitalize %> <%= id[:species]&.name || '?' %>
                </em>
                <% if id[:fully_primary] %>
                  <svg class="w-3 h-3 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                  </svg>
                <% end %>
              </span>
            <% end %>
          </div>
        <% else %>
          <span class="text-sm text-gray-500 italic">No identifications selected yet</span>
        <% end %>
      </div>

      <div id="candidate-panel" class="hidden border border-blue-200 rounded p-4 bg-blue-50">
        <!-- Step/Process Guidance -->


        <div class="mb-3">
          <p class="text-xs text-blue-700 mb-1">
            Add one or more genera you consider candidates (process-of-elimination).
            Then add one or more species for those genera.
            You can revisit this section later and your selections will be saved.
          </p>
        </div>
        <!-- Candidate Genera Inner -->
        <div class="mb-3">
          <label class="block text-xs font-semibold text-gray-700">1. Add Genera</label>
          <p class="text-xs text-gray-600 mb-1">
            Begin typing at least 4 letters starting with uppercase (e.g., Agaricus), then select a genus from the dropdown. Each genus you choose will show up as a blue pill below.
            You can select multiple genera as candidates for identification, and remove any of them by clicking √ó.
          </p>
          <div data-controller="mycowriter--autocomplete"
               data-mycowriter--autocomplete-url-value="<%= mycowriter.genera_autocomplete_path %>"
               data-mycowriter--autocomplete-min-value="4"
               data-mycowriter--autocomplete-mushroom-id-value="<%= mushroom.id %>"
               data-mycowriter--autocomplete-kind-value="genera"
               class="border rounded p-2 bg-white">
            <div class="mb-2 flex items-center gap-2">
              <div class="relative w-full">
                <input type="text"
                       placeholder="Type genus name (e.g., Agaricus)..."
                       class="w-full border rounded px-2 py-1 min-w-[16rem] md:min-w-[24rem] max-w-xl"
                       data-mycowriter--autocomplete-target="input"
                       minlength="4"
                       autocomplete="off">
                <div data-mycowriter--autocomplete-target="loader" class="hidden absolute right-2 top-1/2 transform -translate-y-1/2">
                  <svg class="animate-spin h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                </div>
                <ul class="hidden border rounded mt-1 bg-white max-h-52 overflow-auto min-w-[16rem] md:min-w-[24rem] max-w-xl shadow-lg"
                    data-mycowriter--autocomplete-target="dropdown"
                    style="position: absolute; z-index: 40;"></ul>
              </div>
            </div>
            <div class="flex flex-wrap gap-1" data-mycowriter--autocomplete-target="list">
              <% mushroom.genera.order(:name).each do |g| %>
                <span class="inline-flex items-center bg-blue-200 rounded px-2 py-0.5 text-sm mr-1 mb-1" data-token-id="<%= g.id %>">
                  <%= g.name %>
                  <button type="button" class="ml-1 text-red-600 hover:text-red-700 font-bold" aria-label="Remove" data-action="mycowriter--autocomplete#removeToken" data-id="<%= g.id %>">&times;</button>
                </span>
              <% end %>
            </div>
            <input type="hidden" data-mycowriter--autocomplete-target="hiddenIds" value="<%= mushroom.genera.pluck(:id).join(',') %>">
          </div>
        </div>

        <!-- Candidate Species Inner -->
        <div class="mb-3">
          <label class="block text-xs font-semibold text-gray-700">2.Add Species (after adding genera)</label>
          <p class="text-xs text-gray-600 mb-1">
            Type at least 4 letters, then choose a species in one of your selected genera from the dropdown. Each species you add will appear as a yellow pill below.
            You can add and remove species candidates freely while editing this mushroom.
          </p>
          <div data-controller="mycowriter--autocomplete"
               data-mycowriter--autocomplete-url-value="<%= mycowriter.species_autocomplete_path %>"
               data-mycowriter--autocomplete-min-value="4"
               data-mycowriter--autocomplete-mushroom-id-value="<%= mushroom.id %>"
               data-mycowriter--autocomplete-kind-value="species"
               class="border rounded p-2 bg-white">
            <div class="mb-2 flex items-center gap-2">
              <div class="relative w-full">
                <input type="text"
                       placeholder="Type species epithet (min 4 letters)..."
                       class="w-full border rounded px-2 py-1 min-w-[16rem] md:min-w-[24rem] max-w-xl"
                       data-mycowriter--autocomplete-target="input"
                       minlength="4"
                       autocomplete="off">
                <div data-mycowriter--autocomplete-target="loader" class="hidden absolute right-2 top-1/2 transform -translate-y-1/2">
                  <svg class="animate-spin h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                </div>
                <ul class="hidden border rounded mt-1 bg-white max-h-52 overflow-auto min-w-[16rem] md:min-w-[24rem] max-w-xl shadow-lg"
                    data-mycowriter--autocomplete-target="dropdown"
                    style="position: absolute; z-index: 40;"></ul>
              </div>
            </div>
            <div class="flex flex-wrap gap-1" data-mycowriter--autocomplete-target="list">
              <% mushroom.species.includes(:genus).order("genera.name, species.name").each do |sp| %>
                <span class="inline-flex items-center bg-yellow-200 rounded px-2 py-0.5 text-sm mr-1 mb-1" data-token-id="<%= sp.id %>">
                  <%= [sp.genus&.name, sp.name].compact.join(" ") %>
                  <button type="button" class="ml-1 text-red-600 hover:text-red-700 font-bold" aria-label="Remove" data-action="mycowriter--autocomplete#removeToken" data-id="<%= sp.id %>">&times;</button>
                </span>
              <% end %>
            </div>
            <input type="hidden" data-mycowriter--autocomplete-target="hiddenIds" value="<%= mushroom.species.pluck(:id).join(',') %>">
          </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="mt-4 pt-3 border-t border-blue-300 flex gap-2 flex-wrap">
          <button type="button"
                  class="bg-green-600 hover:bg-green-700 text-white font-medium px-4 py-2 rounded shadow transition"
                  onclick="document.getElementById('candidate-panel').classList.add('hidden'); document.getElementById('identification-section').scrollIntoView({behavior: 'smooth', block: 'center'});">
            ‚úì Done - View My Identifications
          </button>
          <button type="button"
                  class="bg-gray-500 hover:bg-gray-600 text-white font-medium px-4 py-2 rounded shadow transition"
                  onclick="document.getElementById('candidate-panel').classList.add('hidden');">
            Close Panel
          </button>
        </div>
      </div>
    </div>

    <!-- Associated Trees & Plants -->
    <div class="my-5">
      <button type="button"
              class="bg-gray-100 border rounded px-3 py-1 mb-2 font-medium text-gray-700 hover:bg-gray-200 transition"
              onclick="document.getElementById('trees-plants-panel').classList.toggle('hidden')">
        <% trees_count = mushroom.trees.size %>
        <% plants_count = mushroom.plants.size %>
        <%= trees_count > 0 || plants_count > 0 ? "Edit associated trees & plants" : "Add associated trees & plants" %>
        <% if trees_count > 0 || plants_count > 0 %>
          <span class="text-xs">(Trees: <%= trees_count %>, Plants: <%= plants_count %>)</span>
        <% end %>
      </button>

      <!-- Summary pills outside panel -->
      <div class="mb-2">
        <% if mushroom.trees.any? %>
          <div class="flex flex-wrap gap-2 items-center mb-2">
            <span class="text-xs text-green-700 font-medium pr-2">Associated Trees:</span>
            <% mushroom.trees.order(:name).each do |t| %>
              <span class="inline-flex items-center bg-green-200 rounded px-2 py-0.5 text-xs">
                <%= t.name %>
              </span>
            <% end %>
          </div>
        <% end %>
        <% if mushroom.plants.any? %>
          <div class="flex flex-wrap gap-2 items-center">
            <span class="text-xs text-purple-700 font-medium pr-2">Associated Plants:</span>
            <% mushroom.plants.order(:name).each do |p| %>
              <span class="inline-flex items-center bg-purple-200 rounded px-2 py-0.5 text-xs">
                <%= p.name %>
              </span>
            <% end %>
          </div>
        <% end %>
      </div>

      <div id="trees-plants-panel" class="hidden border border-gray-200 rounded p-4 bg-gray-50">
        <div class="space-y-4">
          <!-- Trees Section -->
          <div class="border-l-4 border-green-500 pl-3 bg-white p-3 rounded">
            <div class="mb-2">
              <span class="block text-sm font-medium text-gray-700 mb-1">Associated Trees</span>
              <p class="text-xs text-green-700">
                Add trees that are associated with this mushroom (e.g., mycorrhizal partners or host trees).
              </p>
            </div>
            <div class="mb-2">
              <label class="block text-xs font-semibold text-gray-700">Add Trees</label>
              <p class="text-xs text-gray-600 mb-1">
                Begin typing at least 3 letters, then select a tree from the dropdown.
              </p>
              <div data-controller="tokens"
                   data-tokens-url-value="<%= trees_autocomplete_path(format: :json) %>"
                   data-tokens-min-value="3"
                   data-tokens-mushroom-id-value="<%= mushroom.id %>"
                   data-tokens-kind-value="trees"
                   class="border rounded p-2 bg-white">
                <div class="mb-2 flex items-center gap-2">
                  <div class="relative w-full">
                    <input type="text"
                           placeholder="Type at least 3 letters..."
                           class="w-full border rounded px-2 py-1"
                           data-tokens-target="input"
                           data-action="input->tokens#onInput"
                           minlength="3"
                           autocomplete="off">
                    <div data-tokens-target="loader" class="hidden absolute right-2 top-1/2 transform -translate-y-1/2">
                      <svg class="animate-spin h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                    </div>
                    <ul class="hidden border rounded mt-1 bg-white max-h-52 overflow-auto shadow-lg"
                        data-tokens-target="dropdown"
                        style="position: absolute; z-index: 40;"></ul>
                  </div>
                </div>
                <div class="flex flex-wrap gap-1" data-tokens-target="list">
                  <% mushroom.trees.order(:name).each do |t| %>
                    <span class="inline-flex items-center bg-gray-200 rounded px-2 py-0.5 text-sm mr-1 mb-1">
                      <%= t.name %>
                      <%= link_to "√ó",
                                  destroy_by_relation_mushroom_trees_path(mushroom_id: mushroom.id, tree_id: t.id),
                                  data: { turbo_method: :delete, turbo_confirm: "Remove #{t.name}?" },
                                  class: "ml-1 text-gray-600 hover:text-red-600" %>
                    </span>
                  <% end %>
                </div>
                <input type="hidden" data-tokens-target="hiddenIds" value="<%= mushroom.trees.pluck(:id).join(',') %>">
              </div>
            </div>
          </div>

          <!-- Plants Section -->
          <div class="border-l-4 border-purple-500 pl-3 bg-white p-3 rounded">
            <div class="mb-2">
              <span class="block text-sm font-medium text-gray-700 mb-1">Associated Plants</span>
              <p class="text-xs text-purple-700">
                Add plants that are associated with this mushroom (e.g., growing on or near specific plants).
              </p>
            </div>
            <div class="mb-2">
              <label class="block text-xs font-semibold text-gray-700">Add Plants</label>
              <p class="text-xs text-gray-600 mb-1">
                Begin typing at least 3 letters, then select a plant from the dropdown.
              </p>
              <div data-controller="tokens"
                   data-tokens-url-value="<%= plants_autocomplete_path(format: :json) %>"
                   data-tokens-min-value="3"
                   data-tokens-mushroom-id-value="<%= mushroom.id %>"
                   data-tokens-kind-value="plants"
                   class="border rounded p-2 bg-white">
                <div class="mb-2 flex items-center gap-2">
                  <div class="relative w-full">
                    <input type="text"
                           placeholder="Type at least 3 letters..."
                           class="w-full border rounded px-2 py-1"
                           data-tokens-target="input"
                           data-action="input->tokens#onInput"
                           minlength="3"
                           autocomplete="off">
                    <div data-tokens-target="loader" class="hidden absolute right-2 top-1/2 transform -translate-y-1/2">
                      <svg class="animate-spin h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                    </div>
                    <ul class="hidden border rounded mt-1 bg-white max-h-52 overflow-auto shadow-lg"
                        data-tokens-target="dropdown"
                        style="position: absolute; z-index: 40;"></ul>
                  </div>
                </div>
                <div class="flex flex-wrap gap-1" data-tokens-target="list">
                  <% mushroom.plants.order(:name).each do |p| %>
                    <span class="inline-flex items-center bg-gray-200 rounded px-2 py-0.5 text-sm mr-1 mb-1">
                      <%= p.name %>
                      <%= link_to "√ó",
                                  destroy_by_relation_mushroom_plants_path(mushroom_id: mushroom.id, plant_id: p.id),
                                  data: { turbo_method: :delete, turbo_confirm: "Remove #{p.name}?" },
                                  class: "ml-1 text-gray-600 hover:text-red-600" %>
                    </span>
                  <% end %>
                </div>
                <input type="hidden" data-tokens-target="hiddenIds" value="<%= mushroom.plants.pluck(:id).join(',') %>">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>
