<% content_for :title, "Mushrooms" %>
<div class="w-full">

  <%= render "shared/page_actions" do %>
    <% content_for :left do %>
      <h1 class="title-xl">Your Mushrooms</h1>
    <% end %>
    <% content_for :right do %>
      <% if current_user&.admin? %>
        <%= link_to "Back to Admin Dashboard", admin_root_path, class: "btn-primary" %>
      <% end %>
      <%= link_to "Add New Mushroom", new_mushroom_path, class: "btn-primary" %>
    <% end %>
  <% end %>

  <%= render "shared/pagination", collection: @mushrooms %>

  <div class="page-actions">
    <p class="font-bold text-sm text-red-600">Click on a mushroom to view details.</p>
  </div>

  <div id="mushrooms" class="stack-list">
  <% if @mushrooms&.any? %>
    <% grouped = @mushrooms.group_by { |m| m.fungus_type&.name.to_s.presence || "Uncategorized" } %>
    <% grouped.keys.sort.each do |ft_name| %>
      <%= render "shared/data_group", title: "Mushroom Type: #{ft_name}" do %>
        <% grouped[ft_name].sort_by { |m| m.name.to_s.downcase }.each do |mushroom| %>
          <%= render "shared/card", href: mushroom_path(mushroom) do %>
            <% images = mushroom.image_mushrooms.select { |im| im.image_file.attached? } %>
            <%= render "shared/image_grid", images: images, image_size: [120,120], alt_fallback: (mushroom.name.presence || "Mushroom") %>

            <div class="well">
              <% country_name = mushroom.country&.name %>
              <% state_name = mushroom.state&.name %>
              <% location = [state_name, country_name].compact.join(", ") %>
              <% description = truncate(mushroom.description.to_s, length: 100) %>
              <% comments = truncate(mushroom.comments.to_s, length: 100) %>
              <p class="text-sm text-gray-800">
                <span class="font-semibold"><%= mushroom.name.presence || "Unnamed" %></span>
                <% if location.present? %><span class="muted"> <%= location %></span><% end %>
                <% if description.present? %><span class="text-gray-700"> <%= description %></span><% end %>
                <% if comments.present? %><span class="hint"> <%= comments %></span><% end %>
              </p>
            </div>
          <% end %>
        <% end %>
      <% end %>
    <% end %>
  <% else %>
    <p class="text-center my-4">No mushrooms found.</p>
  <% end %>
  </div>

  <%= render "shared/pagination", collection: @mushrooms %>

  <%= render "shared/page_actions" do %>
    <% content_for :right do %>
      <% if current_user&.admin? %>
        <%= link_to "Back to Admin Dashboard", admin_root_path, class: "btn-primary" %>
      <% end %>
      <%= link_to "Add New Mushroom", new_mushroom_path, class: "btn-primary" %>
    <% end %>
  <% end %>

</div>