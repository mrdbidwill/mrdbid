<% content_for :title, "Mushrooms" %>
<div class="w-full">
  <% if notice.present? %>
    <p class="py-2 px-3 bg-green-50 mb-2 text-green-500 font-medium rounded-md inline-block" id="notice"><%= notice %></p>
  <% end %>

  <div class="flex justify-between items-center">
    <h1 class="font-bold text-2xl">Your Mushrooms</h1>
    <% if current_user&.admin? %>
    <%= link_to "Back to Admin Dashboard", admin_root_path, class: "rounded-md px-3.5 py-1 bg-blue-600 hover:bg-blue-500 text-white block font-medium" %>
    <% end %>
    <%= link_to "Add New Mushroom", new_mushroom_path, class: "rounded-md px-3.5 py-1 bg-blue-600 hover:bg-blue-500 text-white block font-medium" %>

  </div>

  <!-- Top Pagination -->
  <% if @mushrooms&.any? %>
    <div class="my-4">
      <%= paginate @mushrooms,
                   theme: 'tailwind_bar',
                   params: request.query_parameters,
                   window: 2,        # how many pages around current
                   outer_window: 1   # how many pages at the ends
      %>
    </div>
  <% end %>

  <div class="flex justify-between items-center"> <p class="font-bold text-sm text-red-600">Click on a mushroom to view details.</p></div>

  <div id="mushrooms" class="min-w-full divide-y divide-gray-400 space-y-2">
  <% if @mushrooms&.any? %>
      <% grouped = @mushrooms.group_by { |m| m.fungus_type&.name.to_s.presence || "Uncategorized" } %>
      <% grouped.keys.sort.each do |ft_name| %>
        <div class="pt-1 border border-red-600">
          <h2 class="text-lg font-semibold text-gray-700 mb-2">Mushroom Type: <%= ft_name %></h2>

          <% grouped[ft_name].sort_by { |m| m.name.to_s.downcase }.each do |mushroom| %>
            <%= link_to mushroom_path(mushroom), class: "block rounded-lg border border-gray-200 hover:border-blue-300 hover:shadow-sm transition" do %>
              <div class="p-1 flex flex-col gap-1">
                <% images = mushroom.image_mushrooms.select { |im| im.image_file.attached? } %>
                <% if images.any? %>
                  <div class="w-full">
                    <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2">
                      <% images.each do |image_mushroom| %>
                        <div class="border rounded-md overflow-hidden bg-gray-50 aspect-square">
                          <%# Use WebP with JPEG fallback, strip metadata, and lower quality %>
                          <picture>
                            <%= tag.source(
                                  srcset: url_for(
                                    image_mushroom.image_file.variant(
                                      resize_to_fill: [120, 120],
                                      format: :webp,
                                      saver: { strip: true, quality: 60, effort: 4 } # try 50–65 for tiny files
                                    ).processed
                                  ),
                                  type: "image/webp"
                                ) %>
                            <%= image_tag(
                                  image_mushroom.image_file.variant(
                                    resize_to_fill: [120, 120],
                                    saver: { strip: true, quality: 72, optimize_coding: true } # try 65–75 for clarity vs. size
                                  ).processed,
                                  width: 120,
                                  height: 120,
                                  class: "w-full h-full object-cover block",
                                  loading: "lazy",
                                  decoding: "async",
                                  fetchpriority: "low",
                                  alt: image_mushroom.image_name.presence || mushroom.name
                                ) %>
                          </picture>
                        </div>
                      <% end %>
                    </div>
                  </div>
                <% else %>
                  <p class="text-sm text-gray-500">No images for this mushroom.</p>
                <% end %>

                <div class="rounded-md bg-white">
                  <div class="p-1 rounded-md bg-gray-50">
                    <% country_name = mushroom.country&.name %>
                    <% state_name = mushroom.state&.name %>
                    <% location = [state_name, country_name].compact.join(", ") %>
                    <% description = truncate(mushroom.description.to_s, length: 100) %>
                    <% comments = truncate(mushroom.comments.to_s, length: 100) %>
                    <p class="text-sm text-gray-800">
                      <span class="font-semibold"><%= mushroom.name.presence || "Unnamed" %></span>
                      <% if location.present? %>
                        <span class="text-gray-600"> <%= location %></span>
                      <% end %>
                      <% if description.present? %>
                        <span class="text-gray-700"> <%= description %></span>
                      <% end %>
                      <% if comments.present? %>
                        <span class="text-gray-500"> <%= comments %></span>
                      <% end %>
                    </p>
                  </div>
                </div>
              </div>
            <% end %>
          <% end %>
        </div>
      <% end %>
    <% else %>
      <p class="text-center my-4">No mushrooms found.</p>
    <% end %>
  </div>
  <!-- Top Pagination -->
  <% if @mushrooms&.any? %>
    <div class="my-2">
      <%= paginate @mushrooms,
                   theme: 'tailwind_bar',
                   params: request.query_parameters,
                   window: 2,        # how many pages around current
                   outer_window: 1   # how many pages at the ends
      %>
    </div>
  <% end %>

  <div class="flex justify-between items-center">
    <% if current_user&.admin? %>
    <%= link_to "Back to Admin Dashboard", admin_root_path, class: "rounded-md px-3.5 py-1 bg-blue-600 hover:bg-blue-500 text-white block font-medium" %>
      <% end %>
  <%= link_to "Add New Mushroom", new_mushroom_path, class: "rounded-md px-3.5 py-1 bg-blue-600 hover:bg-blue-500 text-white block font-medium" %>
  </div>

</div>