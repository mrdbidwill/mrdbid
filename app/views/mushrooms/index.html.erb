<% content_for :title, "Mushrooms" %>
<div class="w-full">
  <%= render "shared/page_actions", 
        left: content_tag(:h1, "Your Mushrooms", class: "title-xl"),
        right: (
          (current_user&.admin? ? link_to("Back to Admin Dashboard", admin_root_path, class: "btn-primary") : "") +
          link_to("Add New Mushroom", new_mushroom_path, class: "btn-primary")
        ).html_safe
  %>
  <%= render "shared/pagination", collection: @mushrooms %>

  <div class="page-actions">
    <p class="p-title-red">Click on a mushroom to view details.</p>  <!-- Displays before the list of mushrooms -->
  </div>

  <div id="mushrooms" class="stack-list">
  <% if @mushrooms&.any? %>
    <% grouped = @mushrooms.group_by { |m| m.fungus_type&.name.to_s.presence || "Uncategorized" } %>
    <% grouped.keys.sort.each do |ft_name| %>
      <%= render "shared/data_group", title: "Mushroom Type: #{ft_name}" do %>   <!-- Displays inside list border - outside list of mushroom -->
        <% grouped[ft_name].each do |mushroom| %>
          <%= render "shared/card", href: mushroom_path(mushroom) do %>
            <% images = mushroom.image_mushrooms.select { |im| im.image_file.attached? } %>
            <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2">
              <% images.each do |im| %>
                <%= render "shared/image_card", image_mushroom: im, mushroom_name: (mushroom.name.presence || "Mushroom") %>
              <% end %>
            </div>

            <div class="well">
              <% country_name = mushroom.country&.name %>
              <% state_name = mushroom.state&.name %>
              <% location = [state_name, country_name].compact.join(", ") %>
              <% description = truncate(mushroom.description.to_s, length: 100) %>
              <% comments = truncate(mushroom.comments.to_s, length: 100) %>
              <p class="text-sm text-gray-800">
                <% if mushroom.genera.any? && mushroom.species.any? %>
                  <em class="text-gray-600"><%= mushroom.genera.first.name.capitalize %> <%= mushroom.species.first.name %></em>
                  <br>
                <% end %>
                <span class="font-semibold"><%= mushroom.name.presence || "Unnamed" %></span>
                <% if location.present? %><span class="muted"> <%= location %></span><% end %>
                <% if description.present? %><span class="text-gray-700"> <%= description %></span><% end %>
                <% if comments.present? %><span class="hint"> <%= comments %></span><% end %>
              </p>
            </div>
          <% end %>
        <% end %>
      <% end %>
    <% end %>
  <% else %>
    <p class="text-center my-4">No mushrooms found.</p>
  <% end %>
  </div>

  <%= render "shared/pagination", collection: @mushrooms %>

  <%= render "shared/page_actions",
        right: (
          (current_user&.admin? ? link_to("Back to Admin Dashboard", admin_root_path, class: "btn-primary") : "") +
          link_to("Add New Mushroom", new_mushroom_path, class: "btn-primary")
        ).html_safe
  %>

</div>