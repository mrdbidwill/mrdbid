<%#
  Compact card for displaying an already-entered character
  Shows: character name, part, current value as badge
  Has: Edit button that toggles inline form
  locals: character_mushroom (MrCharacterMushroom instance)
%>

<% character = character_mushroom.mr_character %>
<% current_value = character_mushroom.character_value %>
<% do_not_display = (character&.display_option&.name&.downcase == "do not display") || character&.display_option_id == 1 %>

<div class="border border-gray-200 rounded-lg p-3 bg-white hover:shadow-md transition"
     data-character-id="<%= character.id %>">

  <!-- Compact View (Default) -->
  <div class="compact-view">
    <div class="flex items-start justify-between gap-2 mb-2">
      <div class="flex-1 min-w-0">
        <h4 class="text-sm font-semibold text-gray-800 break-words">
          <%= character.name.to_s.tr("_", " ") %>
          <%# INLINE ADMIN EDIT LINK: Gear icon for editing character definition
              Only visible to admin users (permission_id < 5)
              Clicking takes admin to character edit page with return_to param
              After save, admin returns here to continue mushroom editing
              Uses respond_to? check for defensive coding (avoids errors in test environment) %>
          <% if respond_to?(:admin_user?) && admin_user? %>
            <%= link_to edit_admin_mr_character_path(character, return_to: request.fullpath),
                        class: "inline-block ml-1 text-blue-600 hover:text-blue-800 opacity-70 hover:opacity-100 transition",
                        title: "Edit character definition (Admin)" do %>
              <span class="text-xs">⚙️</span>
            <% end %>
          <% end %>
        </h4>
        <p class="text-xs text-gray-500 mt-0.5">
          <%= character.part&.name || "Unknown part" %>
        </p>
      </div>

      <!-- Edit Button -->
      <% unless do_not_display %>
        <button type="button"
                onclick="toggleCharacterEdit(this)"
                class="flex-shrink-0 text-xs px-2 py-1 rounded bg-blue-100 hover:bg-blue-200 text-blue-700 font-medium transition">
          Edit ✏️
        </button>
      <% end %>
    </div>

    <!-- Current Value Badge -->
    <div class="mt-2">
      <% if do_not_display %>
        <span class="inline-block px-2 py-1 rounded bg-gray-100 text-gray-600 text-xs font-medium">
          Hidden
        </span>
      <% else %>
        <%
          # Get display value and determine badge color
          display_option_name = character.display_option&.name&.downcase
          is_color = display_option_name == "color" || character.display_option_id == 6

          # For color, show the color swatches
          if is_color
            colors = character_mushroom.ordered_colors
          # For radio/dropdown, look up the LookupItem name
          elsif display_option_name == "radio" || display_option_name == "drop-down"
            lookup_item = LookupItem.find_by(id: current_value)
            display_value = lookup_item&.name || current_value
          else
            display_value = current_value
          end

          # Determine badge color based on value type (for non-color)
          unless is_color
            badge_class = case display_option_name
            when "boolean_yes_no", "boolean_true_false", "boolean_present_absent", "checkbox"
              if current_value.to_s.downcase == "true" || current_value.to_s.downcase == "yes" || current_value.to_s.downcase == "present"
                "bg-green-100 text-green-800"
              else
                "bg-gray-100 text-gray-600"
              end
            when "radio", "drop-down"
              "bg-blue-100 text-blue-800"
            when "text_box_number_mm", "text_box_number_um", "text_box_number"
              "bg-purple-100 text-purple-800"
            else
              "bg-teal-100 text-teal-800"
            end
          end
        %>

        <% if is_color %>
          <!-- Color swatches display (multicolor support) -->
          <div class="flex items-center gap-2 flex-wrap">
            <% colors.each_with_index do |color, index| %>
              <div class="flex items-center gap-1">
                <% if color.is_simplified? %>
                  <div class="w-8 h-8 rounded border-2 flex-shrink-0 <%= index == 0 ? 'border-blue-500' : 'border-gray-300' %>"
                       style="background-color: <%= color.hex %>"></div>
                <% else %>
                  <%= image_tag "AMS_colors/banner_50x50/banner_#{color.id}.jpg",
                                alt: color.latin_name,
                                class: "w-8 h-8 rounded border-2 flex-shrink-0 #{index == 0 ? 'border-blue-500' : 'border-gray-300'}" %>
                <% end %>
                <span class="text-xs text-gray-700">
                  <% if index == 0 %>
                    <span class="font-semibold"><%= color.common_name %></span>
                  <% else %>
                    <%= color.common_name %>
                  <% end %>
                </span>
              </div>
            <% end %>
          </div>
        <% else %>
          <!-- Regular badge for non-color -->
          <span class="inline-flex items-center gap-1 px-2 py-1 rounded <%= badge_class %> text-xs font-medium">
            <span class="font-bold">●</span>
            <span><%= truncate(display_value, length: 50) %></span>
          </span>
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- Edit Form (Hidden by default) -->
  <% unless do_not_display %>
    <% is_color = (character.display_option&.name&.downcase == "color") || character.display_option_id == 6 %>

    <div class="edit-form hidden mt-3 pt-3 border-t border-gray-200">
      <% if is_color %>
        <%# Use color picker modal for color characters %>
        <%= render "shared/color_picker_modal",
                   character: character,
                   mushroom_id: character_mushroom.mushroom_id,
                   redirect_path: nil %>

        <div class="flex items-center gap-2 mt-2">
          <button type="button"
                  onclick="toggleCharacterEdit(this)"
                  class="rounded px-3 py-1.5 text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium transition">
            Cancel
          </button>
        </div>
      <% else %>
        <%# Regular form for non-color characters %>
        <%= form_with url: mr_character_mushrooms_path, method: :post, data: { turbo: true }, html: { class: "space-y-3" } do |f| %>
          <%= hidden_field_tag :mushroom_id, character_mushroom.mushroom_id %>
          <%= hidden_field_tag :mr_character_id, character.id %>

          <div>
            <%= render partial: "mushrooms/character_input", locals: { f: f, character: character, current_value: current_value } %>
          </div>

          <div class="flex items-center gap-2">
            <%= f.submit "Update", class: "rounded px-3 py-1.5 text-sm bg-green-600 hover:bg-green-700 text-white font-medium transition" %>
            <button type="button"
                    onclick="toggleCharacterEdit(this)"
                    class="rounded px-3 py-1.5 text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium transition">
              Cancel
            </button>
          </div>
        <% end %>
      <% end %>
    </div>
  <% end %>
</div>
