<% content_for :title, "Showing mushroom" %>
<div class="md:w-full w-full">

  <h1 class="font-bold text-2xl">Showing mushroom:</h1>

  <div class="flex flex-col pt-1 gap-2">
    <% if current_user&.admin? %>
      <%= link_to "Back to Admin Dashboard", admin_root_path, class: "rounded-md px-2 py-1 bg-blue-600 hover:bg-blue-500 text-white block font-medium" %>
    <% end %>
    <%= link_to "Back to mushrooms", mushrooms_path, class: "w-full text-center rounded-md px-2 py-1 bg-indigo-600 hover:bg-indigo-500 text-white font-medium" %>
  </div>

  <%= render @mushroom %>

  <% images = @mushroom.image_mushrooms.select { |im| im.image_file.attached? } %>
  <% if images.any? %>
    <div class="w-full">
      <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2">
        <% images.each do |image_mushroom| %>
          <div class="border rounded-md overflow-hidden bg-gray-50 aspect-square">
            <%# Use WebP with JPEG fallback, strip metadata, and lower quality %>
            <picture>
              <%= tag.source(
                    srcset: url_for(
                      image_mushroom.image_file.variant(
                        resize_to_fill: [120, 120],
                        format: :webp,
                        saver: { strip: true, quality: 60, effort: 4 } # try 50–65 for tiny files
                      ).processed
                    ),
                    type: "image/webp"
                  ) %>
              <%= image_tag(
                    image_mushroom.image_file.variant(
                      resize_to_fill: [120, 120],
                      saver: { strip: true, quality: 72, optimize_coding: true } # try 65–75 for clarity vs. size
                    ).processed,
                    width: 120,
                    height: 120,
                    class: "w-full h-full object-cover block",
                    loading: "lazy",
                    decoding: "async",
                    fetchpriority: "low",
                    alt: image_mushroom.image_name.presence || @mushroom.name
                  ) %>
            </picture>
          </div>
        <% end %>
      </div>
    </div>
  <% else %>
    <p class="text-sm text-gray-500">No images for this mushroom.</p>
  <% end %>

  <!-- Associated Trees -->
  <% if @mushroom.trees.any? %>
    <div class="mt-6">
      <details class="bg-white border rounded-md p-4" open>
        <summary class="font-semibold cursor-pointer text-green-700">Associated Trees (<%= @mushroom.trees.count %>)</summary>
        <div class="mt-3 flex flex-wrap gap-2">
          <% @mushroom.trees.order(:name).each do |tree| %>
            <span class="inline-flex items-center bg-green-100 border border-green-300 rounded px-3 py-1 text-sm">
              <%= tree.name %>
            </span>
          <% end %>
        </div>
      </details>
    </div>
  <% end %>

  <!-- Associated Plants -->
  <% if @mushroom.plants.any? %>
    <div class="mt-4">
      <details class="bg-white border rounded-md p-4" open>
        <summary class="font-semibold cursor-pointer text-purple-700">Associated Plants (<%= @mushroom.plants.count %>)</summary>
        <div class="mt-3 flex flex-wrap gap-2">
          <% @mushroom.plants.order(:name).each do |plant| %>
            <span class="inline-flex items-center bg-purple-100 border border-purple-300 rounded px-3 py-1 text-sm">
              <%= plant.name %>
            </span>
          <% end %>
        </div>
      </details>
    </div>
  <% end %>

  <!-- Characters, grouped by part -->
  <% character_rows = @mushroom.mr_character_mushrooms.includes(mr_character: [:part, :display_option]).order('parts.name ASC, mr_characters.name ASC') %>
  <% grouped = character_rows.group_by { |rc| rc.mr_character&.part&.name || "Other" } %>
  <div class="mt-6 space-y-1">
    <% grouped.each do |part_name, rows| %>
      <details class="bg-white border rounded-md p-4" open>
        <summary class="font-semibold cursor-pointer"><%= part_name %> (<%= rows.size %>)</summary>
        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <% rows.each do |rc| %>
            <% c = rc.mr_character %>
            <div class="flex items-center justify-between border rounded p-1">
              <div>
                <div class="text-sm text-gray-500"><%= c&.name %></div>
                <div class="font-medium">
                  <% display_opt_name = c&.display_option&.name %>
                  <% case display_opt_name %>
                  <% when "color" %>
                    <% color = Color.find_by(id: rc.character_value.to_i) %>
                    <% if color %>
                      <span class="inline-flex items-center">
                        <%= image_tag "AMS_colors/banner_50x50/banner_#{color.id}.jpg", alt: color.latin_name, class: "w-6 h-6 mr-1 rounded border" %>
                        <span><%= color.latin_name %> (<%= color.common_name %>)</span>
                      </span>
                    <% else %>
                      <%= rc.character_value %>
                    <% end %>
                  <% when "radio", "drop-down" %>
                    <% lookup_item = LookupItem.find_by(id: rc.character_value.to_i) %>
                    <%= lookup_item&.name || rc.character_value %>
                  <% when "boolean_yes_no" %>
                    <%= rc.character_value.to_s.downcase == "true" ? "Yes" : "No" %>
                  <% when "boolean_true_false" %>
                    <%= rc.character_value.to_s.downcase == "true" ? "True" : "False" %>
                  <% when "boolean_present_absent" %>
                    <%= rc.character_value.to_s.downcase == "true" ? "Present" : "Absent" %>
                  <% when "checkbox" %>
                    <%= rc.character_value.to_s.downcase == "true" ? "✓ Yes" : "✗ No" %>
                  <% else %>
                    <%= rc.character_value %>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </details>
    <% end %>
  </div>

  <div class="flex flex-col pt-1 gap-2">
    <% if current_user&.admin? %>
      <%= link_to "Back to Admin Dashboard", admin_root_path, class: "rounded-md px-2 py-1 bg-blue-600 hover:bg-blue-500 text-white block font-medium" %>
    <% end %>
    <%= link_to "Back to mushrooms", mushrooms_path, class: "w-full text-center rounded-md px-2 py-1 bg-indigo-600 hover:bg-indigo-500 text-white font-medium" %>
  </div>
    </div>
