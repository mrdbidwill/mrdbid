<% content_for :title, "Editing mushroom" %>
<p> app/views/mushrooms/edit.html.erb> </p>
<div class="md:w-2/3 w-full">
  <h1 class="font-bold text-4xl">Editing mushroom</h1>

  <%= render "form", mushroom: @mushroom %>

  <!-- Entered characters -->
  <% existing_rows = @mushroom.mr_character_mushrooms.includes(mr_character: [:part, :display_option]).order('parts.name ASC, mr_characters.name ASC') %>
  <% existing_grouped = existing_rows.group_by { |rc| rc.mr_character&.part&.name || "Other" } %>

  <div class="mt-8">
    <h2 class="text-2xl font-semibold mb-3">Entered characters</h2>
    <% if existing_rows.any? %>
      <% existing_grouped.each do |part_name, rows| %>
        <details class="bg-white border rounded-md p-4 mb-3" open>
          <summary class="font-semibold cursor-pointer"><%= part_name %> (<%= rows.size %>)</summary>
          <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
            <% rows.each do |rc| %>
              <% c = rc.mr_character %>
              <% next if (c.display_option&.name&.downcase == "color") || c.display_option_id == 6 %>
              <div class="flex items-start justify-between border rounded p-3 gap-3">
                <div class="min-w-0">
                  <div class="text-sm text-gray-500 break-words"><%= c&.name.to_s.tr("_", " ") %></div>
                  <div class="font-medium">
                    <%= rc.character_value %>
                  </div>
                </div>
                <div class="shrink-0">
                  <%= form_with url: mr_character_mushrooms_path, method: :post, data: { turbo: true }, html: { class: "flex items-center gap-2" } do |f| %>
                    <%= hidden_field_tag :mushroom_id, @mushroom.id %>
                    <%= hidden_field_tag :mr_character_id, c.id %>
                    <%= render partial: "character_input", locals: { f: f, character: c, current_value: rc.character_value } %>
                    <%= f.submit "Update", class: "ml-2 rounded px-3 py-1.5 text-sm bg-blue-600 text-white" %>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </details>
      <% end %>
    <% else %>
      <p class="text-gray-500">No characters entered yet.</p>
    <% end %>
  </div>

  <!-- Not yet entered -->
  <% all_chars = MrCharacter.includes(:part, :display_option).order('parts.name ASC, mr_characters.name ASC') %>
  <% entered_ids = existing_rows.map(&:mr_character_id).to_set %>
  <% color_chars = all_chars.select { |c| (c.display_option&.name&.downcase == "color") || c.display_option_id == 6 } %>
  <% missing_chars = all_chars.reject { |c| entered_ids.include?(c.id) || color_chars.include?(c) } %>
  <% missing_grouped = missing_chars.group_by { |c| c.part&.name || "Other" } %>

  <div class="mt-8">
    <h2 class="text-2xl font-semibold mb-3">Not yet entered</h2>
    <% if missing_chars.any? %>
      <% missing_grouped.each do |part_name, chars| %>
        <details class="bg-white border rounded-md p-4 mb-3">
          <summary class="font-semibold cursor-pointer"><%= part_name %> (<%= chars.size %>)</summary>
          <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2">
            <% chars.each do |c| %>
              <div class="flex items-start justify-between border rounded p-3 gap-3">
                <div class="min-w-0">
                  <div class="text-sm text-gray-700 break-words"><%= c.name.to_s.tr("_", " ") %></div>
                </div>
                <div class="shrink-0">
                  <%= form_with url: mr_character_mushrooms_path, method: :post, data: { turbo: true }, html: { class: "flex items-center gap-2" } do |f| %>
                    <%= hidden_field_tag :mushroom_id, @mushroom.id %>
                    <%= hidden_field_tag :mr_character_id, c.id %>
                    <%= render partial: "character_input", locals: { f: f, character: c, current_value: nil } %>
                    <%= f.submit "Add", class: "ml-2 rounded px-3 py-1.5 text-sm bg-gray-100 hover:bg-gray-50" %>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </details>
      <% end %>
    <% else %>
      <p class="text-gray-500">All characters are entered.</p>
    <% end %>
  </div>

  <!-- Color picker area -->
  <%# // keep color_chars in sync with the exclusion above %>
  <%# // color_chars already computed above %>
  <div class="mt-10">
    <h2 class="text-2xl font-semibold mb-3">Color characters</h2>
    <div data-controller="color-picker" data-color-picker-mushroom-id-value="<%= @mushroom.id %>">
      <!-- Color grid -->
      <div class="mb-4">
        <div class="grid grid-cols-10 gap-2">
          <% (1..50).each do |color_id| %>
            <button type="button"
                    class="border rounded p-0.5 focus:ring-2 focus:ring-blue-500"
                    data-action="click->color-picker#selectColor"
                    data-color-picker-color-id-param="<%= color_id %>">
              <%= image_tag "AMS_colors/banner_50x50/banner_#{color_id}.jpg",
                            alt: "Color #{color_id}",
                            class: "w-10 h-10 rounded border" %>
            </button>
          <% end %>
        </div>
        <div class="text-sm text-gray-600 mt-2">
          Selected color: <span data-color-picker-target="selectedColorLabel">None</span>
        </div>
      </div>

      <!-- Color characters list -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <% color_chars.each do |c| %>
          <div class="border rounded p-3">
            <div class="font-medium mb-2 break-words"><%= c.part&.name %> â€” <%= c.name.to_s.tr("_", " ") %></div>
            <%= form_with url: mr_character_mushrooms_path, method: :post, data: { turbo: true }, html: { class: "flex items-center gap-2" } do |f| %>
              <%= hidden_field_tag :mushroom_id, @mushroom.id, data: { "color-picker-target": "mushroomId" } %>
              <%= hidden_field_tag :mr_character_id, c.id %>
              <%= hidden_field_tag :character_value, nil, data: { "color-picker-target": "colorValue" } %>
              <button type="submit"
                      class="rounded px-3 py-1.5 bg-blue-600 text-white text-sm disabled:opacity-50"
                      data-color-picker-target="submitButton"
                      disabled>
                Save color
              </button>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <% if defined?(policy) && policy(@mushroom).show? %>
    <%= link_to "Show this mushroom", @mushroom, class: "w-full sm:w-auto text-center mt-8 sm:mt-0 sm:ml-2 rounded-md px-3.5 py-2.5 bg-gray-100 hover:bg-gray-50 inline-block font-medium" %>
  <% end %>

  <%= link_to "Back to mushrooms", mushrooms_path, class: "w-full sm:w-auto text-center mt-2 sm:mt-0 sm:ml-2 rounded-md px-3.5 py-2.5 bg-gray-100 hover:bg-gray-50 inline-block font-medium" %>
</div>
