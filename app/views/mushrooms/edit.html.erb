<% content_for :title, "Editing mushroom" %>

<p> app/views/mushrooms/edit.html.erb> </p>
<div class="w-full auto-margins">
  <h1 class="flex items-baseline gap-2">
    <span class="text-xl font-medium text-gray-700">Editing your mushroom:</span>
    <span class="text-3xl font-bold text-gray-900"><%= @mushroom.name %></span>
  </h1>

  <div class="text-lg font-semibold text-blue-800 mt-2">
    Mushroom ID: <span class="inline-block px-2 py-0.5 rounded bg-blue-50 border border-blue-200"><%= @mushroom.id %></span> <span class="block text-xs text-gray-500">This is the database table ID.</span>
  </div>
  <div class="readable--full">
  <p class="text-gray-800">This is a work in progress, of course, but some explanation is necessary. You may see (currently you WILL SEE) some characters that don't seem to make any sense. One good explanation is that they DO NOT make any sense <u>as they are currently represented</u>.</p>
  <p>I made the choice to include every character that I found so that none dropped out of sight and ended up being lost before knowledgeable people could decide their value, or not. Some need more fleshing out by creating lookup tables with the available options for that specific character.</p>
  <p>I certainly realize that most people, however dedicated they are to mycology, will never use every or even most of these characters. That does not reduce the value of those rarely used.</p>

    <% if current_user&.admin? %>
      <p class="text-gray-800">You are an admin. You can view how I kept track of the original source of the characters. Actually, the <b>ORIGINAL source</b> is Mushroom Observer's Excited delirium [EXD].</p>
      <p>I took EXD's list and attempted to add what would end up being database tables/rows. For example, original row 2, "2 The size (height and
        3 width) of the pileus/pilei" became row 2 "pileus_height_mm" and row 3 "pileus_width_mm" (in original source) which ends up in table mr_characters as rows 113 and 114. Since these are measurements, there are no corresponding 'lookup' associations. Whatever value is entered is what is displayed. </p>
      <p class="text-gray-800">Row 13 "13 Pileus surface texture: is glabrous (smooth) or non-glabrous (i.e. Downy-Wooly, Matted-Fibrillose, Furfuraceous, Granulose, Pruinose, Squamose, Squamulose, Scaly, Hairy, Shaggy, Bristled/Bristly, Strigose, Warted, Appressed, Appressed-Fibrillose, Tomentose, Virgate, Scrobiculate, Alveolate, Lacunose, Lacinate, Areolate, Atomate, Micaceous, Superficial, Innate, Venose, etc.)" becomes in table mr_characters (mushroom_characters), row (id) 124 'pileus_surface_texture' and in table lookup_items you have: mysql> select id, name, source_data_id from lookup_items where mr_character_id = 124;

        | id  | name                           | source_data_id |<br>

        | 371 | Glabrous smooth                |             44 |<br>
        | 372 | non-glabrous Downy-Wooly       |             44 |<br>
        | 373 | non-glabrous Matted-Fibrillose |             44 |<br>
        | 374 | non-glabrous Furfuraceous      |             44 |<br>
        | 375 | non-glabrous Granulose         |             44 |<br>
        | 376 | non-glabrous Pruinose          |             44 |<br>
        | 377 | non-glabrous Squamose          |             44 |<br>
        | 378 | non-glabrous Squamulose        |             44 |<br>
        | 379 | non-glabrous Scaly             |             44 |<br>
        | 380 | non-glabrous Hairy             |             44 |<br>
        | 381 | Shaggy                         |             44 |<br>
        | 382 | Bristled/Bristly               |             44 |<br>
        | 383 | Strigose                       |             44 |<br>
        | 384 | Warted                         |             44 |<br>
        | 385 | Appressed                      |             44 |<br>
        | 386 | Appressed-Fibrillose           |             44 |<br>
        | 387 | Tomentose                      |             44 |<br>
        | 388 | Virgate                        |             44 |<br>
        | 389 | Scrobiculate                   |             44 |<br>
        | 390 | Alveolate                      |             44 |<br>
        | 391 | Lacunose                       |             44 |<br>
        | 392 | Lacinate                       |             44 |<br>
        | 393 | Areolate                       |             44 |<br>
        | 394 | Atomate                        |             44 |<br>
        | 395 | Micaceous                      |             44 |<br>
        | 396 | Superficial                    |             44 |<br>
        | 397 | Innate                         |             44 |<br>
        | 398 | Venose                         |             44 |<br>
        | 399 | non-glabrous Other             |             44 |<br>

        29 rows in set (0.00 sec)<br> and source is Excited Delirium [EXD]: mysql> select title, author from source_data where id = 44;<br>
        | title                                                                                | author                 |<br>
        | Observation List: Characters With Taxonomic Value For Stipitate-Lamellate Mushrooms  | Excited delirium [EXD] |.</p>
      <p>The character 'pileus surface texture' will display these options in a radio list for selection. I use radio lists a lot more than drop-downs in an effort to make the data easier to understand.</p>
      <p>So, that process is what you are in the middle of, RIGHT HERE. An effort to make selecting some or all of these characters and assigning them to a mushroom to help identify it.</p>
      <p>I use a database from mycobank.org (MBList) for genus and species. More on that later.</p>
      <p>So, in addition to learning Rails and modifying this project to function within it, I am working on the data to get it is a rough shape to be modified and corrected into something of value.</p>
      <p>Note: One of the goals is to end up with a standard or uniform order of characters to be able to maintain a complete list of characters for specimens in Mushroom Observer or iNaturalist. Take the data here and paste into the other sites as notes or whatever. If this is already available, I have not found it.</p>
      <%= link_to "View original mr_characters source (CSV) originally from EXD",
                  admin_mr_characters_source_path,
                  class: "w-full text-center rounded-md px-3.5 py-2.5 bg-gray-100 hover:bg-gray-50 font-medium" %>
    <% end %>

  </div> <!-- readable -->
  <%= render "form", mushroom: @mushroom %>

  <!-- Entered characters -->
  <% existing_rows = @mushroom.mr_character_mushrooms.includes(mr_character: [:part, :display_option, :source_data]).order('parts.name ASC, mr_characters.name ASC') %>
  <% color_rows = existing_rows.select { |rc| (rc.mr_character&.display_option&.name&.downcase == "color") || rc.mr_character&.display_option_id == 6 } %>
  <% non_color_rows = existing_rows - color_rows %>
  <% existing_grouped = non_color_rows.group_by { |rc| rc.mr_character&.part&.name || "Other" } %>

  <div class="mt-8">
    <h2 class="text-2xl font-semibold mb-3">Entered characters</h2>

    <%# Colors at the top with per-card swatch picker and instruction %>
    <% if color_rows.any? %>
      <details class="bg-white border rounded-md p-4 mb-3" open>
        <summary class="font-semibold cursor-pointer">Colors (<%= color_rows.size %>)</summary>
        <p class="text-xs text-gray-600 mt-2">Click on a color patch to update this character.</p>
        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
          <% color_rows.each do |rc| %>
            <% c = rc.mr_character %>
            <% color_id = rc.character_value.to_i %>
            <% current_color = Color.find_by(id: color_id) %>
            <div class="flex flex-col border rounded p-3 gap-2">
              <div class="min-w-0 font-medium break-words"><%= c&.name.to_s.tr("_", " ") %></div>
              <div class="flex items-center text-sm text-gray-700">
                <%= image_tag "AMS_colors/banner_50x50/banner_#{color_id}.jpg",
                              alt: "Color #{color_id}",
                              class: "w-6 h-6 mr-2 rounded border" %>
                <% if current_color %>
                  <span><%= current_color.latin_name %> (<%= current_color.common_name %>)</span>
                <% else %>
                  <span>Color ID: <%= color_id %></span>
                <% end %>
              </div>
              <%= form_with url: mr_character_mushrooms_path, method: :post, data: { turbo: true }, html: { class: "mt-1" } do |f| %>
                <%= hidden_field_tag :mushroom_id, @mushroom.id %>
                <%= hidden_field_tag :mr_character_id, c.id %>
                <div class="grid grid-cols-10 gap-1">
                  <% (1..50).each do |cid| %>
                    <button type="submit"
                            name="character_value"
                            value="<%= cid %>"
                            title="Color <%= cid %>"
                            class="border rounded p-0.5 focus:ring-2 focus:ring-blue-500">
                      <%= image_tag "AMS_colors/banner_50x50/banner_#{cid}.jpg",
                                    alt: "Color #{cid}",
                                    class: "w-7 h-7 rounded border" %>
                    </button>
                  <% end %>
                </div>
                <div class="sr-only"><%= f.submit "Update color" %></div>
              <% end %>
            </div>
          <% end %>
        </div>
      </details>
    <% end %>

    <% if non_color_rows.any? %>
      <details class="bg-white border rounded-md p-4 mb-3" open>
        <summary class="font-semibold cursor-pointer">Non-color (<%= non_color_rows.size %>)</summary>
        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <% non_color_rows.each do |rc| %>
            <% c = rc.mr_character %>
            <% do_not_display = (c&.display_option&.name&.downcase == "do not display") || c&.display_option_id == 1 %>
            <div class="flex items-start justify-between border rounded p-3 gap-3">
              <div class="min-w-0">
                <div class="text-sm text-gray-500 break-words">Character: <b><%= c&.name.to_s.tr("_", " ") %></b></div>
                <div class="text-sm text-gray-500 break-words">Source: <b><%= c&.source_data&.title || "Unknown source" %></b></div>
                <% if do_not_display %>
                  <div class="mt-1 text-sm">
                    <span class="inline-block px-2 py-0.5 rounded bg-gray-100 border border-gray-200">
                      Value: <%= rc.character_value.presence || "(hidden)" %>
                    </span>
                  </div>
                <% end %>
              </div>
              <% unless do_not_display %>
                <div class="shrink-0">
                  <%= form_with url: mr_character_mushrooms_path, method: :post, data: { turbo: true }, html: { class: "flex items-center gap-2" } do |f| %>
                    <%= hidden_field_tag :mushroom_id, @mushroom.id %>
                    <%= hidden_field_tag :mr_character_id, c.id %>
                    <%= render partial: "character_input", locals: { f: f, character: c, current_value: rc.character_value } %>
                    <%= f.submit "Update", class: "ml-2 rounded px-3 py-1.5 text-sm bg-blue-600 text-white" %>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      </details>
    <% else %>
      <% unless color_rows.any? %>
        <p class="text-gray-500">No characters entered yet.</p>
      <% end %>
    <% end %>
  </div>

  <!-- Not yet entered (non-colors only) -->
  <% all_chars = MrCharacter.includes(:part, :display_option, :source_data).order('parts.name ASC, mr_characters.name ASC') %>
  <% entered_ids = existing_rows.map(&:mr_character_id).to_set %>
  <% color_chars = all_chars.select { |c| (c.display_option&.name&.downcase == "color") || c.display_option_id == 6 } %>
  <% missing_chars = all_chars.reject { |c|
        entered_ids.include?(c.id) ||
        color_chars.include?(c) ||
        ((c.display_option&.name&.downcase == "do not display") || c.display_option_id == 1)
      } %>
  <% missing_grouped = missing_chars.group_by { |c| c.part&.name || "Other" } %>

  <div class="mt-8">
    <h2 class="text-2xl font-semibold mb-3">Not yet entered</h2>
    <% if missing_chars.any? %>
      <% missing_grouped.each do |part_name, chars| %>
        <details class="bg-white border rounded-md p-4 mb-3">
          <summary class="font-semibold cursor-pointer"><%= part_name %> (<%= chars.size %>)</summary>
          <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2">
            <% chars.each do |c| %>
              <div class="flex items-start justify-between border rounded p-2 gap-2">
                <div class="min-w-0">
                  <div class="text-sm text-gray-700 break-words"><%= c.name.to_s.tr("_", " ") %></div>
                </div>
                <div class="shrink-0">
                  <%= form_with url: mr_character_mushrooms_path, method: :post, data: { turbo: true }, html: { class: "flex items-center gap-2" } do |f| %>
                    <%= hidden_field_tag :mushroom_id, @mushroom.id %>
                    <%= hidden_field_tag :mr_character_id, c.id %>
                    <%= render partial: "character_input", locals: { f: f, character: c, current_value: nil } %>
                    <%= f.submit "Add", class: "ml-2 rounded px-2 py-1 text-sm bg-gray-100 hover:bg-gray-50" %>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </details>
      <% end %>
    <% else %>
      <p class="text-gray-500">All non-color characters are entered.</p>
    <% end %>
  </div>

  <!-- Color characters (not yet entered) with per-card swatch picker -->
  <% set_color_char_ids = color_rows.map(&:mr_character_id).to_set %>
  <% missing_color_chars = color_chars.reject { |c| set_color_char_ids.include?(c.id) } %>

  <% if missing_color_chars.any? %>
    <div class="mt-10">
      <h2 class="text-2xl font-semibold mb-1">Color characters (not yet entered)</h2>
      <p class="text-xs text-gray-600 mb-3">Click on a color patch to set this character.</p>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
        <% missing_color_chars.each do |c| %>
          <div class="flex flex-col border rounded p-2 gap-2">
            <div class="min-w-0 font-medium break-words text-sm"><%= c.part&.name %> — <%= c.name.to_s.tr("_", " ") %></div>
            <div class="flex items-center text-xs text-gray-700">
              <span class="inline-flex items-center">
                <span class="w-5 h-5 mr-2 rounded border inline-block bg-white"></span>
                Not set
              </span>
            </div>
            <%= form_with url: mr_character_mushrooms_path, method: :post, data: { turbo: true }, html: { class: "mt-1" } do |f| %>
              <%= hidden_field_tag :mushroom_id, @mushroom.id %>
              <%= hidden_field_tag :mr_character_id, c.id %>
              <div class="grid grid-cols-10 gap-1">
                <% (1..50).each do |cid| %>
                  <button type="submit"
                          name="character_value"
                          value="<%= cid %>"
                          title="Color <%= cid %>"
                          class="border rounded p-0.5 focus:ring-2 focus:ring-blue-500">
                    <%= image_tag "AMS_colors/banner_50x50/banner_#{cid}.jpg",
                                  alt: "Color #{cid}",
                                  class: "w-7 h-7 rounded border" %>
                  </button>
                <% end %>
              </div>
              <div class="sr-only"><%= f.submit "Save color" %></div>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <div class="mt-10">
  <% if defined?(policy) && policy(@mushroom).show? %>
    <%= link_to "Show this mushroom", @mushroom, class: "w-full sm:w-auto rounded-md px-3.5 py-2.5 bg-blue-600 hover:bg-blue-500 text-white inline-block font-medium cursor-pointer" %>
  <% end %> <p class="text-blue-600">"Show this mushroom" will display all of "set" characters without form options.</p>

  <%= link_to "Back to mushrooms", mushrooms_path, class: "w-full sm:w-auto rounded-md px-3.5 py-2.5 bg-blue-600 hover:bg-blue-500 text-white inline-block font-medium cursor-pointer" %>
  </div>
  </div>

