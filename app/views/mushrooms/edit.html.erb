<% content_for :title, "Editing mushroom" %>

<div class="w-full auto-margins">
  <h1 class="flex items-baseline gap-2">
    <span class="text-xl font-medium text-gray-700">Editing your mushroom:</span>
    <span class="text-3xl font-bold text-gray-900"><%= @mushroom.name %></span>
  </h1>

  <div class="text-lg font-semibold text-blue-800 mt-2">
    Mushroom ID: <span class="inline-block px-2 py-0.5 rounded bg-blue-50 border border-blue-200"><%= @mushroom.id %></span> <span class="block text-xs text-gray-500">This is the database table ID.</span>
  </div>

  <%= render 'shared/mushroom_menu', mushroom: @mushroom %>  <!-- at top of page -->

  <!-- Images Section -->
  <% images = @mushroom.image_mushrooms.select { |im| im.image_file.attached? } %>
  <div class="my-5">
    <button type="button"
            class="bg-gray-100 border rounded px-3 py-1 mb-2 font-medium text-blue-700 hover:bg-blue-100 transition"
            onclick="document.getElementById('images-panel').classList.toggle('hidden')">
      <span>
        <%= images.any? ? "View Images (#{images.count})" : "No images uploaded yet" %>
      </span>
    </button>

    <% if images.any? %>
      <div id="images-panel" class="border border-blue-200 rounded p-4 bg-blue-50">
        <div class="mb-3">
          <h3 class="text-lg font-semibold text-gray-800 mb-1">Mushroom Images</h3>
          <p class="text-sm text-gray-700 mb-3">
            Click any image to view full size, then see EXIF data or delete image.
          </p>
        </div>

        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
          <% images.each do |image_mushroom| %>
            <div class="border border-gray-300 rounded-lg overflow-hidden bg-white shadow-sm hover:shadow-md transition-shadow">
              <%= link_to image_mushroom_path(image_mushroom), class: "block" do %>
                <div class="aspect-square bg-gray-100">
                  <picture>
                    <%= tag.source(
                          srcset: url_for(
                            image_mushroom.image_file.variant(
                              resize_to_fill: [200, 200],
                              format: :webp,
                              saver: { strip: true, quality: 60, effort: 4 }
                            ).processed
                          ),
                          type: "image/webp"
                        ) %>
                    <%= image_tag(
                          image_mushroom.image_file.variant(
                            resize_to_fill: [200, 200],
                            saver: { strip: true, quality: 72, optimize_coding: true }
                          ).processed,
                          width: 200,
                          height: 200,
                          class: "w-full h-full object-cover block hover:opacity-90 transition-opacity",
                          loading: "lazy",
                          decoding: "async",
                          alt: image_mushroom.image_name.presence || @mushroom.name
                        ) %>
                  </picture>
                </div>
              <% end %>
              <div class="p-2">
                <p class="text-xs font-medium text-gray-700 truncate">
                  <%= image_mushroom.part&.name || "Part not set" %>
                </p>
                <% if image_mushroom.image_name.present? %>
                  <p class="text-xs text-gray-500 truncate" title="<%= image_mushroom.image_name %>">
                    <%= image_mushroom.image_name %>
                  </p>
                <% end %>
                <%= link_to "Edit Image",
                            edit_mushroom_image_mushroom_path(@mushroom, image_mushroom),
                            class: "mt-2 block text-center text-xs px-2 py-1 bg-yellow-100 hover:bg-yellow-200 text-yellow-800 rounded border border-yellow-300" %>
              </div>
            </div>
          <% end %>
        </div>

        <div class="mt-4 pt-3 border-t border-blue-300">
          <%= link_to "‚ûï Add New Image",
                      new_mushroom_image_mushroom_path(@mushroom),
                      class: "inline-block rounded-md px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium" %>
        </div>
      </div>
    <% else %>
      <div id="images-panel" class="border border-blue-200 rounded p-4 bg-blue-50">
        <p class="text-sm text-gray-700 mb-3">No images have been uploaded for this mushroom yet.</p>
        <%= link_to "‚ûï Add First Image",
                    new_mushroom_image_mushroom_path(@mushroom),
                    class: "inline-block rounded-md px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium" %>
      </div>
    <% end %>
  </div>

  <!-- Basic Mushroom Data Section -->
  <div class="my-5">
    <button type="button"
            class="bg-gray-100 border rounded px-3 py-1 mb-2 font-medium text-indigo-700 hover:bg-indigo-100 transition"
            onclick="document.getElementById('basic-data-panel').classList.toggle('hidden')">
      <span>Edit Basic Mushroom Data</span>
    </button>

    <div id="basic-data-panel" class="hidden border border-indigo-200 rounded p-4 bg-indigo-50">
      <%= render 'form', mushroom: @mushroom %>
    </div>
  </div>

  <!-- Associated Trees Section -->
  <div class="my-5">
    <button type="button"
            class="bg-gray-100 border rounded px-3 py-1 mb-2 font-medium text-green-700 hover:bg-green-100 transition"
            onclick="document.getElementById('trees-panel').classList.toggle('hidden')">
      <span>
        <%= @mushroom.trees.any? ? "Edit associated trees (#{@mushroom.trees.count})" : "Add associated trees (optional)" %>
      </span>
    </button>

    <!-- Summary pills outside panel -->
    <% if @mushroom.trees.any? %>
      <div class="mb-2 flex flex-wrap gap-2 items-center">
        <span class="text-xs text-green-700 font-medium pr-2">Associated Trees:</span>
        <% @mushroom.trees.order(:name).each do |t| %>
          <span class="inline-flex items-center bg-green-200 rounded px-2 py-0.5 text-xs">
            <%= t.name %>
          </span>
        <% end %>
      </div>
    <% end %>

    <div id="trees-panel" class="hidden border border-green-200 rounded p-4 bg-green-50">
      <div class="mb-3">
        <span class="block text-sm font-medium text-gray-700 mb-2">
          Associated Trees
        </span>
        <p class="text-xs text-green-700 mb-1">
          Add trees that are associated with this mushroom (e.g., mycorrhizal partners or host trees).
        </p>
      </div>
      <div class="mb-3">
        <label class="block text-xs font-semibold text-gray-700">Add Trees</label>
        <p class="text-xs text-gray-600 mb-1">
          Begin typing at least 3 letters, then select a tree from the dropdown. Each tree you choose will show up as a green pill below.
          You can select multiple trees and remove any of them by clicking √ó.
        </p>
        <div data-controller="tokens"
             data-tokens-url-value="<%= trees_autocomplete_path(format: :json) %>"
             data-tokens-min-value="3"
             data-tokens-mushroom-id-value="<%= @mushroom.id %>"
             data-tokens-kind-value="trees"
             class="border rounded p-2 bg-white">
          <div class="mb-2 flex items-center gap-2">
            <div class="relative w-full">
              <input type="text"
                     placeholder="Type at least 3 letters..."
                     class="w-full border rounded px-2 py-1 min-w-[16rem] md:min-w-[24rem] max-w-xl"
                     data-tokens-target="input"
                     data-action="input->tokens#onInput"
                     minlength="3"
                     autocomplete="off">
              <div data-tokens-target="loader" class="hidden absolute right-2 top-1/2 transform -translate-y-1/2">
                <svg class="animate-spin h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </div>
              <ul class="hidden border rounded mt-1 bg-white max-h-52 overflow-auto min-w-[16rem] md:min-w-[24rem] max-w-xl shadow-lg"
                  data-tokens-target="dropdown"
                  style="position: absolute; z-index: 40;"></ul>
            </div>
          </div>
          <div class="flex flex-wrap gap-1" data-tokens-target="list">
            <% @mushroom.trees.order(:name).each do |t| %>
              <span class="inline-flex items-center bg-gray-200 rounded px-2 py-0.5 text-sm mr-1 mb-1">
                <%= t.name %>
                <%= link_to "√ó",
                            destroy_by_relation_mushroom_trees_path(mushroom_id: @mushroom.id, tree_id: t.id),
                            data: { turbo_method: :delete, turbo_confirm: "Remove #{t.name}?" },
                            class: "ml-1 text-gray-600 hover:text-red-600" %>
              </span>
            <% end %>
          </div>
          <input type="hidden" data-tokens-target="hiddenIds" value="<%= @mushroom.trees.pluck(:id).join(',') %>">
        </div>
      </div>
    </div>
  </div>

  <!-- Associated Plants Section -->
  <div class="my-5">
    <button type="button"
            class="bg-gray-100 border rounded px-3 py-1 mb-2 font-medium text-purple-700 hover:bg-purple-100 transition"
            onclick="document.getElementById('plants-panel').classList.toggle('hidden')">
      <span>
        <%= @mushroom.plants.any? ? "Edit associated plants (#{@mushroom.plants.count})" : "Add associated plants (optional)" %>
      </span>
    </button>

    <!-- Summary pills outside panel -->
    <% if @mushroom.plants.any? %>
      <div class="mb-2 flex flex-wrap gap-2 items-center">
        <span class="text-xs text-purple-700 font-medium pr-2">Associated Plants:</span>
        <% @mushroom.plants.order(:name).each do |p| %>
          <span class="inline-flex items-center bg-purple-200 rounded px-2 py-0.5 text-xs">
            <%= p.name %>
          </span>
        <% end %>
      </div>
    <% end %>

    <div id="plants-panel" class="hidden border border-purple-200 rounded p-4 bg-purple-50">
      <div class="mb-3">
        <span class="block text-sm font-medium text-gray-700 mb-2">
          Associated Plants
        </span>
        <p class="text-xs text-purple-700 mb-1">
          Add plants that are associated with this mushroom (e.g., growing on or near specific plants).
        </p>
      </div>
      <div class="mb-3">
        <label class="block text-xs font-semibold text-gray-700">Add Plants</label>
        <p class="text-xs text-gray-600 mb-1">
          Begin typing at least 3 letters, then select a plant from the dropdown. Each plant you choose will show up as a purple pill below.
          You can select multiple plants and remove any of them by clicking √ó.
        </p>
        <div data-controller="tokens"
             data-tokens-url-value="<%= plants_autocomplete_path(format: :json) %>"
             data-tokens-min-value="3"
             data-tokens-mushroom-id-value="<%= @mushroom.id %>"
             data-tokens-kind-value="plants"
             class="border rounded p-2 bg-white">
          <div class="mb-2 flex items-center gap-2">
            <div class="relative w-full">
              <input type="text"
                     placeholder="Type at least 3 letters..."
                     class="w-full border rounded px-2 py-1 min-w-[16rem] md:min-w-[24rem] max-w-xl"
                     data-tokens-target="input"
                     data-action="input->tokens#onInput"
                     minlength="3"
                     autocomplete="off">
              <div data-tokens-target="loader" class="hidden absolute right-2 top-1/2 transform -translate-y-1/2">
                <svg class="animate-spin h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </div>
              <ul class="hidden border rounded mt-1 bg-white max-h-52 overflow-auto min-w-[16rem] md:min-w-[24rem] max-w-xl shadow-lg"
                  data-tokens-target="dropdown"
                  style="position: absolute; z-index: 40;"></ul>
            </div>
          </div>
          <div class="flex flex-wrap gap-1" data-tokens-target="list">
            <% @mushroom.plants.order(:name).each do |p| %>
              <span class="inline-flex items-center bg-gray-200 rounded px-2 py-0.5 text-sm mr-1 mb-1">
                <%= p.name %>
                <%= link_to "√ó",
                            destroy_by_relation_mushroom_plants_path(mushroom_id: @mushroom.id, plant_id: p.id),
                            data: { turbo_method: :delete, turbo_confirm: "Remove #{p.name}?" },
                            class: "ml-1 text-gray-600 hover:text-red-600" %>
              </span>
            <% end %>
          </div>
          <input type="hidden" data-tokens-target="hiddenIds" value="<%= @mushroom.plants.pluck(:id).join(',') %>">
        </div>
      </div>
    </div>
  </div>

  <!-- Entered characters -->
  <% existing_rows = @mushroom.mr_character_mushrooms.includes(mr_character: [:part, :display_option, :source_data]).order('parts.name ASC, mr_characters.name ASC') %>
  <% color_rows = existing_rows.select { |rc| (rc.mr_character&.display_option&.name&.downcase == "color") || rc.mr_character&.display_option_id == 6 } %>
  <% non_color_rows = existing_rows - color_rows %>
  <% existing_grouped = non_color_rows.group_by { |rc| rc.mr_character&.part&.name || "Other" } %>

  <div class="mt-8">
    <h2 class="text-2xl font-semibold mb-3">Entered characters</h2>

    <%# Colors at the top with per-card swatch picker and instruction %>
    <% if color_rows.any? %>
      <details class="bg-white border rounded-md p-4 mb-3" open>
        <summary class="font-semibold cursor-pointer">Colors (<%= color_rows.size %>)</summary>
        <p class="text-xs text-gray-600 mt-2">Click on a color patch to update this character.</p>
        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
          <% color_rows.each do |rc| %>
            <% c = rc.mr_character %>
            <% color_id = rc.character_value.to_i %>
            <% current_color = Color.find_by(id: color_id) %>
            <div class="flex flex-col border rounded p-3 gap-2">
              <div class="min-w-0 font-medium break-words"><%= c&.name.to_s.tr("_", " ") %></div>
              <div class="flex items-center text-sm text-gray-700">
                <%= image_tag "AMS_colors/banner_50x50/banner_#{color_id}.jpg",
                              alt: "Color #{color_id}",
                              class: "w-6 h-6 mr-2 rounded border" %>
                <% if current_color %>
                  <span><%= current_color.latin_name %> (<%= current_color.common_name %>)</span>
                <% else %>
                  <span>Color ID: <%= color_id %></span>
                <% end %>
              </div>
              <%= form_with url: mr_character_mushrooms_path, method: :post, data: { turbo: true }, html: { class: "mt-1" } do |f| %>
                <%= hidden_field_tag :mushroom_id, @mushroom.id %>
                <%= hidden_field_tag :mr_character_id, c.id %>
                <div class="grid grid-cols-10 gap-1">
                  <% (1..50).each do |cid| %>
                    <button type="submit"
                            name="character_value"
                            value="<%= cid %>"
                            title="Color <%= cid %>"
                            class="border rounded p-0.5 focus:ring-2 focus:ring-blue-500">
                      <%= image_tag "AMS_colors/banner_50x50/banner_#{cid}.jpg",
                                    alt: "Color #{cid}",
                                    class: "w-7 h-7 rounded border" %>
                    </button>
                  <% end %>
                </div>
                <div class="sr-only"><%= f.submit "Update color" %></div>
              <% end %>
            </div>
          <% end %>
        </div>
      </details>
    <% end %>

    <% if non_color_rows.any? %>
      <details class="bg-white border rounded-md p-4 mb-3" open>
        <summary class="font-semibold cursor-pointer">Non-color (<%= non_color_rows.size %>)</summary>
        <div class="mt-3 grid grid-cols-1 lg:grid-cols-2 gap-3">
          <% non_color_rows.each do |rc| %>
            <% c = rc.mr_character %>
            <% do_not_display = (c&.display_option&.name&.downcase == "do not display") || c&.display_option_id == 1 %>
            <div class="flex flex-col md:flex-row md:items-start md:justify-between border rounded p-3 gap-3">
              <div class="flex-1 min-w-0">
                <div class="text-sm text-gray-500 break-words">Character: <b><%= c&.name.to_s.tr("_", " ") %></b></div>
                <div class="text-sm text-gray-500 break-words">Source: <b><%= c&.source_data&.title || "Unknown source" %></b></div>
                <% if do_not_display %>
                  <div class="mt-1 text-sm">
                    <span class="inline-block px-2 py-0.5 rounded bg-gray-100 border border-gray-100">
                      Value: <%= rc.character_value.presence || "(hidden)" %>
                    </span>
                  </div>
                <% end %>
              </div>
              <% unless do_not_display %>
                <div class="shrink-0 w-full md:w-auto">
                  <%= form_with url: mr_character_mushrooms_path, method: :post, data: { turbo: true }, html: { class: "flex items-center gap-2" } do |f| %>
                    <%= hidden_field_tag :mushroom_id, @mushroom.id %>
                    <%= hidden_field_tag :mr_character_id, c.id %>
                    <%= render partial: "character_input", locals: { f: f, character: c, current_value: rc.character_value } %>
                    <%= f.submit "Update", class: "ml-2 rounded px-3 py-1.5 text-sm bg-blue-600 text-white" %>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      </details>
    <% else %>
      <% unless color_rows.any? %>
        <p class="text-gray-500">No characters entered yet.</p>
      <% end %>
    <% end %>
  </div>

  <!-- Not entered (non-colors only) %>
  <%# PERFORMANCE FIX: Only load these if needed - uses cached version %>
  <%# FUNGUS TYPE FILTERING: Only show characters for this mushroom's fungus type %>
  <% if params[:show_all_characters] == "true" || params[:show_part].present? %>
    <% if @mushroom.fungus_type_id.present? %>
      <% all_chars = MrCharacter.cached_for_fungus_type(@mushroom.fungus_type_id) %>
    <% else %>
      <% all_chars = MrCharacter.cached_all_with_associations %>
    <% end %>
    <% entered_ids = existing_rows.map(&:mr_character_id).to_set %>
    <% color_chars = all_chars.select { |c| (c.display_option&.name&.downcase == "color") || c.display_option_id == 6 } %>
    <% missing_chars = all_chars.reject { |c|
          entered_ids.include?(c.id) ||
          color_chars.include?(c) ||
          ((c.display_option&.name&.downcase == "do not display") || c.display_option_id == 1)
        } %>

    <%# Filter by part if show_part parameter is present %>
    <% if params[:show_part].present? && params[:show_part] != "Other" %>
      <% missing_chars = missing_chars.select { |c| c.part&.name == params[:show_part] } %>
    <% elsif params[:show_part] == "Other" %>
      <%# "Other" includes all parts with fewer characters %>
      <% other_parts = ["Mycelium", "Veil", "Spores", "Habitat", "Location", "Identification", "Admin", "Rhizomorph", "Color", "Storage"] %>
      <% missing_chars = missing_chars.select { |c| other_parts.include?(c.part&.name) } %>
    <% end %>

    <% missing_grouped = missing_chars.group_by { |c| c.part&.name || "Other" } %>
  <% else %>
    <% missing_chars = [] %>
    <% missing_grouped = {} %>
  <% end %>

  !-- Character Search -->
  <div class="mt-8 bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-md p-4 mb-4">
    <h3 class="text-lg font-semibold text-gray-800 mb-2">üîç Search for a Character</h3>
    <% if @mushroom.fungus_type_id.present? %>
      <% char_count = MrCharacter.for_fungus_type(@mushroom.fungus_type_id).count %>
      <p class="text-sm text-gray-600 mb-3">
        Can't find what you're looking for? Search across <%= char_count %> characters for <%= @mushroom.fungus_type.name %> mushrooms.
      </p>
    <% else %>
      <p class="text-sm text-amber-700 bg-amber-50 border border-amber-300 rounded px-3 py-2 mb-3">
        ‚ö†Ô∏è <strong>Tip:</strong> Set your mushroom's <strong>Fungus Type</strong> in "Edit Basic Mushroom Data" above to see only relevant characters for your fungus type.
        Currently showing all <%= MrCharacter.count %> characters.
      </p>
    <% end %>

    <div class="relative" data-controller="character-search"
         data-character-search-mushroom-id-value="<%= @mushroom.id %>">
      <input type="text"
             placeholder="Type at least 3 characters (e.g., 'pileus', 'color', 'taste', 'shape')..."
             class="w-full border border-purple-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-purple-500"
             data-character-search-target="input"
             minlength="3"
             autocomplete="off">

      <div data-character-search-target="loader" class="hidden absolute right-3 top-1/2 transform -translate-y-1/2">
        <svg class="animate-spin h-5 w-5 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      </div>

      <ul class="hidden border border-purple-300 rounded-lg mt-2 bg-white max-h-96 overflow-auto shadow-xl"
          data-character-search-target="dropdown"
          style="position: absolute; z-index: 50; width: 100%;"></ul>
    </div>

    <p class="text-xs text-gray-500 mt-2">
      üí° Tip: Search results will load the relevant part section and show the character.
    </p>
  </div>

  <div class="mt-8">
    <% if params[:show_all_characters] != "true" && params[:show_part].blank? %>
      <div class="bg-blue-50 border border-blue-200 rounded-md p-4 mb-3">
        <p class="text-sm text-gray-700 mb-3">To improve page load speed, character lists are hidden by default. Load characters by part as needed:</p>
        <div class="flex flex-wrap gap-2">
          <%= link_to "Load Micro (203)", edit_mushroom_path(@mushroom, show_part: "Micro"), class: "rounded-md px-3 py-1.5 bg-purple-600 hover:bg-purple-500 text-white inline-block font-medium text-sm" %>
          <%= link_to "Load Stem (133)", edit_mushroom_path(@mushroom, show_part: "Stem - Stipe"), class: "rounded-md px-3 py-1.5 bg-green-600 hover:bg-green-500 text-white inline-block font-medium text-sm" %>
          <%= link_to "Load Gills (77)", edit_mushroom_path(@mushroom, show_part: "Gills - Lamellae"), class: "rounded-md px-3 py-1.5 bg-yellow-600 hover:bg-yellow-500 text-white inline-block font-medium text-sm" %>
          <%= link_to "Load Cap (70)", edit_mushroom_path(@mushroom, show_part: "Cap - Pileus"), class: "rounded-md px-3 py-1.5 bg-red-600 hover:bg-red-500 text-white inline-block font-medium text-sm" %>
          <%= link_to "Load Basic (68)", edit_mushroom_path(@mushroom, show_part: "Basic"), class: "rounded-md px-3 py-1.5 bg-blue-600 hover:bg-blue-500 text-white inline-block font-medium text-sm" %>
          <%= link_to "Load Other Parts", edit_mushroom_path(@mushroom, show_part: "Other"), class: "rounded-md px-3 py-1.5 bg-gray-600 hover:bg-gray-500 text-white inline-block font-medium text-sm" %>
          <%= link_to "Load All Characters", edit_mushroom_path(@mushroom, show_all_characters: "true"), class: "rounded-md px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 text-white inline-block font-medium text-sm" %>
        </div>
      </div>
    <% end %>
    <h2 class="text-2xl font-semibold mb-3">Not yet entered</h2>
    <% if missing_chars.any? %>
      <% missing_grouped.each do |part_name, chars| %>
        <details class="bg-white border rounded-md p-4 mb-3" <%= 'open' if params[:show_part].present? %>>
          <summary class="font-semibold cursor-pointer"><%= part_name %> (<%= chars.size %>)</summary>
          <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2">
            <% chars.each do |c| %>
              <div class="flex items-start justify-between border rounded p-2 gap-2" data-character-id="<%= c.id %>">
                <div class="min-w-0">
                  <div class="text-sm text-gray-700 break-words"><%= c.name.to_s.tr("_", " ") %></div>
                </div>
                <div class="shrink-0">
                  <%= form_with url: mr_character_mushrooms_path, method: :post, data: { turbo: true }, html: { class: "flex items-center gap-2" } do |f| %>
                    <%= hidden_field_tag :mushroom_id, @mushroom.id %>
                    <%= hidden_field_tag :mr_character_id, c.id %>
                    <%= render partial: "character_input", locals: { f: f, character: c, current_value: nil } %>
                    <%= f.submit "Add", class: "ml-2 rounded px-2 py-1 text-sm bg-gray-100 hover:bg-gray-50" %>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </details>
      <% end %>
    <% else %>
      <% if params[:show_all_characters] == "true" %>
        <p class="text-gray-500">All non-color characters are entered.</p>
      <% elsif params[:show_part].present? %>
        <p class="text-gray-500">All non-color characters for <%= params[:show_part] %> are entered.</p>
      <% else %>
        <p class="text-gray-500">Click a "Load" button above to view available characters.</p>
      <% end %>
    <% end %>
  </div>

  <!-- Color characters (not yet entered) with per-card swatch picker -->
  <% if params[:show_all_characters] == "true" || params[:show_part].present? %>
    <% set_color_char_ids = color_rows.map(&:mr_character_id).to_set %>
    <% missing_color_chars = color_chars.reject { |c| set_color_char_ids.include?(c.id) } %>

    <%# Filter by part if show_part parameter is present %>
    <% if params[:show_part].present? && params[:show_part] != "Other" %>
      <% missing_color_chars = missing_color_chars.select { |c| c.part&.name == params[:show_part] } %>
    <% elsif params[:show_part] == "Other" %>
      <% other_parts = ["Mycelium", "Veil", "Spores", "Habitat", "Location", "Identification", "Admin", "Rhizomorph", "Color", "Storage"] %>
      <% missing_color_chars = missing_color_chars.select { |c| other_parts.include?(c.part&.name) } %>
    <% end %>
  <% else %>
    <% missing_color_chars = [] %>
  <% end %>

  <% if missing_color_chars.any? %>
    <div class="mt-4">
      <% if defined?(policy) && policy(@mushroom).show? %>
        <%= link_to "Show this mushroom", @mushroom, class: "w-full sm:w-auto rounded-md px-2 py-1 bg-blue-600 hover:bg-blue-500 text-white inline-block font-medium cursor-pointer" %>
      <% end %> <p class="text-blue-600">"Show this mushroom" will display all of "set" characters without form options.</p>

      <%= link_to "Back to mushrooms", mushrooms_path, class: "w-full sm:w-auto rounded-md px-2 py-1 bg-blue-600 hover:bg-blue-500 text-white inline-block font-medium cursor-pointer" %>
    </div>
    <div class="mt-10">
      <h2 class="text-2xl font-semibold mb-1">Color characters (not yet entered)</h2>
      <p class="p-mrdbid">Most color characters are from <a class="text-blue-600 underline" href="https://mushroomobserver.org/species_lists/1417?q">Simple & Advanced Characters With Taxonomic Value For Stipitate-Lamellate Mushroom</a> at https://mushroomobserver.org/species_lists/1417?q by Excited delirium [EXD]. Some editing of names and purpose is needed.</p>
      <p class="p-mrdbid">Click on a color patch to set this character.</p>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
        <% missing_color_chars.each do |c| %>
          <div class="flex flex-col border rounded p-2 gap-2">
            <div class="min-w-0 font-medium break-words text-sm"><%= c.part&.name %> ‚Äî <%= c.name.to_s.tr("_", " ") %></div>
            <div class="flex items-center text-xs text-gray-700">
              <span class="inline-flex items-center">
                <span class="w-5 h-5 mr-2 rounded border inline-block bg-white"></span>
                Not set
              </span>
            </div>
            <%= form_with url: mr_character_mushrooms_path, method: :post, data: { turbo: true }, html: { class: "mt-1" } do |f| %>
              <%= hidden_field_tag :mushroom_id, @mushroom.id %>
              <%= hidden_field_tag :mr_character_id, c.id %>
              <div class="grid grid-cols-10 gap-1">
                <% (1..50).each do |cid| %>
                  <button type="submit"
                          name="character_value"
                          value="<%= cid %>"
                          title="Color <%= cid %>"
                          class="border rounded p-0.5 focus:ring-2 focus:ring-blue-500">
                    <%= image_tag "AMS_colors/banner_50x50/banner_#{cid}.jpg",
                                  alt: "Color #{cid}",
                                  class: "w-7 h-7 rounded border" %>
                  </button>
                <% end %>
              </div>
              <div class="sr-only"><%= f.submit "Save color" %></div>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
  <div class="mt-4">
    <%= render 'shared/mushroom_menu', mushroom: @mushroom %>  <!-- at bottom of page -->
  </div>

  <!-- Scroll to character from search -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const characterId = sessionStorage.getItem('scrollToCharacter');
      if (characterId) {
        // Find the character row by data attribute
        const characterRow = document.querySelector(`[data-character-id="${characterId}"]`);

        if (characterRow) {
          // Wait a brief moment for the details section to fully render
          setTimeout(() => {
            // Scroll to the character with smooth animation
            characterRow.scrollIntoView({
              behavior: 'smooth',
              block: 'center'
            });

            // Add highlight if requested
            if (sessionStorage.getItem('highlightCharacter')) {
              // Add yellow ring and background
              characterRow.classList.add('ring-4', 'ring-yellow-400', 'bg-yellow-50');

              // Remove highlight after 3 seconds
              setTimeout(() => {
                characterRow.classList.remove('ring-4', 'ring-yellow-400', 'bg-yellow-50');
              }, 3000);
            }
          }, 300); // Small delay to ensure details is open
        }

        // Clear sessionStorage after use
        sessionStorage.removeItem('scrollToCharacter');
        sessionStorage.removeItem('highlightCharacter');
      }
    });
  </script>
</div>