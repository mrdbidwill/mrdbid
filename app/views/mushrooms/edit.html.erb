<% content_for :title, "Editing mushroom" %>

<div class="w-full auto-margins">
  <h1 class="flex items-baseline gap-2">
    <span class="text-xl font-medium text-gray-700">Editing your mushroom:</span>
    <span class="text-3xl font-bold text-gray-900"><%= @mushroom.name %></span>
  </h1>

  <div class="text-lg font-semibold text-blue-800 mt-2">
    Mushroom ID: <span class="inline-block px-2 py-0.5 rounded bg-blue-50 border border-blue-200"><%= @mushroom.id %></span> <span class="block text-xs text-gray-500">This is the database table ID.</span>
  </div>

  <%= render "form", mushroom: @mushroom %>

  <!-- Entered characters -->
  <% existing_rows = @mushroom.mr_character_mushrooms.includes(mr_character: [:part, :display_option, :source_data]).order('parts.name ASC, mr_characters.name ASC') %>
  <% color_rows = existing_rows.select { |rc| (rc.mr_character&.display_option&.name&.downcase == "color") || rc.mr_character&.display_option_id == 6 } %>
  <% non_color_rows = existing_rows - color_rows %>
  <% existing_grouped = non_color_rows.group_by { |rc| rc.mr_character&.part&.name || "Other" } %>

  <div class="mt-8">
    <h2 class="text-2xl font-semibold mb-3">Entered characters</h2>

    <%# Colors at the top with per-card swatch picker and instruction %>
    <% if color_rows.any? %>
      <details class="bg-white border rounded-md p-4 mb-3" open>
        <summary class="font-semibold cursor-pointer">Colors (<%= color_rows.size %>)</summary>
        <p class="text-xs text-gray-600 mt-2">Click on a color patch to update this character.</p>
        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
          <% color_rows.each do |rc| %>
            <% c = rc.mr_character %>
            <% color_id = rc.character_value.to_i %>
            <% current_color = Color.find_by(id: color_id) %>
            <div class="flex flex-col border rounded p-3 gap-2">
              <div class="min-w-0 font-medium break-words"><%= c&.name.to_s.tr("_", " ") %></div>
              <div class="flex items-center text-sm text-gray-700">
                <%= image_tag "AMS_colors/banner_50x50/banner_#{color_id}.jpg",
                              alt: "Color #{color_id}",
                              class: "w-6 h-6 mr-2 rounded border" %>
                <% if current_color %>
                  <span><%= current_color.latin_name %> (<%= current_color.common_name %>)</span>
                <% else %>
                  <span>Color ID: <%= color_id %></span>
                <% end %>
              </div>
              <%= form_with url: mr_character_mushrooms_path, method: :post, data: { turbo: true }, html: { class: "mt-1" } do |f| %>
                <%= hidden_field_tag :mushroom_id, @mushroom.id %>
                <%= hidden_field_tag :mr_character_id, c.id %>
                <div class="grid grid-cols-10 gap-1">
                  <% (1..50).each do |cid| %>
                    <button type="submit"
                            name="character_value"
                            value="<%= cid %>"
                            title="Color <%= cid %>"
                            class="border rounded p-0.5 focus:ring-2 focus:ring-blue-500">
                      <%= image_tag "AMS_colors/banner_50x50/banner_#{cid}.jpg",
                                    alt: "Color #{cid}",
                                    class: "w-7 h-7 rounded border" %>
                    </button>
                  <% end %>
                </div>
                <div class="sr-only"><%= f.submit "Update color" %></div>
              <% end %>
            </div>
          <% end %>
        </div>
      </details>
    <% end %>

    <% if non_color_rows.any? %>
      <details class="bg-white border rounded-md p-4 mb-3" open>
        <summary class="font-semibold cursor-pointer">Non-color (<%= non_color_rows.size %>)</summary>
        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <% non_color_rows.each do |rc| %>
            <% c = rc.mr_character %>
            <% do_not_display = (c&.display_option&.name&.downcase == "do not display") || c&.display_option_id == 1 %>
            <div class="flex items-start justify-between border rounded p-3 gap-3">
              <div class="min-w-0">
                <div class="text-sm text-gray-500 break-words">Character: <b><%= c&.name.to_s.tr("_", " ") %></b></div>
                <div class="text-sm text-gray-500 break-words">Source: <b><%= c&.source_data&.title || "Unknown source" %></b></div>
                <% if do_not_display %>
                  <div class="mt-1 text-sm">
                    <span class="inline-block px-2 py-0.5 rounded bg-gray-100 border border-gray-200">
                      Value: <%= rc.character_value.presence || "(hidden)" %>
                    </span>
                  </div>
                <% end %>
              </div>
              <% unless do_not_display %>
                <div class="shrink-0">
                  <%= form_with url: mr_character_mushrooms_path, method: :post, data: { turbo: true }, html: { class: "flex items-center gap-2" } do |f| %>
                    <%= hidden_field_tag :mushroom_id, @mushroom.id %>
                    <%= hidden_field_tag :mr_character_id, c.id %>
                    <%= render partial: "character_input", locals: { f: f, character: c, current_value: rc.character_value } %>
                    <%= f.submit "Update", class: "ml-2 rounded px-3 py-1.5 text-sm bg-blue-600 text-white" %>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      </details>
    <% else %>
      <% unless color_rows.any? %>
        <p class="text-gray-500">No characters entered yet.</p>
      <% end %>
    <% end %>
  </div>

  <!-- Not entered (non-colors only) -->
  <% all_chars = MrCharacter.includes(:part, :display_option, :source_data).order('parts.name ASC, mr_characters.name ASC') %>
  <% entered_ids = existing_rows.map(&:mr_character_id).to_set %>
  <% color_chars = all_chars.select { |c| (c.display_option&.name&.downcase == "color") || c.display_option_id == 6 } %>
  <% missing_chars = all_chars.reject { |c|
        entered_ids.include?(c.id) ||
        color_chars.include?(c) ||
        ((c.display_option&.name&.downcase == "do not display") || c.display_option_id == 1)
      } %>
  <% missing_grouped = missing_chars.group_by { |c| c.part&.name || "Other" } %>

  <div class="mt-8">
    <h2 class="text-2xl font-semibold mb-3">Not yet entered</h2>
    <% if missing_chars.any? %>
      <% missing_grouped.each do |part_name, chars| %>
        <details class="bg-white border rounded-md p-4 mb-3">
          <summary class="font-semibold cursor-pointer"><%= part_name %> (<%= chars.size %>)</summary>
          <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2">
            <% chars.each do |c| %>
              <div class="flex items-start justify-between border rounded p-2 gap-2">
                <div class="min-w-0">
                  <div class="text-sm text-gray-700 break-words"><%= c.name.to_s.tr("_", " ") %></div>
                </div>
                <div class="shrink-0">
                  <%= form_with url: mr_character_mushrooms_path, method: :post, data: { turbo: true }, html: { class: "flex items-center gap-2" } do |f| %>
                    <%= hidden_field_tag :mushroom_id, @mushroom.id %>
                    <%= hidden_field_tag :mr_character_id, c.id %>
                    <%= render partial: "character_input", locals: { f: f, character: c, current_value: nil } %>
                    <%= f.submit "Add", class: "ml-2 rounded px-2 py-1 text-sm bg-gray-100 hover:bg-gray-50" %>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </details>
      <% end %>
    <% else %>
      <p class="text-gray-500">All non-color characters are entered.</p>
    <% end %>
  </div>

  <!-- Color characters (not yet entered) with per-card swatch picker -->
  <% set_color_char_ids = color_rows.map(&:mr_character_id).to_set %>
  <% missing_color_chars = color_chars.reject { |c| set_color_char_ids.include?(c.id) } %>

  <% if missing_color_chars.any? %>
    <div class="mt-10">
      <h2 class="text-2xl font-semibold mb-1">Color characters (not yet entered)</h2>
      <p class="text-xs text-gray-600 mb-3">Click on a color patch to set this character.</p>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
        <% missing_color_chars.each do |c| %>
          <div class="flex flex-col border rounded p-2 gap-2">
            <div class="min-w-0 font-medium break-words text-sm"><%= c.part&.name %> â€” <%= c.name.to_s.tr("_", " ") %></div>
            <div class="flex items-center text-xs text-gray-700">
              <span class="inline-flex items-center">
                <span class="w-5 h-5 mr-2 rounded border inline-block bg-white"></span>
                Not set
              </span>
            </div>
            <%= form_with url: mr_character_mushrooms_path, method: :post, data: { turbo: true }, html: { class: "mt-1" } do |f| %>
              <%= hidden_field_tag :mushroom_id, @mushroom.id %>
              <%= hidden_field_tag :mr_character_id, c.id %>
              <div class="grid grid-cols-10 gap-1">
                <% (1..50).each do |cid| %>
                  <button type="submit"
                          name="character_value"
                          value="<%= cid %>"
                          title="Color <%= cid %>"
                          class="border rounded p-0.5 focus:ring-2 focus:ring-blue-500">
                    <%= image_tag "AMS_colors/banner_50x50/banner_#{cid}.jpg",
                                  alt: "Color #{cid}",
                                  class: "w-7 h-7 rounded border" %>
                  </button>
                <% end %>
              </div>
              <div class="sr-only"><%= f.submit "Save color" %></div>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <div class="mt-10">
  <% if defined?(policy) && policy(@mushroom).show? %>
    <%= link_to "Show this mushroom", @mushroom, class: "w-full sm:w-auto rounded-md px-2 py-1 bg-blue-600 hover:bg-blue-500 text-white inline-block font-medium cursor-pointer" %>
  <% end %> <p class="text-blue-600">"Show this mushroom" will display all of "set" characters without form options.</p>

  <%= link_to "Back to mushrooms", mushrooms_path, class: "w-full sm:w-auto rounded-md px-2 py-1 bg-blue-600 hover:bg-blue-500 text-white inline-block font-medium cursor-pointer" %>
  </div>
  </div>

