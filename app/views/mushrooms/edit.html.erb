<% content_for :title, "Editing mushroom" %>

<div id="top" class="w-full">
  <h1 class="flex items-baseline gap-2">
    <span class="text-xl font-medium text-gray-700">Editing your mushroom:</span>
    <span class="text-3xl font-bold text-gray-900"><%= @mushroom.name %></span>
  </h1>

  <div class="text-lg font-semibold text-blue-800 mt-2">
    Mushroom ID: <span class="inline-block px-2 py-0.5 rounded bg-blue-50 border border-blue-200"><%= @mushroom.id %></span> <span class="block text-xs text-gray-500">This is the database table ID.</span>
  </div>

  <!-- Clone Characters Panel -->
  <%= render 'clone_characters_panel', mushroom: @mushroom %>

  <!-- Identification Management Section (Prominent) -->
  <div id="identification-section" class="my-5 border-2 border-purple-300 rounded-lg p-4 bg-purple-50">
    <h2 class="text-lg font-semibold text-purple-900 mb-2">üîç Manage Identifications</h2>
    <% identifications = @mushroom.ranked_identifications %>
    <% if identifications.any? %>
      <div class="mb-3">
        <span class="text-sm text-gray-700 font-medium">Current candidates:</span>
        <div class="mt-2 flex flex-wrap gap-2">
          <% identifications.each_with_index do |id, index| %>
            <span class="inline-flex items-center gap-1 bg-white border border-purple-300 rounded px-3 py-1.5 text-sm shadow-sm">
              <span class="font-mono text-purple-600 font-bold"><%= index + 1 %>.</span>
              <em class="text-gray-800">
                <%= id[:genus]&.name&.capitalize || '?' %> <%= id[:species]&.name || '?' %>
              </em>
              <% if id[:fully_primary] %>
                <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <span class="text-xs text-green-700 font-semibold">PRIMARY</span>
              <% end %>
            </span>ra
          <% end %>
        </div>
      </div>
      <button type="button"
              class="bg-purple-600 hover:bg-purple-700 text-white font-medium px-4 py-2 rounded shadow transition"
              onclick="document.getElementById('basic-data-section').open = true; document.getElementById('candidate-panel').classList.remove('hidden'); document.getElementById('candidate-panel').scrollIntoView({behavior: 'smooth', block: 'center'});">
        Edit Candidate Genera/Species
      </button>
      <p class="text-xs text-gray-600 mt-2">
        <strong>Tip:</strong> Remove incorrect candidates to narrow down to your final identification.
      </p>
    <% else %>
      <p class="text-gray-600 mb-3">No identifications added yet. Start by selecting potential genus/species combinations below.</p>
      <button type="button"
              class="bg-purple-600 hover:bg-purple-700 text-white font-medium px-4 py-2 rounded shadow transition"
              onclick="document.getElementById('basic-data-section').open = true; document.getElementById('candidate-panel').classList.remove('hidden'); document.getElementById('candidate-panel').scrollIntoView({behavior: 'smooth', block: 'center'});">
        Add Genus/Species Candidates
      </button>
    <% end %>
  </div>

  <!-- Images Section -->
  <% images = @mushroom.image_mushrooms.select { |im| im.image_file.attached? } %>
  <div class="my-5">
    <div id="images-panel" class="border border-blue-200 rounded p-4 bg-blue-50">
      <% if images.any? %>
        <div class="mb-3">
          <h3 class="text-lg font-semibold text-gray-800 mb-1">Mushroom Images</h3>
          <p class="text-sm text-gray-700 mb-3">
            Click any image to view full size, then see EXIF data or delete image.
          </p>
        </div>

        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
          <% images.each do |image_mushroom| %>
            <div class="border border-gray-300 rounded-lg overflow-hidden bg-white shadow-sm hover:shadow-md transition-shadow">
              <%= link_to image_mushroom_path(image_mushroom), class: "block" do %>
                <div class="aspect-square bg-gray-100">
                  <picture>
                    <%= tag.source(
                          srcset: url_for(
                            image_mushroom.image_file.variant(
                              resize_to_fill: [200, 200],
                              format: :webp,
                              saver: { strip: true, quality: 60, effort: 4 }
                            ).processed
                          ),
                          type: "image/webp"
                        ) %>
                    <%= image_tag(
                          image_mushroom.image_file.variant(
                            resize_to_fill: [200, 200],
                            saver: { strip: true, quality: 72, optimize_coding: true }
                          ).processed,
                          width: 200,
                          height: 200,
                          class: "w-full h-full object-cover block hover:opacity-90 transition-opacity",
                          loading: "lazy",
                          decoding: "async",
                          alt: image_mushroom.image_name.presence || @mushroom.name
                        ) %>
                  </picture>
                </div>
              <% end %>
              <div class="p-2">
                <p class="text-xs font-medium text-gray-700 truncate">
                  <%= image_mushroom.part&.name || "Part not set" %>
                </p>
                <% if image_mushroom.image_name.present? %>
                  <p class="text-xs text-gray-500 truncate" title="<%= image_mushroom.image_name %>">
                    <%= image_mushroom.image_name %>
                  </p>
                <% end %>
                <%= link_to "Edit Image",
                            edit_mushroom_image_mushroom_path(@mushroom, image_mushroom),
                            class: "mt-2 block text-center text-xs px-2 py-1 bg-yellow-100 hover:bg-yellow-200 text-yellow-800 rounded border border-yellow-300" %>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-sm text-gray-700">No images have been uploaded for this mushroom yet. Use the "Upload Image" button above to add your first image.</p>
      <% end %>
    </div>
  </div>

  <!-- Basic Mushroom Data Section -->
  <div class="my-5">
    <details id="basic-data-section" class="border-2 border-blue-500 rounded-lg p-4 bg-blue-100 shadow-md">
      <summary class="font-bold cursor-pointer text-xl text-blue-900 mb-2 hover:text-blue-700 transition">üìù Edit Basic Mushroom Data</summary>
      <%= render 'form', mushroom: @mushroom %>
    </details>
  </div>

  <!-- Entered characters -->
  <% existing_rows = @mushroom.mr_character_mushrooms.includes(mr_character: [:part, :display_option, :source_data]).order('parts.name ASC, mr_characters.name ASC') %>
  <% color_rows = existing_rows.select { |rc| (rc.mr_character&.display_option&.name&.downcase == "color") || rc.mr_character&.display_option_id == 6 } %>
  <% non_color_rows = existing_rows - color_rows %>
  <% existing_grouped = non_color_rows.group_by { |rc| rc.mr_character&.part&.name || "Other" } %>

  <div class="mt-8">
    <h2 class="text-2xl font-semibold mb-3">Entered characters</h2>

    <%# Colors at the top with per-card swatch picker and instruction %>
    <% if color_rows.any? %>
      <details class="bg-white border rounded-md p-4 mb-3" open>
        <summary class="font-semibold cursor-pointer">Colors (<%= color_rows.size %>)</summary>
        <p class="text-xs text-gray-600 mt-2">Click on a color patch to update this character.</p>
        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
          <% color_rows.each do |rc| %>
            <% c = rc.mr_character %>
            <% color_id = rc.character_value.to_i %>
            <% current_color = Color.find_by(id: color_id) %>
            <div class="flex flex-col border rounded p-3 gap-2">
              <div class="min-w-0 font-medium break-words"><%= c&.name.to_s.tr("_", " ") %></div>
              <div class="flex items-center text-sm text-gray-700">
                <%= image_tag "AMS_colors/banner_50x50/banner_#{color_id}.jpg",
                              alt: "Color #{color_id}",
                              class: "w-6 h-6 mr-2 rounded border" %>
                <% if current_color %>
                  <span><%= current_color.latin_name %> (<%= current_color.common_name %>)</span>
                <% else %>
                  <span>Color ID: <%= color_id %></span>
                <% end %>
              </div>
              <%= form_with url: mr_character_mushrooms_path, method: :post, data: { turbo: true }, html: { class: "mt-1" } do |f| %>
                <%= hidden_field_tag :mushroom_id, @mushroom.id %>
                <%= hidden_field_tag :mr_character_id, c.id %>
                <div class="grid grid-cols-10 gap-1">
                  <% (1..50).each do |cid| %>
                    <button type="submit"
                            name="character_value"
                            value="<%= cid %>"
                            title="Color <%= cid %>"
                            class="border rounded p-0.5 focus:ring-2 focus:ring-blue-500">
                      <%= image_tag "AMS_colors/banner_50x50/banner_#{cid}.jpg",
                                    alt: "Color #{cid}",
                                    class: "w-7 h-7 rounded border" %>
                    </button>
                  <% end %>
                </div>
                <div class="sr-only"><%= f.submit "Update color" %></div>
              <% end %>
            </div>
          <% end %>
        </div>
      </details>
    <% end %>

    <% if non_color_rows.any? %>
      <details class="bg-white border rounded-md p-4 mb-3" open>
        <summary class="font-semibold cursor-pointer">Entered Characters (<%= non_color_rows.size %>)</summary>
        <p class="text-xs text-gray-600 mt-2 mb-3">Click "Edit" to modify a character's value inline.</p>
        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
          <% non_color_rows.each do |rc| %>
            <%= render partial: "entered_character_card", locals: { character_mushroom: rc } %>
          <% end %>
        </div>
      </details>
    <% else %>
      <% unless color_rows.any? %>
        <p class="text-gray-500">No characters entered yet.</p>
      <% end %>
    <% end %>
  </div>

  <!-- Not entered (non-colors only) %>
  <%# PERFORMANCE FIX: Only load these if needed - uses cached version %>
  <%# FUNGUS TYPE FILTERING: Only show characters for this mushroom's fungus type %>
  <% if params[:show_all_characters] == "true" || params[:show_part].present? %>
    <% if @mushroom.fungus_type_id.present? %>
      <% all_chars = MrCharacter.cached_for_fungus_type(@mushroom.fungus_type_id) %>
    <% else %>
      <% all_chars = MrCharacter.cached_all_with_associations %>
    <% end %>
    <% entered_ids = existing_rows.map(&:mr_character_id).to_set %>
    <% color_chars = all_chars.select { |c| (c.display_option&.name&.downcase == "color") || c.display_option_id == 6 } %>
    <% missing_chars = all_chars.reject { |c|
          entered_ids.include?(c.id) ||
          color_chars.include?(c) ||
          ((c.display_option&.name&.downcase == "do not display") || c.display_option_id == 1)
        } %>

    <%# Filter by part if show_part parameter is present %>
    <% if params[:show_part].present? && params[:show_part] != "Other" %>
      <% missing_chars = missing_chars.select { |c| c.part&.name == params[:show_part] } %>
    <% elsif params[:show_part] == "Other" %>
      <%# "Other" includes all parts with fewer characters %>
      <% other_parts = ["Mycelium", "Veil", "Spores", "Habitat", "Location", "Identification", "Admin", "Rhizomorph", "Color", "Storage"] %>
      <% missing_chars = missing_chars.select { |c| other_parts.include?(c.part&.name) } %>
    <% end %>

    <% missing_grouped = missing_chars.group_by { |c| c.part&.name || "Other" } %>
  <% else %>
    <% missing_chars = [] %>
    <% missing_grouped = {} %>
  <% end %>

  !-- Character Search -->
  <div class="mt-8 bg-purple-50 lg:bg-purple-100 border border-purple-400 rounded-md p-4 mb-4">
    <h3 class="text-lg font-semibold text-black-900 mb-2">üîç Search for a Character</h3>
    <% if @mushroom.fungus_type_id.present? %>
      <% char_count = MrCharacter.for_fungus_type(@mushroom.fungus_type_id).count %>
      <p class="text-sm text-gray-600 mb-3">
        Can't find what you're looking for? Search across <%= char_count %> characters for <%= @mushroom.fungus_type.name %> mushrooms.
      </p>
    <% else %>
      <p class="text-sm text-amber-700 bg-amber-50 border border-amber-300 rounded px-3 py-2 mb-3">
        ‚ö†Ô∏è <strong>Tip:</strong> Set your mushroom's <strong>Fungus Type</strong> in "Edit Basic Mushroom Data" above to see only relevant characters for your fungus type.
        Currently showing all <%= MrCharacter.count %> characters.
      </p>
    <% end %>

    <div class="relative" data-controller="character-search"
         data-character-search-mushroom-id-value="<%= @mushroom.id %>">
      <input type="text"
             placeholder="Type at least 3 characters (e.g., 'pileus', 'color', 'taste', 'shape')..."
             class="w-full border border-purple-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-purple-500"
             data-character-search-target="input"
             minlength="3"
             autocomplete="off">

      <div data-character-search-target="loader" class="hidden absolute right-3 top-1/2 transform -translate-y-1/2">
        <svg class="animate-spin h-5 w-5 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      </div>

      <ul class="hidden border border-purple-300 rounded-lg mt-2 bg-white max-h-96 overflow-auto shadow-xl"
          data-character-search-target="dropdown"
          style="position: absolute; z-index: 50; width: 100%;"></ul>
    </div>

    <p class="text-xs text-gray-500 mt-2">
      üí° Tip: Search results will load the relevant part section and show the character.
    </p>
  </div>

  <!-- NEW CHARACTER NAVIGATION GRID -->
  <%= render 'character_navigation_grid', mushroom: @mushroom %>

  <!-- Back to top link -->
  <div class="mt-8 pt-4 border-t border-gray-300 text-center">
    <a href="#top" class="inline-block px-4 py-2 rounded bg-gray-600 hover:bg-gray-700 text-white font-medium transition">
      ‚Üë Back to Top
    </a>
  </div>

  <!-- Toggle character edit form -->
  <script>
    function toggleCharacterEdit(button) {
      // Find the parent card
      const card = button.closest('[data-character-id]');
      if (!card) return;

      // Find the compact view and edit form
      const compactView = card.querySelector('.compact-view');
      const editForm = card.querySelector('.edit-form');

      if (!compactView || !editForm) return;

      // Toggle visibility
      if (editForm.classList.contains('hidden')) {
        // Show edit form, hide compact view
        compactView.classList.add('hidden');
        editForm.classList.remove('hidden');
      } else {
        // Hide edit form, show compact view
        editForm.classList.add('hidden');
        compactView.classList.remove('hidden');
      }
    }
  </script>

  <!-- Scroll to character from search -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const characterId = sessionStorage.getItem('scrollToCharacter');
      if (characterId) {
        // Find the character row by data attribute
        const characterRow = document.querySelector(`[data-character-id="${characterId}"]`);

        if (characterRow) {
          // Wait a brief moment for the details section to fully render
          setTimeout(() => {
            // Scroll to the character with smooth animation
            characterRow.scrollIntoView({
              behavior: 'smooth',
              block: 'center'
            });

            // Add highlight if requested
            if (sessionStorage.getItem('highlightCharacter')) {
              // Add yellow ring and background
              characterRow.classList.add('ring-4', 'ring-yellow-400', 'bg-yellow-50');

              // Remove highlight after 3 seconds
              setTimeout(() => {
                characterRow.classList.remove('ring-4', 'ring-yellow-400', 'bg-yellow-50');
              }, 3000);
            }
          }, 300); // Small delay to ensure details is open
        }

        // Clear sessionStorage after use
        sessionStorage.removeItem('scrollToCharacter');
        sessionStorage.removeItem('highlightCharacter');
      }
    });
  </script>

  <!-- Toggle panel function -->
  <script>
    function togglePanel(panelId) {
      const panel = document.getElementById(panelId);
      if (panel) {
        panel.classList.toggle('hidden');
      } else {
        console.error('Panel not found:', panelId);
      }
    }

    // Auto-open candidate panel if URL parameter is present
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('open_panel') === 'true') {
        // Open the details section
        document.getElementById('basic-data-section').open = true;
        // Show the candidate panel
        document.getElementById('candidate-panel').classList.remove('hidden');
        // Scroll to the candidate panel
        setTimeout(() => {
          document.getElementById('candidate-panel').scrollIntoView({behavior: 'smooth', block: 'center'});
        }, 100);
      }
    });
  </script>
</div>