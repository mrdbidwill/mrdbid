<% content_for :title, "Advanced Search" %>

<div class="w-full">
  <div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">üîç Advanced Mushroom Search</h1>
    <p class="text-gray-700">Search your collection by text, fungus type, and specific character values.</p>
  </div>

  <!-- Search Form -->
  <%= form_with url: mushroom_search_index_path, method: :get, local: true, html: { class: "bg-white border-2 border-blue-300 rounded-lg p-6 mb-6 shadow-lg" } do |f| %>
    <!-- Text Search -->
    <div class="mb-4">
      <label class="block text-sm font-semibold text-gray-700 mb-2">
        Search by text (name, description, comments)
      </label>
      <%= text_field_tag :q, @query,
            placeholder: "Enter keywords...",
            class: "w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500" %>
    </div>

    <!-- Fungus Type Filter -->
    <div class="mb-4">
      <label class="block text-sm font-semibold text-gray-700 mb-2">
        Filter by fungus type
      </label>
      <%= select_tag :fungus_type_id,
            options_for_select([["All Types", ""]] + @fungus_types.map { |ft| [ft.name, ft.id] }, @fungus_type_id),
            class: "w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500" %>
    </div>

    <!-- Character Filters (Faceted Search) -->
    <details class="mb-4" <%= 'open' if @character_filters.any? %>>
      <summary class="font-semibold text-gray-700 cursor-pointer mb-3">
        ‚ûï Filter by character values (advanced)
      </summary>

      <div class="space-y-3 pl-4 border-l-2 border-blue-200">
        <p class="text-sm text-gray-600 mb-2">
          Add specific character values to narrow down results. For example, "Cap color = red" or "Gill attachment = free"
        </p>

        <div id="character-filters">
          <% if @character_filters.any? %>
            <% @character_filters.each_with_index do |(char_id, value), index| %>
              <% character = MrCharacter.find_by(id: char_id) %>
              <% next unless character %>
              <div class="flex gap-2 mb-2 character-filter-row">
                <%= select_tag "characters[#{char_id}]",
                      options_from_collection_for_select(@common_characters, :id, :name, char_id),
                      class: "flex-1 border border-gray-300 rounded px-3 py-2" %>
                <%= text_field_tag "characters[#{char_id}]", value,
                      placeholder: "Value",
                      class: "w-48 border border-gray-300 rounded px-3 py-2" %>
                <button type="button" onclick="this.parentElement.remove()"
                        class="px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded">
                  Remove
                </button>
              </div>
            <% end %>
          <% end %>
        </div>

        <button type="button" onclick="addCharacterFilter()"
                class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium">
          + Add Character Filter
        </button>
      </div>
    </details>

    <!-- Submit Button -->
    <div class="flex gap-3">
      <%= f.submit "Search", class: "px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md transition" %>
      <%= link_to "Clear Filters", mushroom_search_index_path, class: "px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold rounded-lg transition" %>
    </div>
  <% end %>

  <!-- Results -->
  <div class="mb-4">
    <% if @query.present? || @fungus_type_id.present? || @character_filters.any? %>
      <h2 class="text-xl font-semibold text-gray-900 mb-3">
        Search Results (<%= @mushrooms.total_count %>)
      </h2>

      <% if @mushrooms.any? %>
        <%= render "shared/pagination", collection: @mushrooms %>

        <div class="space-y-3">
          <% @mushrooms.each do |mushroom| %>
            <%= link_to mushroom_path(mushroom), class: "block bg-white border rounded-lg p-4 hover:shadow-lg transition" do %>
              <div class="flex items-start gap-4">
                <% if mushroom.image_mushrooms.any? && mushroom.image_mushrooms.first.image_file.attached? %>
                  <div class="w-24 h-24 flex-shrink-0 overflow-hidden rounded border">
                    <%= image_tag(
                          url_for(mushroom.image_mushrooms.first.image_file.variant(
                            resize_to_fill: [96, 96],
                            format: :webp,
                            saver: { strip: true, quality: 60, effort: 4 }
                          )),
                          class: "w-full h-full object-cover",
                          loading: "lazy"
                        ) %>
                  </div>
                <% end %>

                <div class="flex-1 min-w-0">
                  <h3 class="text-lg font-semibold text-gray-900">
                    <%= mushroom.name %>
                  </h3>

                  <% if mushroom.fungus_type %>
                    <span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded mt-1">
                      <%= mushroom.fungus_type.name %>
                    </span>
                  <% end %>

                  <% if mushroom.genera.any? && mushroom.species.any? %>
                    <p class="text-sm text-gray-600 mt-2">
                      <em><%= mushroom.genera.first.name %> <%= mushroom.species.first.name %></em>
                    </p>
                  <% end %>

                  <% if mushroom.description.present? %>
                    <p class="text-sm text-gray-700 mt-1">
                      <%= truncate(mushroom.description, length: 150) %>
                    </p>
                  <% end %>

                  <p class="text-xs text-gray-500 mt-2">
                    <%= mushroom.mr_character_mushrooms.count %> characters entered
                  </p>
                </div>
              </div>
            <% end %>
          <% end %>
        </div>

        <%= render "shared/pagination", collection: @mushrooms %>
      <% else %>
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
          <p class="text-yellow-800">No mushrooms found matching your search criteria.</p>
          <p class="text-sm text-yellow-700 mt-2">Try adjusting your filters or search terms.</p>
        </div>
      <% end %>
    <% else %>
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 text-center">
        <svg class="w-16 h-16 mx-auto text-blue-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <p class="text-blue-900 font-medium">Enter search criteria above to find mushrooms in your collection.</p>
      </div>
    <% end %>
  </div>
</div>

<script>
  let filterCount = <%= @character_filters.keys.count %>;

  function addCharacterFilter() {
    const container = document.getElementById('character-filters');
    const newRow = document.createElement('div');
    newRow.className = 'flex gap-2 mb-2 character-filter-row';
    filterCount++;

    newRow.innerHTML = `
      <select name="characters[new_${filterCount}][character_id]" class="flex-1 border border-gray-300 rounded px-3 py-2">
        <option value="">-- Select Character --</option>
        <% @common_characters.each do |char| %>
          <option value="<%= char.id %>"><%= char.name.tr('_', ' ') %></option>
        <% end %>
      </select>
      <input type="text" name="characters[new_${filterCount}][value]" placeholder="Value"
             class="w-48 border border-gray-300 rounded px-3 py-2">
      <button type="button" onclick="this.parentElement.remove()"
              class="px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded">
        Remove
      </button>
    `;

    container.appendChild(newRow);
  }
</script>
