<% content_for :title, "Compare #{@mushroom.name}" %>
<div class="w-full">
  <%= render "shared/page_actions",
        left: content_tag(:h1, "Compare: #{@mushroom.name}", class: "title-xl"),
        right: link_to("Back to Mushroom", mushroom_path(@mushroom), class: "btn-primary").html_safe
  %>

  <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded">
    <h2 class="font-semibold text-lg mb-2">About Comparisons</h2>
    <p class="text-sm text-gray-700 mb-2">
      This feature compares your mushroom against all others based on character traits
      (cap color, spore color, habitat, etc.). Results show similarity as a percentage.
    </p>
    <p class="text-sm text-gray-600">
      <strong>Character Count:</strong> <%= @character_count %> / <%= @minimum_characters %> required
    </p>
  </div>

  <% if @character_count < @minimum_characters %>
    <div class="p-4 bg-yellow-50 border border-yellow-300 rounded mb-4">
      <p class="text-yellow-800">
        This mushroom needs at least <%= @minimum_characters %> characters to perform meaningful comparisons.
        Please <%= link_to "edit the mushroom", edit_mushroom_path(@mushroom), class: "underline" %>
        and add more character traits.
      </p>
    </div>
  <% else %>
    <% if @comparisons.empty? && @pending_count == 0 %>
      <div class="mb-4 p-4 bg-gray-50 border border-gray-300 rounded">
        <p class="text-gray-700 mb-3">No comparisons have been run yet for this mushroom.</p>
        <%= button_to "Start Comparison", mushroom_mushroom_comparisons_path(mushroom_id: @mushroom.id),
                      method: :post,
                      class: "btn-primary",
                      data: { confirm: "This will compare against all other mushrooms. Continue?" } %>
      </div>
    <% elsif @pending_count > 0 %>
      <div class="mb-4 p-4 bg-blue-50 border border-blue-300 rounded">
        <p class="text-blue-800 mb-2">
          <strong>Comparison in progress...</strong> (<%= @pending_count %> pending)
        </p>
        <p class="text-sm text-blue-600">Refresh this page to see updated results.</p>
        <%= link_to "Refresh", mushroom_mushroom_comparisons_path(mushroom_id: @mushroom.id), class: "btn-primary mt-2" %>
      </div>
    <% end %>

    <% if @comparisons.any? %>
      <div class="mb-4 flex justify-between items-center">
        <h2 class="text-xl font-semibold">Comparison Results (<%= @comparisons.total_count %>)</h2>
        <%= button_to "Re-run Comparison", mushroom_mushroom_comparisons_path(mushroom_id: @mushroom.id),
                      method: :post,
                      class: "btn-secondary",
                      data: { confirm: "This will re-compare against all mushrooms. Continue?" } %>
      </div>

      <%= render "shared/pagination", collection: @comparisons %>

      <div class="overflow-x-auto">
        <table class="min-w-full bg-white border border-gray-300">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Mushroom</th>
              <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Owner</th>
              <th class="px-4 py-2 text-center text-sm font-semibold text-gray-700">Similarity</th>
              <th class="px-4 py-2 text-center text-sm font-semibold text-gray-700">Matches</th>
              <th class="px-4 py-2 text-center text-sm font-semibold text-gray-700">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @comparisons.each do |comparison| %>
              <% next unless comparison.compared_mushroom %>
              <tr class="border-t hover:bg-gray-50">
                <td class="px-4 py-3">
                  <%= link_to comparison.compared_mushroom.name,
                              mushroom_path(comparison.compared_mushroom),
                              class: "text-blue-600 hover:underline font-medium" %>
                  <% if comparison.compared_mushroom.fungus_type %>
                    <br><span class="text-xs text-gray-500"><%= comparison.compared_mushroom.fungus_type.name %></span>
                  <% end %>
                </td>
                <td class="px-4 py-3 text-sm text-gray-600">
                  <%= comparison.compared_mushroom.user&.email || 'N/A' %>
                </td>
                <td class="px-4 py-3 text-center">
                  <% color_class = if comparison.similarity_score >= 75
                                     "bg-green-100 text-green-800"
                                   elsif comparison.similarity_score >= 50
                                     "bg-yellow-100 text-yellow-800"
                                   else
                                     "bg-red-100 text-red-800"
                                   end %>
                  <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold <%= color_class %>">
                    <%= comparison.similarity_score %>%
                  </span>
                </td>
                <td class="px-4 py-3 text-center text-sm text-gray-600">
                  <%= comparison.matching_characters %> / <%= comparison.total_characters %>
                </td>
                <td class="px-4 py-3 text-center">
                  <%= link_to "Details", mushroom_comparison_path(comparison), class: "text-blue-600 hover:underline text-sm" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <%= render "shared/pagination", collection: @comparisons %>
    <% end %>
  <% end %>
</div>
