<% content_for :title, "lookup_items" %>

<style>
    /* More spacing between pagination items and bigger click targets */
    .pagination { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; }
    .pagination a, .pagination span {
        padding: 0.375rem 0.625rem; /* ~py-1.5 px-2.5 */
        border-radius: 0.375rem;    /* ~rounded-md */
    }
</style>

<div class="w-full">
  <% if notice.present? %>
    <p class="py-1 px-3 bg-green-50 mb-5 text-green-500 font-medium rounded-md inline-block" id="notice"><%= notice %></p>
  <% end %>

  <!-- Filter card -->
  <div class="group-box mb-6">
    <div class="group-header">
      Filter Lookup Items by Character
      <p class="hint mt-1">Choose a character from the dropdown, then click "Apply Filter" to view or edit its lookup items. Does not affect search below.</p>
    </div>
    <div class="px-4 py-4">
      <%= form_with url: admin_lookup_items_path, method: :get, local: true, class: "grid grid-cols-1 gap-4" do |form| %>
        <div class="form-field">
          <%= form.label :mr_character_id, "Mushroom Character", class: "form-label" %>
          <%= form.select :mr_character_id,
                          @mr_characters,
                          { include_blank: "All Characters" },
                          class: "form-input",
                          style: "width: 70%; padding: 0.5rem; box-shadow: 0 0 0 1px rgba(0,0,0,0.06), 0 0 10px 2px rgba(0,0,0,0.12), 0 0 24px 6px rgba(0,0,0,0.12);" %>
          <p class="form-help">Select a character to filter lookup items, or leave blank to see all.</p>
        </div>

        <div class="flex gap-2">
          <%= form.submit "Apply Filter", class: "btn-primary" %>
          <%= link_to "Reset", admin_lookup_items_path, class: "btn" %>
        </div>
      <% end %>
    </div>

    <!-- Current filter summary -->
    <div class="well">
      <% if params[:mr_character_id].present? %>
        <div class="flex flex-wrap items-center gap-2 text-sm">
          <span class="text-gray-700 font-medium">Currently showing:</span>
          <span class="inline-flex items-center gap-1 rounded-full bg-green-50 text-green-700 px-2.5 py-1">
            <span class="font-medium">Character:</span>
            <span><%= MrCharacter.find_by(id: params[:mr_character_id])&.name %></span>
          </span>
          <%= link_to "Change", "#", class: "ml-auto text-blue-700 hover:underline", onclick: "document.querySelector('form[action=\"#{admin_lookup_items_path}\"]').scrollIntoView({behavior:'smooth'})" %>
        </div>
      <% else %>
        <p class="muted">No filter applied. Showing all lookup items.</p>
      <% end %>
    </div>
  </div>
  <!-- End Filter card -->

  <!-- Search card -->
  <div class="group-box mb-6" style="border: 2px solid #9333ea;">
    <div class="group-header" style="background-color: #f3e8ff;">
      Search for a Specific Character
      <p class="hint mt-1"><strong>Search ignores the character filter above.</strong> Enter a character name (partial match) or character ID to find all lookup items for that character.</p>
    </div>
    <div class="px-4 py-1">
      <%= form_with url: admin_lookup_items_path, method: :get, local: true, class: "grid grid-cols-1 gap-2 sm:grid-cols-3 items-end" do %>
        <div class="form-field sm:col-span-2">
          <label for="q" class="form-label">Character Name or ID</label>
          <%= text_field_tag :q, params[:q], placeholder: "e.g. 'Cap surface' or 3",
                             class: "form-input",
                             style: "padding: 0.5rem; box-shadow: 0 0 0 1px rgba(0,0,0,0.06), 0 0 10px 2px rgba(0,0,0,0.12), 0 0 24px 6px rgba(0,0,0,0.12);" %>
          <p class="form-help">Search for characters to see their lookup items. Partial character name matches OK. Enter number for exact character ID match.</p>
        </div>
        <div class="flex gap-2">
          <%= submit_tag "Search", class: "btn-primary" %>
          <%= link_to "Clear Search", admin_lookup_items_path, class: "btn" %>
        </div>
      <% end %>
    </div>

    <!-- Current search summary -->
    <div class="well">
      <% if params[:q].present? %>
        <div class="flex flex-wrap items-center gap-2 text-sm">
          <span class="text-gray-700 font-medium">Character Search:</span>
          <span class="inline-flex items-center gap-1 rounded-full bg-purple-50 text-purple-700 px-2.5 py-1">
            <span class="font-medium">Query:</span>
            <span><%= params[:q] %></span>
          </span>
          <%= link_to "Clear", admin_lookup_items_path(request.query_parameters.except(:q)), class: "ml-auto text-blue-700 hover:underline" %>
        </div>
      <% else %>
        <p class="muted">No character search applied.</p>
      <% end %>
    </div>
  </div>
  <!-- End Search card -->

  <div class="flex justify-between items-center">
    <h1 class="font-bold text-2xl">Lookup Items</h1>
    <%= link_to "Back to Admin Dashboard", admin_root_path, class: "rounded-md px-2 py-1 bg-gray-600 hover:bg-gray-500 text-white block font-medium" %>
    <%= link_to "New Lookup Item", new_admin_lookup_item_path, class: "rounded-md px-2 py-1 bg-blue-600 hover:bg-blue-500 text-white block font-medium" %>
  </div>

  <%# TOP pagination %>
  <% if @lookup_items.any? %>
    <div class="my-1 flex flex-wrap items-center gap-4">
      <%= paginate @lookup_items,
                   theme: 'tailwind_bar',
                   params: request.query_parameters,
                   window: 2,        # how many pages around current
                   outer_window: 1   # how many pages at the ends
      %>
      <div class="flex items-center gap-2">
        <%= form_with url: admin_lookup_items_path, method: :get, local: true, class: "flex items-center gap-2" do |form| %>
          <%= label_tag :page, "Go to page:", class: "text-sm font-medium text-gray-700" %>
          <%= number_field_tag :page, params[:page], min: 1, max: @lookup_items.total_pages, class: "form-input w-20 px-2 py-1 border border-gray-300 rounded-md" %>
          <%= hidden_field_tag :q, params[:q] if params[:q].present? %>
          <%= hidden_field_tag :mr_character_id, params[:mr_character_id] if params[:mr_character_id].present? %>
          <%= form.submit "Go", class: "btn-primary px-3 py-1" %>
        <% end %>
        <span class="text-sm text-gray-600">of <%= @lookup_items.total_pages %></span>
      </div>
    </div>
  <% end %>

  <div id="lookup_items" class="min-w-full divide-y divide-gray-100 space-y-5">
    <% if params[:q].present? && @searched_characters.present? %>
      <%# When searching, show ALL matching characters, even those without lookup items %>
      <% @searched_characters.each do |mr_character| %>
        <% character_items = @lookup_items.select { |item| item.mr_character_id == mr_character.id } %>
        <div class="my-10">
          <h2 class="font-bold text-2xl mb-2">
            <%= mr_character.name %> (ID: <%= mr_character.id %>)
          </h2>
          <% if character_items.any? %>
            <div class="overflow-x-auto">
              <table class="min-w-full table-auto border border-gray-100 mb-8">
                <thead>
                <tr>
                  <th class="px-2 py-1">Name</th>
                  <th class="px-2 py-1">Description</th>
                  <th class="px-2 py-1">Comments</th>
                  <th class="px-2 py-1">Actions</th>
                </tr>
                </thead>
                <tbody>
                <% character_items.each do |lookup_item| %>
                  <tr id="<%= dom_id lookup_item %>">
                    <td class="border px-2 py-1"><%= lookup_item.name %></td>
                    <td class="border px-2 py-1"><%= lookup_item.description %></td>
                    <td class="border px-2 py-1"><%= lookup_item.comments %></td>
                    <td class="border px-2 py-1 whitespace-nowrap">
                      <div class="w-full sm:w-auto flex flex-col sm:flex-row gap-2">
                        <%= link_to "Show", admin_lookup_item_path(lookup_item), class: "btn-primary btn-responsive" %>
                        <%= link_to "Edit", edit_admin_lookup_item_path(lookup_item, q: params[:q], page: params[:page]), class: "btn-primary btn-responsive" %>
                        <% if current_user&.owner? %>
                          <%= button_to "Delete", admin_lookup_item_path(lookup_item), method: :delete, class: "btn-responsive inline-flex items-center justify-center text-sm font-medium text-white bg-red-600 hover:bg-red-500 rounded-md px-2 py-1", data: { turbo_confirm: "Are you sure you want to delete this lookup item?" } %>
                        <% end %>
                      </div>
                    </td>
                  </tr>
                <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <p class="text-gray-600 italic mb-4">No lookup items yet for this character. <%= link_to "Add one", new_admin_lookup_item_path(mr_character_id: mr_character.id), class: "text-blue-600 hover:underline" %></p>
          <% end %>
        </div>
      <% end %>
    <% elsif @lookup_items.any? %>
      <%# Normal browsing/filtering mode %>
      <% @lookup_items.group_by(&:mr_character).each do |mr_character, items| %>
        <div class="my-10">
          <h2 class="font-bold text-2xl mb-2">
            <%= mr_character&.name || 'Unassigned Character' %>
          </h2>
          <div class="overflow-x-auto">
            <table class="min-w-full table-auto border border-gray-100 mb-8">
              <thead>
              <tr>
                <th class="px-2 py-1">Name</th>
                <th class="px-2 py-1">Description</th>
                <th class="px-2 py-1">Comments</th>
                <th class="px-2 py-1">Actions</th>
              </tr>
              </thead>
              <tbody>
              <% items.each do |lookup_item| %>
                <tr id="<%= dom_id lookup_item %>">
                  <td class="border px-2 py-1"><%= lookup_item.name %></td>
                  <td class="border px-2 py-1"><%= lookup_item.description %></td>
                  <td class="border px-2 py-1"><%= lookup_item.comments %></td>
                  <td class="border px-2 py-1 whitespace-nowrap">
                    <div class="w-full sm:w-auto flex flex-col sm:flex-row gap-2">
                      <%= link_to "Show", admin_lookup_item_path(lookup_item), class: "btn-primary btn-responsive" %>
                      <%= link_to "Edit", edit_admin_lookup_item_path(lookup_item, mr_character_id: params[:mr_character_id], page: params[:page]), class: "btn-primary btn-responsive" %>
                      <% if current_user&.owner? %>
                        <%= button_to "Delete", admin_lookup_item_path(lookup_item), method: :delete, class: "btn-responsive inline-flex items-center justify-center text-sm font-medium text-white bg-red-600 hover:bg-red-500 rounded-md px-2 py-1", data: { turbo_confirm: "Are you sure you want to delete this lookup item?" } %>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
              </tbody>
            </table>
          </div>
        </div>
      <% end %>

      <div class="mt-3">
        <!-- Pagination links (BOTTOM) -->
        <% if @lookup_items.any? %>
          <div class="my-1 flex flex-wrap items-center gap-4">
            <%= paginate @lookup_items,
                         theme: 'tailwind_bar',
                         params: request.query_parameters,
                         window: 2,        # how many pages around current
                         outer_window: 1   # how many pages at the ends
            %>
            <div class="flex items-center gap-2">
              <%= form_with url: admin_lookup_items_path, method: :get, local: true, class: "flex items-center gap-2" do |form| %>
                <%= label_tag :page, "Go to page:", class: "text-sm font-medium text-gray-700" %>
                <%= number_field_tag :page, params[:page], min: 1, max: @lookup_items.total_pages, class: "form-input w-20 px-2 py-1 border border-gray-300 rounded-md" %>
                <%= hidden_field_tag :q, params[:q] if params[:q].present? %>
                <%= hidden_field_tag :mr_character_id, params[:mr_character_id] if params[:mr_character_id].present? %>
                <%= form.submit "Go", class: "btn-primary px-3 py-1" %>
              <% end %>
              <span class="text-sm text-gray-600">of <%= @lookup_items.total_pages %></span>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-center my-10 text-2xl text-red-600">
        <% if params[:q].present? %>
          No characters found matching "<%= params[:q] %>".
        <% else %>
          No lookup items found.
        <% end %>
      </p>
    <% end %>
  </div>
</div>
