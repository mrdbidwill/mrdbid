<% content_for :title, "Mushroom Characters" %>

<style>
    /* More spacing between pagination items and bigger click targets */
    .pagination { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; }
    .pagination a, .pagination span {
        padding: 0.375rem 0.625rem; /* ~py-1.5 px-2.5 */
        border-radius: 0.375rem;    /* ~rounded-md */
    }
</style>

<div class="w-full">
  <% if notice.present? %>
    <p class="py-1 px-3 bg-green-50 mb-5 text-green-500 font-medium rounded-md inline-block" id="notice"><%= notice %></p>
  <% end %>

  <div class="mb-6">
    <p class="text-sm text-red-600 border-l-4 border-red-600 p-2">
      The character's form still needs some work, but it is important they be seen by expert users so that you can fix any mistakes and add more information.
    </p>
  </div>

  <!-- Filter card -->
  <div class="group-box mb-6">
    <div class="group-header">
      Filter Mushroom Characters
      <p class="hint mt-1">Start by selecting a Part to narrow Lookup Types, or choose both. Click Apply Filter to update results.</p>
    </div>
    <div class="px-4 py-4">
      <%= form_with url: admin_mr_characters_path, method: :get, local: true, class: "grid grid-cols-1 gap-4 lg:grid-cols-3 lg:gap-12" do |form| %>
        <div class="form-field">
          <%= form.label :part_id, "Part", class: "form-label" %>
          <%= form.select :part_id,
                          @parts,
                          { include_blank: "All" },
                          class: "form-input",
                          style: "width: 70%; padding: 0.5rem; box-shadow: 0 0 0 1px rgba(0,0,0,0.06), 0 0 10px 2px rgba(0,0,0,0.12), 0 0 24px 6px rgba(0,0,0,0.12);" %>
          <p class="form-help">Select a part first to filter lookup types.</p>
        </div>

        <div class="form-field">
          <%= form.label :lookup_type_id, "Lookup Type", class: "form-label" %>
          <%= form.select :lookup_type_id,
                          @lookup_types,
                          { include_blank: "All" },
                          class: "form-input",
                          style: "width: 85%; padding: 0.5rem; box-shadow: 0 0 0 1px rgba(0,0,0,0.06), 0 0 10px 2px rgba(0,0,0,0.12), 0 0 24px 6px rgba(0,0,0,0.12);" %>
          <p class="form-help">Filtered by part selection above.</p>
        </div>

        <div class="flex items-end gap-2">
          <%= form.submit "Apply Filter", class: "btn-primary" %>
          <%= link_to "Reset", admin_mr_characters_path, class: "btn" %>
        </div>
      <% end %>
    </div>

    <!-- Current filter summary -->
    <%# Safely compute human-friendly names for summary %>
    <% selected_lookup_type = params[:lookup_type_id].presence && LookupType.find_by(id: params[:lookup_type_id]) %>
    <% part_name_by_id = (@parts || []).each_with_object({}) { |(name, id), h| h[id.to_s] = name } %>
    <% selected_part_name = params[:part_id].presence && part_name_by_id[params[:part_id].to_s] %>

    <div class="well">
      <% if params[:part_id].present? || params[:lookup_type_id].present? %>
        <div class="flex flex-wrap items-center gap-2 text-sm">
          <span class="text-gray-700 font-medium">Currently showing:</span>
          <span class="inline-flex items-center gap-1 rounded-full bg-green-50 text-green-700 px-2.5 py-1">
            <span class="font-medium">Part:</span>
            <span><%= selected_part_name || "All" %></span>
          </span>
          <span class="inline-flex items-center gap-1 rounded-full bg-blue-50 text-blue-700 px-2.5 py-1">
            <span class="font-medium">Lookup Type:</span>
            <span><%= selected_lookup_type&.name || "All" %></span>
          </span>
          <%= link_to "Change", "#", class: "ml-auto text-blue-700 hover:underline", onclick: "document.querySelector('form[action=\"#{admin_mr_characters_path}\"]').scrollIntoView({behavior:'smooth'})" %>
        </div>
      <% else %>
        <p class="muted">No filters applied. Showing all characters.</p>
      <% end %>
    </div>
  </div>
  <!-- End Filter card -->

  <!-- Search card -->
  <div class="group-box mb-6">
    <div class="group-header">
      Search Characters
      <p class="hint mt-1">Search by name or ID. Press Enter or click Search.</p>
    </div>
    <div class="px-4 py-1">
      <%= form_with url: admin_mr_characters_path, method: :get, local: true, class: "grid grid-cols-1 gap-2 sm:grid-cols-3 items-end" do %>
        <%= hidden_field_tag :lookup_type_id, params[:lookup_type_id] if params[:lookup_type_id].present? %>
        <%= hidden_field_tag :part_id, params[:part_id] if params[:part_id].present? %>
        <div class="form-field sm:col-span-2">
          <label for="q" class="form-label">Name or ID</label>
          <%= text_field_tag :q, params[:q], placeholder: "e.g. 'Cap surface' or 1234",
                             class: "form-input",
                             style: "padding: 0.5rem; box-shadow: 0 0 0 1px rgba(0,0,0,0.06), 0 0 10px 2px rgba(0,0,0,0.12), 0 0 24px 6px rgba(0,0,0,0.12);" %>%>
          <p class="form-help">Partial matches allowed for names. Use a number to search by ID.</p>
        </div>
        <div class="flex gap-2">
          <%= submit_tag "Search", class: "btn-primary" %>
          <%= link_to "Reset", admin_mr_characters_path, class: "btn" %>
        </div>
      <% end %>
    </div>

    <!-- Current search summary -->
    <div class="well">
      <% if params[:q].present? %>
        <div class="flex flex-wrap items-center gap-2 text-sm">
          <span class="text-gray-700 font-medium">Search:</span>
          <span class="inline-flex items-center gap-1 rounded-full bg-purple-50 text-purple-700 px-2.5 py-1">
            <span class="font-medium">Query:</span>
            <span><%= params[:q] %></span>
          </span>
          <%= link_to "Clear", admin_mr_characters_path(request.query_parameters.except(:q)), class: "ml-auto text-blue-700 hover:underline" %>
        </div>
      <% else %>
        <p class="muted">No search applied.</p>
      <% end %>
    </div>
  </div>
  <!-- End Search card -->


  <div class="flex justify-between items-center">
    <h1 class="font-bold text-2xl">Mushroom Characters</h1>
    <%= link_to "Back to Admin Dashboard", admin_root_path, class: "rounded-md px-2 py-1 bg-gray-600 hover:bg-gray-500 text-white block font-medium" %>
    <%= link_to "New Mushroom Character", new_admin_mr_character_path, class: "rounded-md px-2 py-1 bg-blue-600 hover:bg-blue-500 text-white block font-medium" %>
  </div>

  <%# TOP pagination %>
  <% if @mr_characters.any? %>
    <div class="my-1">
      <%= paginate @mr_characters,
                   theme: 'tailwind_bar',
                   params: request.query_parameters,
                   window: 2,        # how many pages around current
                   outer_window: 1   # how many pages at the ends
      %>
    </div>
  <% end %>

  <div id="mr_characters" class="min-w-full divide-y divide-gray-100 space-y-5">
    <% if @mr_characters.any? %>
      <% @mr_characters.each do |mr_character| %>
        <div class="flex flex-col sm:flex-row justify-between items-center pb-2 sm:pb-0">
          <%= render mr_character %>
          <% unless mr_character.name.to_s == "id" %>
          <div class="w-full sm:w-auto flex flex-col sm:flex-row space-x-2 space-y-1">
            <!-- Below css keeps the button height the same for both show and edit -->
            <!-- Tailwind-styled Show button -->
            <%= link_to "Show", admin_mr_character_path(mr_character),  class: "w-full sm:w-auto inline-flex items-center justify-center h-10 px-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-500 rounded-md whitespace-nowrap" %>
            <!-- Tailwind-styled Edit button -->
            <%= link_to "Edit", edit_admin_mr_character_path(mr_character), class: "w-full sm:w-auto inline-flex items-center justify-center h-10 px-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-500 rounded-md whitespace-nowrap" %>
            <!-- Tailwind-styled Delete button -->
<%#
            <%# button_to "Delete this character", admin_mr_character_path(mr_character), method: :delete, class: "w-full sm:w-auto inline-flex items-center text-center rounded-md px-2.5 py-1.5 text-white bg-red-600 hover:bg-red-500 font-medium cursor-pointer", data: { turbo_confirm: "Are you sure?" } %>
          </div>
<% end %>

        </div>
      <% end %>

      <div class="mt-3">
        <!-- Pagination links (BOTTOM) -->
        <% if @mr_characters.any? %>
          <div class="my-1">
            <%= paginate @mr_characters,
                         theme: 'tailwind_bar',
                         params: request.query_parameters,
                         window: 2,        # how many pages around current
                         outer_window: 1   # how many pages at the ends
            %>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-center my-10 text-2xl text-red-600">No mushroom characters found.</p>
    <% end %>
  </div>
</div>