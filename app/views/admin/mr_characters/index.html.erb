<% content_for :title, "Mushroom Characters" %>

<style>
    /* More spacing between pagination items and bigger click targets */
    .pagination { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; }
    .pagination a, .pagination span {
        padding: 0.375rem 0.625rem; /* ~py-1.5 px-2.5 */
        border-radius: 0.375rem;    /* ~rounded-md */
    }
</style>

<div class="w-full">
  <% if notice.present? %>
    <p class="py-1 px-3 bg-green-50 mb-5 text-green-500 font-medium rounded-md inline-block" id="notice"><%= notice %></p>
  <% end %>

  <div class="p-mrdbid">
    <p class="text-sm text-red-600 border-l-4 border-red-600 p-2">
      The character's form still needs some work, but it is important they be seen by expert users so that you can fix any mistakes and add more information.
    </p>
    <p class="p-mrdbid">Only Admin users view this page. Be sure you understand what you are doing.</p>

    <p class="p-mrdbid">If you do not find the <strong>necessary</strong> character you are looking for using the search tool below, you can create it here. Use "New Mushroom Character" button below the search area. If the value can be communicated in one text field, choose the right display option and you are done. For a single value form field, you should select one of the text box or boolean display options.</p>

    <p class="p-mrdbid">If the new character needs a list to choose from, you can create it one value at a time in the lookup_items table using the link on the admin dashboard. Choose radio or drop-down for most. Choose color if you have a color value and want the color chart.</p>

    <p class="p-mrdbid">Please provide a source for your information. If your source has not already been entered into Source Data, you should add it before you create the character.</p>

    <p class="p-mrdbid">If you are unsure, or you have much data to enter, send an email and assistance will be provided.</p>

    <p class="p-mrdbid">I understand there are risks to allowing strangers to modify the database, but we need to get things done, so I won't be a control freak about this, unless I am proven wrong about fungi people.</p>

    <p class="p-mrdbid">I won't be the hall monitor, but you should at least be aware of these two documents, I would hope: <a class="text-blue-600 underline" href="https://mushroomobserver.org/species_lists/1417?q">Simple & Advanced Characters With Taxonomic Value For Stipitate-Lamellate Mushroom</a> and <a href="https://www.inaturalist.org/journal/nolo_mode" class="text-blue-500 hover:underline">A True Intro To The Identification Of Fungi</a>. These are Mushroom Observer articles and you have to register and log in to read them.</p>

    <p class="p-mrdbid">The "Gills" mushrooms appear to have a head start in regard to characters, but all others have the tools here to catch up.</p>


  </div>

  <!-- Filter card -->
  <div class="group-box mb-6">
    <div class="group-header">
      Filter Mushroom Characters
      <p class="hint mt-1">Browse characters by Part, Observation Method, and/or Fungus Type. Does not affect search below.</p>
    </div>
    <div class="px-4 py-4">
      <%= form_with url: admin_mr_characters_path, method: :get, local: true, class: "grid grid-cols-1 gap-4 lg:grid-cols-3 lg:gap-6" do |form| %>
        <div class="form-field">
          <%= form.label :part_id, "Part", class: "form-label" %>
          <%= form.select :part_id,
                          @parts,
                          { include_blank: "All" },
                          class: "form-input",
                          style: "width: 70%; padding: 0.5rem; box-shadow: 0 0 0 1px rgba(0,0,0,0.06), 0 0 10px 2px rgba(0,0,0,0.12), 0 0 24px 6px rgba(0,0,0,0.12);" %>
          <p class="form-help">Select a part first to filter lookup types.</p>
        </div>

        <div class="form-field">
          <%= form.label :observation_method_id, "Observation Method", class: "form-label" %>
          <%= form.select :observation_method_id,
                          [['Universal', 'universal']] + @observation_methods,
                          { include_blank: "All" },
                          class: "form-input",
                          style: "width: 85%; padding: 0.5rem; box-shadow: 0 0 0 1px rgba(0,0,0,0.06), 0 0 10px 2px rgba(0,0,0,0.12), 0 0 24px 6px rgba(0,0,0,0.12);" %>
          <p class="form-help">Filtered by part selection above.</p>
        </div>

        <div class="form-field">
          <%= form.label :fungus_type_id, "Fungus Type", class: "form-label" %>
          <%= form.select :fungus_type_id,
                          [['Universal (All Types)', 'universal']] + @fungus_types,
                          { include_blank: "All" },
                          class: "form-input",
                          style: "width: 85%; padding: 0.5rem; box-shadow: 0 0 0 1px rgba(0,0,0,0.06), 0 0 10px 2px rgba(0,0,0,0.12), 0 0 24px 6px rgba(0,0,0,0.12);" %>
          <p class="form-help">Filter characters by fungus type or universal.</p>
        </div>

        <div class="lg:col-span-3 flex gap-2">
          <%= form.submit "Apply Filter", class: "btn-primary" %>
          <%= link_to "Reset", admin_mr_characters_path, class: "btn" %>
        </div>
      <% end %>
    </div>

    <!-- Current filter summary -->
    <%# Safely compute human-friendly names for summary %>
    <% selected_observation_method = params[:observation_method_id].presence && ObservationMethod.find_by(id: params[:observation_method_id]) %>
    <% part_name_by_id = (@parts || []).each_with_object({}) { |(name, id), h| h[id.to_s] = name } %>
    <% selected_part_name = params[:part_id].presence && part_name_by_id[params[:part_id].to_s] %>

    <div class="well">
      <% if params[:part_id].present? || params[:observation_method_id].present? || params[:fungus_type_id].present? %>
        <div class="flex flex-wrap items-center gap-2 text-sm">
          <span class="text-gray-700 font-medium">Currently showing:</span>
          <span class="inline-flex items-center gap-1 rounded-full bg-green-50 text-green-700 px-2.5 py-1">
            <span class="font-medium">Part:</span>
            <span><%= selected_part_name || "All" %></span>
          </span>
          <span class="inline-flex items-center gap-1 rounded-full bg-blue-50 text-blue-700 px-2.5 py-1">
            <span class="font-medium">Observation Method:</span>
            <span><%= params[:observation_method_id] == 'universal' ? 'Universal' : (selected_observation_method&.name || "All") %></span>
          </span>
          <span class="inline-flex items-center gap-1 rounded-full bg-purple-50 text-purple-700 px-2.5 py-1">
            <span class="font-medium">Fungus Type:</span>
            <span><%= params[:fungus_type_id] == 'universal' ? 'Universal' : (FungusType.find_by(id: params[:fungus_type_id])&.name || "All") %></span>
          </span>
          <%= link_to "Change", "#", class: "ml-auto text-blue-700 hover:underline", onclick: "document.querySelector('form[action=\"#{admin_mr_characters_path}\"]').scrollIntoView({behavior:'smooth'})" %>
        </div>
      <% else %>
        <p class="muted">No filters applied. Showing all characters.</p>
      <% end %>
    </div>
  </div>
  <!-- End Filter card -->

  <!-- Search card -->
  <div class="group-box mb-6" style="border: 2px solid #9333ea;">
    <div class="group-header" style="background-color: #f3e8ff;">
      Search for a Specific Character
      <p class="hint mt-1"><strong>Search ignores all filters above.</strong> Enter a character name (partial match) or ID number to find it directly.</p>
    </div>
    <div class="px-4 py-1">
      <%= form_with url: admin_mr_characters_path, method: :get, local: true, class: "grid grid-cols-1 gap-2 sm:grid-cols-3 items-end" do %>
        <div class="form-field sm:col-span-2">
          <label for="q" class="form-label">Name or ID</label>
          <%= text_field_tag :q, params[:q], placeholder: "e.g. 'Cap surface' or 3",
                             class: "form-input",
                             style: "padding: 0.5rem; box-shadow: 0 0 0 1px rgba(0,0,0,0.06), 0 0 10px 2px rgba(0,0,0,0.12), 0 0 24px 6px rgba(0,0,0,0.12);" %>
          <p class="form-help">Searches all characters regardless of filters. Partial name matches OK. Enter number for exact ID match.</p>
        </div>
        <div class="flex gap-2">
          <%= submit_tag "Search", class: "btn-primary" %>
          <%= link_to "Clear Search", admin_mr_characters_path, class: "btn" %>
        </div>
      <% end %>
    </div>

    <!-- Current search summary -->
    <div class="well">
      <% if params[:q].present? %>
        <div class="flex flex-wrap items-center gap-2 text-sm">
          <span class="text-gray-700 font-medium">Search:</span>
          <span class="inline-flex items-center gap-1 rounded-full bg-purple-50 text-purple-700 px-2.5 py-1">
            <span class="font-medium">Query:</span>
            <span><%= params[:q] %></span>
          </span>
          <%= link_to "Clear", admin_mr_characters_path(request.query_parameters.except(:q)), class: "ml-auto text-blue-700 hover:underline" %>
        </div>
      <% else %>
        <p class="muted">No search applied.</p>
      <% end %>
    </div>
  </div>
  <!-- End Search card -->


  <div class="flex justify-between items-center">
    <h1 class="font-bold text-2xl">Mushroom Characters</h1>
    <%= link_to "Back to Admin Dashboard", admin_root_path, class: "rounded-md px-2 py-1 bg-gray-600 hover:bg-gray-500 text-white block font-medium" %>
    <%= link_to "New Mushroom Character", new_admin_mr_character_path, class: "rounded-md px-2 py-1 bg-blue-600 hover:bg-blue-500 text-white block font-medium" %>
  </div>

  <%# TOP pagination %>
  <% if @mr_characters.any? %>
    <div class="my-1 flex flex-wrap items-center gap-4">
      <%= paginate @mr_characters,
                   theme: 'tailwind_bar',
                   params: request.query_parameters,
                   window: 2,        # how many pages around current
                   outer_window: 1   # how many pages at the ends
      %>
      <div class="flex items-center gap-2">
        <%= form_with url: admin_mr_characters_path, method: :get, local: true, class: "flex items-center gap-2" do |form| %>
          <%= label_tag :page, "Go to page:", class: "text-sm font-medium text-gray-700" %>
          <%= number_field_tag :page, params[:page], min: 1, max: @mr_characters.total_pages, class: "form-input w-20 px-2 py-1 border border-gray-300 rounded-md" %>
          <%= hidden_field_tag :q, params[:q] if params[:q].present? %>
          <%= hidden_field_tag :part_id, params[:part_id] if params[:part_id].present? %>
          <%= hidden_field_tag :observation_method_id, params[:observation_method_id] if params[:observation_method_id].present? %>
          <%= hidden_field_tag :fungus_type_id, params[:fungus_type_id] if params[:fungus_type_id].present? %>
          <%= form.submit "Go", class: "btn-primary px-3 py-1" %>
        <% end %>
        <span class="text-sm text-gray-600">of <%= @mr_characters.total_pages %></span>
      </div>
    </div>
  <% end %>

  <div id="mr_characters" class="min-w-full divide-y divide-gray-100 space-y-5">
    <% if @mr_characters.any? %>
      <% @mr_characters.each do |mr_character| %>
        <div class="flex flex-col sm:flex-row justify-between items-center pb-2 sm:pb-0">
          <%= render mr_character %>
          <% unless mr_character.name.to_s == "id" %>
          <div class="w-full sm:w-auto flex flex-col sm:flex-row space-x-2 space-y-1">
            <!-- Below css keeps the button height the same for both show and edit -->
            <!-- Tailwind-styled Show button -->
            <%= link_to "Show", admin_mr_character_path(mr_character),  class: "w-full sm:w-auto inline-flex items-center justify-center h-10 px-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-500 rounded-md whitespace-nowrap" %>
            <!-- Tailwind-styled Edit button -->
            <%= link_to "Edit", edit_admin_mr_character_path(mr_character, page: params[:page]), class: "w-full sm:w-auto inline-flex items-center justify-center h-10 px-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-500 rounded-md whitespace-nowrap" %>
            <!-- Tailwind-styled Delete button -->
<%#
            <%# button_to "Delete this character", admin_mr_character_path(mr_character), method: :delete, class: "w-full sm:w-auto inline-flex items-center text-center rounded-md px-2.5 py-1.5 text-white bg-red-600 hover:bg-red-500 font-medium cursor-pointer", data: { turbo_confirm: "Are you sure?" } %>
          </div>
<% end %>

        </div>
      <% end %>

      <div class="mt-3">
        <!-- Pagination links (BOTTOM) -->
        <% if @mr_characters.any? %>
          <div class="my-1 flex flex-wrap items-center gap-4">
            <%= paginate @mr_characters,
                         theme: 'tailwind_bar',
                         params: request.query_parameters,
                         window: 2,        # how many pages around current
                         outer_window: 1   # how many pages at the ends
            %>
            <div class="flex items-center gap-2">
              <%= form_with url: admin_mr_characters_path, method: :get, local: true, class: "flex items-center gap-2" do |form| %>
                <%= label_tag :page, "Go to page:", class: "text-sm font-medium text-gray-700" %>
                <%= number_field_tag :page, params[:page], min: 1, max: @mr_characters.total_pages, class: "form-input w-20 px-2 py-1 border border-gray-300 rounded-md" %>
                <%= hidden_field_tag :q, params[:q] if params[:q].present? %>
                <%= hidden_field_tag :part_id, params[:part_id] if params[:part_id].present? %>
                <%= hidden_field_tag :observation_method_id, params[:observation_method_id] if params[:observation_method_id].present? %>
                <%= hidden_field_tag :fungus_type_id, params[:fungus_type_id] if params[:fungus_type_id].present? %>
                <%= form.submit "Go", class: "btn-primary px-3 py-1" %>
              <% end %>
              <span class="text-sm text-gray-600">of <%= @mr_characters.total_pages %></span>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-center my-10 text-2xl text-red-600">No mushroom characters found.</p>
    <% end %>
  </div>
</div>