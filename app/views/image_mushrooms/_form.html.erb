<%= form_with(model: [mushroom, image_mushroom], local: true) do |form| %>
  <% if image_mushroom.errors.any? %>
    <div class="text-red-500">
      <h2>Errors:</h2>
      <ul>
        <% image_mushroom.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%# Always submit the parent as a hidden field; no selector %>
  <%= form.hidden_field :mushroom_id, value: image_mushroom.mushroom_id %>

  <% if image_mushroom.persisted? %>
    <!-- EDIT MODE: Show current image as preview -->
    <% if image_mushroom.image_file.attached? %>
      <div class="my-5">
        <label class="block font-medium text-gray-700 mb-2">Current Image</label>
        <div class="border rounded-md p-4 bg-gray-50 inline-block">
          <%= image_tag image_mushroom.image_file.variant(resize_to_limit: [300, 300]),
                        class: "max-w-xs rounded shadow",
                        alt: image_mushroom.image_name.presence || "Current image" %>
          <% if image_mushroom.image_name.present? %>
            <p class="text-sm text-gray-600 mt-2"><strong>Name:</strong> <%= image_mushroom.image_name %></p>
          <% end %>
        </div>
      </div>
    <% end %>
  <% else %>
    <!-- NEW MODE: Show file upload field -->
    <div class="my-5">
      <%= form.label :image_file, "Select an Image File", class: "block font-medium text-gray-700 mb-2" %>
      <%= form.file_field :image_file,
                          accept: "image/*",
                          class: ["block shadow-sm rounded-md border px-2 py-1 mt-2 w-full",
                                  {"border-gray-400 focus:outline-blue-600": image_mushroom.errors[:image_file].none?,
                                   "border-red-400 focus:outline-red-600": image_mushroom.errors[:image_file].any?}] %>
      <p class="text-xs text-gray-600 mt-1">Upload a photo of your mushroom (JPEG, PNG, HEIC, etc.)</p>
    </div>

    <div class="my-5">
      <%= form.label :image_name, "Image Name", class: "block font-medium text-gray-700 mb-2" %>
      <%= form.text_field :image_name,
                          placeholder: "e.g., 'Cap close-up' or 'Side view'",
                          class: ["block shadow-sm rounded-md border px-2 py-1 mt-2 w-full",
                                  {"border-gray-400 focus:outline-blue-600": image_mushroom.errors[:image_name].none?,
                                   "border-red-400 focus:outline-red-600": image_mushroom.errors[:image_name].any?}] %>
      <p class="text-xs text-gray-600 mt-1">Give this image a descriptive name</p>
    </div>
  <% end %>

  <div class="my-5">
    <%= form.label :part_id, image_mushroom.persisted? ? "Mushroom Part (editable)" : "Mushroom Part", class: "block font-medium text-gray-700 mb-2" %>
    <%= form.collection_select :part_id, parts, :id, :name, { prompt: 'Select Part' }, class: ["block shadow-sm rounded-md border px-2 py-1 mt-2 w-full", {"border-gray-400 focus:outline-blue-600": image_mushroom.errors[:part_id].none?, "border-red-400 focus:outline-red-600": image_mushroom.errors[:part_id].any?}] %>
    <p class="text-xs text-gray-600 mt-1">Select which part of the mushroom this image shows (cap, stem, gills, etc.)</p>
  </div>

  <div class="my-5">
    <%= form.label :comments, image_mushroom.persisted? ? "Comments (editable)" : "Comments (optional)", class: "block font-medium text-gray-700 mb-2" %>
    <%= form.text_area :comments,
                       rows: 4,
                       placeholder: "Add any notes or observations about this image...",
                       class: ["block shadow-sm rounded-md border px-2 py-1 mt-2 w-full",
                               {"border-gray-400 focus:outline-blue-600": image_mushroom.errors[:comments].none?,
                                "border-red-400 focus:outline-red-600": image_mushroom.errors[:comments].any?}] %>
    <p class="text-xs text-gray-600 mt-1">Add notes, observations, or any details about this image</p>
  </div>

  <% if image_mushroom.persisted? %>
    <!-- Camera Equipment (Optional) - Only shown in EDIT mode -->
    <details class="my-5 border border-gray-300 rounded-lg p-4 bg-gray-50">
      <summary class="cursor-pointer font-semibold text-gray-700 mb-3">ðŸ“· Camera Equipment (Optional)</summary>
      <p class="text-xs text-gray-600 mb-4">Override or correct the auto-matched camera equipment from EXIF data.</p>

      <div class="space-y-4">
        <!-- Camera Make -->
        <div>
          <%= form.label :camera_make_id, "Camera Make", class: "block font-medium text-gray-700 mb-2 text-sm" %>
          <%= form.collection_select :camera_make_id,
                                      CameraMake.order(:name),
                                      :id,
                                      :name,
                                      { prompt: 'Select Camera Make', include_blank: true },
                                      class: "block shadow-sm rounded-md border border-gray-400 px-2 py-1 w-full focus:outline-blue-600" %>
        </div>

        <!-- Camera Model -->
        <div>
          <%= form.label :camera_model_id, "Camera Model", class: "block font-medium text-gray-700 mb-2 text-sm" %>
          <%= form.collection_select :camera_model_id,
                                      CameraModel.order(:name),
                                      :id,
                                      :name,
                                      { prompt: 'Select Camera Model', include_blank: true },
                                      class: "block shadow-sm rounded-md border border-gray-400 px-2 py-1 w-full focus:outline-blue-600" %>
        </div>

        <!-- Lens -->
        <div>
          <%= form.label :lens_id, "Lens", class: "block font-medium text-gray-700 mb-2 text-sm" %>
          <%= form.collection_select :lens_id,
                                      Lens.order(:make, :model),
                                      :id,
                                      ->(lens) { "#{lens.make} #{lens.model}" },
                                      { prompt: 'Select Lens', include_blank: true },
                                      class: "block shadow-sm rounded-md border border-gray-400 px-2 py-1 w-full focus:outline-blue-600" %>
          <p class="text-xs text-gray-500 mt-1">Format: Make Model (e.g., "Canon RF 24-70mm f/2.8L IS USM")</p>
        </div>
      </div>
    </details>
  <% end %>

  <div class="my-5">
    <%= form.submit image_mushroom.persisted? ? "Update" : "Upload Image", class: 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-medium' %>
  </div>
<% end %>