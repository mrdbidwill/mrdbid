<%= form_with(model: [mushroom, image_mushroom], local: true) do |form| %>
  <% if image_mushroom.errors.any? %>
    <div class="text-red-500">
      <h2>Errors:</h2>
      <ul>
        <% image_mushroom.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%# Always submit the parent as a hidden field; no selector %>
  <%= form.hidden_field :mushroom_id, value: image_mushroom.mushroom_id %>

  <% if image_mushroom.persisted? %>
    <!-- EDIT MODE: Show current image as preview -->
    <% if image_mushroom.image_file.attached? %>
      <div class="my-5">
        <label class="block font-medium text-gray-700 mb-2">Current Image</label>
        <div class="border rounded-md p-4 bg-gray-50 inline-block">
          <%= image_tag image_mushroom.image_file.variant(resize_to_limit: [300, 300]),
                        class: "max-w-xs rounded shadow",
                        alt: image_mushroom.image_name.presence || "Current image" %>
          <% if image_mushroom.image_name.present? %>
            <p class="text-sm text-gray-600 mt-2"><strong>Name:</strong> <%= image_mushroom.image_name %></p>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- EDIT MODE: Allow editing image_name -->
    <div class="my-5">
      <%= form.label :image_name, "Image Name (editable)", class: "block font-medium text-gray-700 mb-2" %>
      <%= form.text_field :image_name,
                          placeholder: "e.g., 'Cap close-up' or 'Side view'",
                          class: ["block shadow-sm rounded-md border px-2 py-1 mt-2 w-full",
                                  {"border-gray-400 focus:outline-blue-600": image_mushroom.errors[:image_name].none?,
                                   "border-red-400 focus:outline-red-600": image_mushroom.errors[:image_name].any?}] %>
      <p class="text-xs text-gray-600 mt-1">Give this image a descriptive name</p>
    </div>
  <% else %>
    <!-- NEW MODE: Show file upload field with camera capture -->
    <div class="my-5">
      <%= form.label :image_file, "Select an Image File", class: "block font-medium text-gray-700 mb-2" %>
      <%= form.file_field :image_file,
                          accept: "image/*",
                          capture: "environment",
                          class: ["block shadow-sm rounded-md border px-2 py-1 mt-2 w-full",
                                  {"border-gray-400 focus:outline-blue-600": image_mushroom.errors[:image_file].none?,
                                   "border-red-400 focus:outline-red-600": image_mushroom.errors[:image_file].any?}] %>
      <p class="text-xs text-gray-600 mt-1">
        ðŸ“· <strong>Mobile tip:</strong> On mobile devices, this will open your camera directly for field photography.
        Upload a photo of your mushroom (JPEG, PNG, HEIC, etc.)
      </p>
    </div>

    <div class="my-5">
      <%= form.label :image_name, "Image Name", class: "block font-medium text-gray-700 mb-2" %>
      <%= form.text_field :image_name,
                          placeholder: "e.g., 'Cap close-up' or 'Side view'",
                          class: ["block shadow-sm rounded-md border px-2 py-1 mt-2 w-full",
                                  {"border-gray-400 focus:outline-blue-600": image_mushroom.errors[:image_name].none?,
                                   "border-red-400 focus:outline-red-600": image_mushroom.errors[:image_name].any?}] %>
      <p class="text-xs text-gray-600 mt-1">Give this image a descriptive name</p>
    </div>
  <% end %>

  <div class="my-5">
    <%= form.label :part_id, image_mushroom.persisted? ? "Mushroom Part (editable)" : "Mushroom Part", class: "block font-medium text-gray-700 mb-2" %>
    <%= form.collection_select :part_id, parts, :id, :name, { prompt: 'Select Part' }, class: ["block shadow-sm rounded-md border px-2 py-1 mt-2 w-full", {"border-gray-400 focus:outline-blue-600": image_mushroom.errors[:part_id].none?, "border-red-400 focus:outline-red-600": image_mushroom.errors[:part_id].any?}] %>
    <p class="text-xs text-gray-600 mt-1">Select which part of the mushroom this image shows (cap, stem, gills, etc.)</p>
  </div>

  <div class="my-5">
    <%= form.label :comments, image_mushroom.persisted? ? "Comments (editable)" : "Comments (optional)", class: "block font-medium text-gray-700 mb-2" %>
    <%= form.text_area :comments,
                       rows: 4,
                       placeholder: "Add any notes or observations about this image...",
                       class: ["block shadow-sm rounded-md border px-2 py-1 mt-2 w-full",
                               {"border-gray-400 focus:outline-blue-600": image_mushroom.errors[:comments].none?,
                                "border-red-400 focus:outline-red-600": image_mushroom.errors[:comments].any?}] %>
    <p class="text-xs text-gray-600 mt-1">Add notes, observations, or any details about this image</p>
  </div>

  <div class="my-5 flex flex-wrap gap-3">
    <%= form.submit image_mushroom.persisted? ? "Update Image" : "Upload Image", class: 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-medium' %>

    <% if image_mushroom.persisted? %>
      <%= link_to "Cancel",
                  edit_mushroom_path(mushroom),
                  class: "bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded font-medium inline-block" %>
    <% end %>
  </div>
<% end %>

<% if image_mushroom.persisted? %>
  <div class="my-5">
    <%= button_to "Delete This Image",
                  image_mushroom_path(image_mushroom),
                  method: :delete,
                  data: { turbo_confirm: "Are you sure you want to delete this image? This cannot be undone." },
                  class: "bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-medium" %>
  </div>
<% end %>