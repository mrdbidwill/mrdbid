<div class="container mx-auto px-4 py-8">
  <div class="mb-8">
    <h1 class="text-4xl font-bold mb-4">iNaturalist Observation Fields</h1>

    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
      <h2 class="text-xl font-semibold mb-2">About This Dataset</h2>
      <p class="mb-4">
        This is a searchable database of all <%= number_with_delimiter(@total_count) %> observation fields available on iNaturalist.
        These fields are particularly useful for mushroom and fungi identification to maintain consistency and avoid duplication.
      </p>
      <p class="text-sm text-gray-600">
        Last updated: February 13, 2026 |
        Source: <a href="https://www.inaturalist.org/pages/api+reference#get-observation_fields" class="text-blue-600 hover:underline" target="_blank">iNaturalist API</a>
      </p>
    </div>

    <!-- Search Form -->
    <div class="mb-6">
      <%= form_with url: inaturalist_observation_fields_path, method: :get, class: "flex gap-2" do |f| %>
        <%= f.text_field :q,
            value: @query,
            placeholder: "Search by name, description, or allowed values...",
            class: "flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" %>
        <%= f.submit "Search", class: "bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition cursor-pointer" %>
        <% if @query.present? %>
          <%= link_to "Clear", inaturalist_observation_fields_path, class: "bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg transition" %>
        <% end %>
      <% end %>
      <% if @query.present? %>
        <p class="text-sm text-gray-600 mt-2">
          Found <%= number_with_delimiter(@observation_fields.total_count) %> results for "<%= @query %>"
        </p>
      <% end %>
    </div>

    <div class="flex gap-4 mb-6">
      <%= link_to "ðŸ“¥ Download CSV", download_inaturalist_csv_path,
          class: "bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg transition" %>
      <%= link_to "ðŸ“¥ Download JSON", download_inaturalist_json_path,
          class: "bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition" %>
    </div>
  </div>

  <!-- Results Table -->
  <div class="bg-white shadow-lg rounded-lg overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">ID</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Name</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Type</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Description</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Allowed Values</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Usage</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% @observation_fields.each do |field| %>
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                <%= field.inaturalist_id %>
              </td>
              <td class="px-6 py-4 text-sm font-semibold text-gray-900">
                <%= field.name %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                <span class="px-2 py-1 bg-gray-100 rounded text-xs"><%= field.datatype %></span>
              </td>
              <td class="px-6 py-4 text-sm text-gray-700 max-w-md">
                <%= field.description.present? ? truncate(field.description, length: 150) : 'â€”' %>
              </td>
              <td class="px-6 py-4 text-sm text-gray-600 max-w-xs">
                <% if field.allowed_values.present? %>
                  <div class="flex flex-wrap gap-1">
                    <% field.allowed_values.split('|').first(5).each do |value| %>
                      <span class="px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs"><%= value %></span>
                    <% end %>
                    <% if field.allowed_values.split('|').length > 5 %>
                      <span class="px-2 py-0.5 bg-gray-100 text-gray-600 rounded text-xs">+<%= field.allowed_values.split('|').length - 5 %> more</span>
                    <% end %>
                  </div>
                <% else %>
                  <span class="text-gray-400">â€”</span>
                <% end %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                <%= field.users_count || 0 %> users
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Pagination -->
  <div class="mt-6">
    <%= paginate @observation_fields, theme: 'tailwind_bar' %>
  </div>

  <!-- Tips -->
  <div class="mt-8 bg-yellow-50 border border-yellow-200 rounded-lg p-6">
    <h3 class="text-lg font-semibold mb-2">ðŸ’¡ Search Tips</h3>
    <div class="text-sm text-gray-700 space-y-2">
      <p><strong>For Mushroom/Mycology Fields, try searching:</strong></p>
      <ul class="list-disc list-inside ml-4 space-y-1">
        <li>mushroom, fungi, fungus, fungal, mycology</li>
        <li>spore, mycelium, hypha, basidiomycete, ascomycete</li>
        <li>cap, pileus, gill, lamella, stipe, stem, volva, annulus</li>
        <li>pore, tube, conk, bracket, polypore</li>
        <li>bolete, chanterelle, morel, truffle, puffball</li>
      </ul>
    </div>
  </div>
</div>

