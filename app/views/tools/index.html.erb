<div class="container mx-auto px-4 py-8">
  <h1 class="text-4xl font-bold mb-8">üõ†Ô∏è Tools & Utilities</h1>

  <p class="text-lg text-gray-700 mb-8">
    Access various tools and utilities to manage your mushroom database, export data, and organize your specimens.
  </p>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <!-- Export Tools -->
    <div class="bg-white shadow-lg rounded-lg p-6 border-t-4 border-indigo-600">
      <div class="flex items-center mb-4">
        <span class="text-4xl mr-3">üìÑ</span>
        <h2 class="text-2xl font-semibold text-gray-900">Export All to PDF</h2>
      </div>
      <p class="text-gray-600 mb-4">
        Generate a comprehensive PDF document containing all of your mushroom specimens with images and details.
      </p>
      <%= link_to export_all_pdf_mushrooms_path(format: :pdf),
          class: "inline-block bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-lg transition w-full text-center",
          id: "export-all-pdf-link",
          data: {
            turbo_confirm: "This will export all of your mushrooms to PDF. Large exports may take some time. Continue?",
            turbo: false
          } do %>
        Export to PDF
      <% end %>
    </div>

    <!-- Image Backup -->
    <div class="bg-white shadow-lg rounded-lg p-6 border-t-4 border-purple-600">
      <div class="flex items-center mb-4">
        <span class="text-4xl mr-3">üíæ</span>
        <h2 class="text-2xl font-semibold text-gray-900">Backup My Images</h2>
      </div>
      <p class="text-gray-600 mb-4">
        Download all your mushroom images and metadata as a ZIP file for safe keeping and offline access.
      </p>
      <%= link_to "Create Backup",
          new_users_image_export_path,
          class: "inline-block bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-6 rounded-lg transition w-full text-center" %>
    </div>

    <!-- Organization Tools -->
    <div class="bg-white shadow-lg rounded-lg p-6 border-t-4 border-gray-600">
      <div class="flex items-center mb-4">
        <span class="text-4xl mr-3">üìÅ</span>
        <h2 class="text-2xl font-semibold text-gray-900">Organize Specimens</h2>
      </div>
      <p class="text-gray-600 mb-4">
        Create and manage clusters, groups, and projects to organize your mushroom specimens.
      </p>
      <div class="space-y-2">
        <%= link_to "Clusters",
            clusters_path,
            class: "block bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition text-center" %>
        <%= link_to "Groups",
            all_groups_path,
            class: "block bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition text-center" %>
        <%= link_to current_user&.admin? ? "Projects (Universal) üåç" : "Projects",
            current_user&.admin? ? admin_projects_path : projects_path,
            class: "block bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition text-center" %>
      </div>
    </div>

    <!-- iNaturalist Data -->
    <div class="bg-white shadow-lg rounded-lg p-6 border-t-4 border-green-600">
      <div class="flex items-center mb-4">
        <span class="text-4xl mr-3">üîç</span>
        <h2 class="text-2xl font-semibold text-gray-900">iNaturalist Observation Fields</h2>
      </div>
      <p class="text-gray-600 mb-4">
        Search and browse <%= number_with_delimiter(InaturalistObservationField.count) %> iNaturalist observation fields for consistent data entry.
      </p>
      <%= link_to "Browse Fields",
          inaturalist_observation_fields_path,
          class: "inline-block bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg transition w-full text-center" %>
    </div>
  </div>

  <!-- Additional Information -->
  <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
    <h3 class="text-lg font-semibold mb-2">‚ÑπÔ∏è About These Tools</h3>
    <ul class="space-y-2 text-sm text-gray-700">
      <li><strong>Export to PDF:</strong> Creates a detailed document with all mushroom data. Large collections may take 1-2 minutes.</li>
      <li><strong>Image Backup:</strong> Downloads a ZIP file with all images and metadata. You retain full ownership of your images.</li>
      <li><strong>Organization:</strong> Use Clusters for field trips, Groups for related specimens, and Projects for research collections.</li>
      <li><strong>iNaturalist Fields:</strong> Reference database to help maintain data consistency when submitting observations.</li>
    </ul>
  </div>
</div>

<!-- CRITICAL: PDF Export Loading Feedback - DO NOT REMOVE OR SIMPLIFY -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const exportPdfLink = document.getElementById('export-all-pdf-link');
    if (exportPdfLink) {
      exportPdfLink.addEventListener('click', function(e) {
        e.preventDefault();

        const confirmMessage = this.dataset.turboConfirm;
        if (confirmMessage && !confirm(confirmMessage)) {
          return;
        }

        const originalButtonContent = this.innerHTML;
        const exportUrl = this.href;

        // Change button text
        this.innerHTML = '‚è≥ Exporting...';
        this.classList.add('opacity-75', 'cursor-not-allowed');
        this.style.pointerEvents = 'none';

        // Show loading overlay
        const loadingOverlay = document.createElement('div');
        loadingOverlay.id = 'pdf-loading-overlay';
        loadingOverlay.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
        loadingOverlay.innerHTML = `
          <div class="bg-white rounded-lg p-8 max-w-md mx-4 text-center">
            <div class="mb-4">
              <svg class="animate-spin h-16 w-16 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Generating PDF...</h3>
            <p class="text-gray-600 mb-4">Please wait while we export your mushrooms to PDF.</p>
            <p class="text-sm text-gray-500">Do not close this window or navigate away.</p>
          </div>
        `;
        document.body.appendChild(loadingOverlay);

        // Create hidden iframe for download
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.onload = function() {
          setTimeout(function() {
            if (loadingOverlay.parentNode) loadingOverlay.remove();
            exportPdfLink.innerHTML = originalButtonContent;
            exportPdfLink.classList.remove('opacity-75', 'cursor-not-allowed');
            exportPdfLink.style.pointerEvents = '';
            setTimeout(() => { if (iframe.parentNode) document.body.removeChild(iframe); }, 2000);
          }, 2000);
        };

        setTimeout(function() {
          if (loadingOverlay.parentNode) loadingOverlay.remove();
          if (iframe.parentNode) document.body.removeChild(iframe);
        }, 60000);

        document.body.appendChild(iframe);
        iframe.src = exportUrl;
      });
    }
  });

  // Re-initialize on Turbo navigation
  document.addEventListener('turbo:load', function() {
    // Same code as above...
  });
</script>
